# 🚀 运单查询工具（带代理池）

## 📦 功能特性

✅ **代理池管理**
- 自动轮换代理
- 失败自动切换
- 代理健康检查
- 统计分析

✅ **智能重试**
- 指数退避算法
- 自动重试失败请求
- 代理失败自动切换

✅ **限流控制**
- 可配置请求间隔
- 避免触发 API 限流

✅ **数据导出**
- CSV 格式（Excel 可直接打开）
- JSON 格式
- 包含完整订单信息

## 📋 文件说明

```
├── query_with_proxy.py  # 主程序（带代理池）
├── proxy_pool.py        # 代理池管理器
├── proxies.txt          # 代理列表配置
├── key.txt              # 运单号列表
├── rate_limiter.py      # 限流工具（可选）
└── 使用说明.md          # 本文件
```

## 🔧 安装依赖

```bash
pip install -r requirements.txt
```

## 📝 使用步骤

### 1. 配置代理（已完成）

`proxies.txt` 已经包含了你提供的 50 个代理服务器。

格式说明：
```
IP:端口:用户名:密码
```

### 2. 添加运单号

编辑 `key.txt` 文件，每行一个运单号：

```
ABC123456789
DEF987654321
GHI111222333
```

### 3. 运行程序

```bash
python query_with_proxy.py
```

### 4. 查看结果

程序会生成两个文件：
- `result_YYYYMMDD_HHMMSS.csv` - Excel 可直接打开
- `result_YYYYMMDD_HHMMSS.json` - JSON 格式

## ⚙️ 配置选项

### 修改请求间隔

编辑 `query_with_proxy.py` 第 135 行：

```python
delay_between_requests = 0.5  # 改为你想要的秒数
```

### 启用代理健康检查

运行程序时选择 `y`：
```
是否进行代理健康检查？(y/N): y
```

### 修改最大重试次数

编辑 `query_with_proxy.py` 第 24 行：

```python
def query_order(code, proxy_pool=None, max_retries=3):  # 改为你想要的次数
```

## 📊 输出示例

```
================================================================================
🚀 批量查询运单号（带代理池 + 限流控制）
================================================================================

📡 初始化代理池...
✅ 加载了 50 个代理

📋 读取到 100 个运单号
⏱️  请求间隔: 0.5 秒

================================================================================
开始查询...
================================================================================

[1/100] ABC123456789 (代理 23.27.184.245)... ✅ 0987654321
[2/100] DEF987654321 (代理 45.43.70.140)... ✅ 0123456789
[3/100] GHI111222333 (代理 82.24.233.117)... ❌ 订单不存在

...

================================================================================
📊 查询统计
================================================================================
总查询数: 100
成功: 95
失败: 5
耗时: 52.3 秒
平均速度: 1.91 条/秒

代理池统计:
  总代理数: 50
  可用代理: 48
  失败代理: 2
  总成功次数: 95
  总失败次数: 5
  成功率: 95.0%

🏆 表现最好的 5 个代理:
  1. 23.27.184.245 - 成功: 12, 失败: 0, 成功率: 100.0%
  2. 45.43.70.140 - 成功: 11, 失败: 0, 成功率: 100.0%
  ...

✅ 完成！结果已保存:
   📄 result_20251013_143052.csv
   📄 result_20251013_143052.json
```

## 🔍 代理池工作原理

1. **轮询模式**：按顺序使用每个代理
2. **自动切换**：代理失败时自动切换到下一个
3. **失败标记**：失败 3 次的代理会被暂时禁用
4. **自动恢复**：禁用的代理成功后会重新启用
5. **统计分析**：实时统计每个代理的成功/失败率

## 🛠️ 高级用法

### 仅测试代理池

```bash
python proxy_pool.py
```

### 不使用代理

删除或重命名 `proxies.txt` 文件，程序会自动直连。

### 自定义代理选择策略

修改 `proxy_pool.py` 中的 `get_next_proxy()` 或 `get_random_proxy()` 方法。

## ⚠️ 注意事项

1. **代理有效性**：建议定期检查代理是否可用
2. **请求频率**：根据 API 限制调整 `delay_between_requests`
3. **超时设置**：默认 10 秒，可根据网络情况调整
4. **重试次数**：默认 3 次，可根据需要调整
5. **代理质量**：如果发现某些代理经常失败，可以从列表中删除

## 🐛 常见问题

### Q: 所有代理都失败了怎么办？
A: 程序会自动重置失败列表，继续尝试所有代理。建议检查代理配置是否正确。

### Q: 如何提高查询速度？
A: 减小 `delay_between_requests` 值，但要注意不要触发 API 限流。

### Q: 代理认证失败？
A: 检查 `proxies.txt` 中的用户名和密码是否正确。

### Q: 某些运单查询失败？
A: 可能是运单号不存在或格式错误，检查 `key.txt` 中的运单号。

## 📞 技术支持

如有问题，请检查：
1. 代理配置格式是否正确
2. 网络连接是否正常
3. API 密钥是否有效
4. 运单号格式是否正确
