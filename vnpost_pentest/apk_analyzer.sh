#!/bin/bash
# 越南邮政App自动化渗透测试脚本

APK_FILE="$1"
OUTPUT_DIR="./analysis_output"

echo "[*] 越南邮政App自动化渗透测试工具"
echo "[*] 目标APK: $APK_FILE"

# 创建输出目录
mkdir -p "$OUTPUT_DIR"/{decompiled,strings,manifest,libs,reports}

# 1. 基础信息提取
echo "[+] 步骤1: 提取APK基础信息"
aapt dump badging "$APK_FILE" 2>/dev/null > "$OUTPUT_DIR/apk_info.txt" || echo "需要安装aapt"

# 2. 反编译APK
echo "[+] 步骤2: 使用APKTool反编译"
apktool d "$APK_FILE" -o "$OUTPUT_DIR/decompiled" -f 2>/dev/null || echo "需要安装apktool"

# 3. Manifest分析
echo "[+] 步骤3: 分析AndroidManifest.xml"
if [ -f "$OUTPUT_DIR/decompiled/AndroidManifest.xml" ]; then
    cat "$OUTPUT_DIR/decompiled/AndroidManifest.xml" > "$OUTPUT_DIR/manifest/AndroidManifest.xml"
    
    # 检查危险权限
    echo "[!] 危险权限检测:"
    grep -i "permission" "$OUTPUT_DIR/manifest/AndroidManifest.xml" | grep -E "(CAMERA|LOCATION|CONTACTS|SMS|STORAGE|PHONE)" | tee "$OUTPUT_DIR/reports/dangerous_permissions.txt"
    
    # 检查导出组件
    echo "[!] 导出组件检测:"
    grep -i "exported=\"true\"" "$OUTPUT_DIR/manifest/AndroidManifest.xml" | tee "$OUTPUT_DIR/reports/exported_components.txt"
fi

# 4. 字符串提取（敏感信息）
echo "[+] 步骤4: 提取字符串和敏感信息"
unzip -q "$APK_FILE" -d "$OUTPUT_DIR/extracted"
find "$OUTPUT_DIR/extracted" -name "*.dex" -exec strings {} \; > "$OUTPUT_DIR/strings/all_strings.txt"

echo "[!] 敏感关键词搜索:"
grep -iE "(api[_-]?key|secret|password|token|aws|s3|bucket|database|mysql|mongodb|redis)" "$OUTPUT_DIR/strings/all_strings.txt" | head -30 | tee "$OUTPUT_DIR/reports/sensitive_strings.txt"

echo "[!] URL端点提取:"
grep -oE "https?://[a-zA-Z0-9./?=_-]+" "$OUTPUT_DIR/strings/all_strings.txt" | sort -u | tee "$OUTPUT_DIR/reports/urls.txt"

# 5. Native库分析
echo "[+] 步骤5: 分析Native库"
find "$OUTPUT_DIR/extracted" -name "*.so" > "$OUTPUT_DIR/libs/native_libs.txt"
cat "$OUTPUT_DIR/libs/native_libs.txt"

# 6. 证书信息
echo "[+] 步骤6: 提取签名证书"
unzip -p "$APK_FILE" META-INF/*.RSA 2>/dev/null | keytool -printcert 2>/dev/null | tee "$OUTPUT_DIR/reports/certificate.txt"

# 7. 生成报告
echo "[+] 步骤7: 生成渗透测试报告"
cat > "$OUTPUT_DIR/reports/penetration_test_report.md" << REPORT
# 越南邮政App渗透测试报告

## 1. 基础信息
- APK文件: $(basename $APK_FILE)
- 分析时间: $(date)
- 分析工具: APKTool, strings, aapt

## 2. 权限分析
\`\`\`
$(cat $OUTPUT_DIR/reports/dangerous_permissions.txt 2>/dev/null || echo "无危险权限")
\`\`\`

## 3. 导出组件
\`\`\`
$(cat $OUTPUT_DIR/reports/exported_components.txt 2>/dev/null || echo "无导出组件")
\`\`\`

## 4. 敏感信息泄露
\`\`\`
$(head -20 $OUTPUT_DIR/reports/sensitive_strings.txt 2>/dev/null || echo "未发现明显敏感信息")
\`\`\`

## 5. API端点
\`\`\`
$(head -20 $OUTPUT_DIR/reports/urls.txt 2>/dev/null || echo "未提取到URL")
\`\`\`

## 6. Native库
\`\`\`
$(cat $OUTPUT_DIR/libs/native_libs.txt 2>/dev/null || echo "无Native库")
\`\`\`

## 7. 下一步测试建议
- [ ] 动态调试 (Frida Hook)
- [ ] SSL Pinning绕过
- [ ] API接口测试
- [ ] 业务逻辑漏洞挖掘
- [ ] Native层逆向分析

REPORT

echo ""
echo "[✓] 分析完成！报告保存在: $OUTPUT_DIR/reports/penetration_test_report.md"
echo "[✓] 详细输出: $OUTPUT_DIR/"
