/**
 * è¶Šå—é‚®æ”¿Appä¸“ç”¨Frida Hookè„šæœ¬
 * ç›®æ ‡: ç›‘æ§æ•æ„Ÿæ“ä½œã€ç»•è¿‡å®‰å…¨æ£€æµ‹ã€æ‹¦æˆªAPIé€šä¿¡
 * ä½¿ç”¨: frida -U -f vn.vnpost.app -l vnpost_frida_hooks.js --no-pause
 */

console.log("[*] è¶Šå—é‚®æ”¿Appæ¸—é€æµ‹è¯•Hookè„šæœ¬");
console.log("[*] ç›®æ ‡: ç›‘æ§ç™»å½•/æ”¯ä»˜/å¯„ä»¶ç­‰å…³é”®ä¸šåŠ¡");

Java.perform(function() {
    
    // ========== 1. é€šç”¨Hook ==========
    
    // SSL Pinningç»•è¿‡
    try {
        var CertificatePinner = Java.use("okhttp3.CertificatePinner");
        CertificatePinner.check.overload('java.lang.String', 'java.util.List').implementation = function(str, list) {
            console.log("[+] SSL Pinning bypassed for: " + str);
            return;
        };
    } catch(e) {}

    // Rootæ£€æµ‹ç»•è¿‡
    try {
        var RootBeer = Java.use("com.scottyab.rootbeer.RootBeer");
        RootBeer.isRooted.implementation = function() {
            console.log("[+] Root check bypassed");
            return false;
        };
    } catch(e) {}

    // ========== 2. ç™»å½•ç›¸å…³Hook ==========
    
    // ç›‘æ§ç”¨æˆ·åå¯†ç è¾“å…¥
    try {
        var EditText = Java.use("android.widget.EditText");
        EditText.getText.implementation = function() {
            var text = this.getText();
            var hint = this.getHint();
            if (hint && (hint.toString().toLowerCase().indexOf("password") !== -1 || 
                        hint.toString().toLowerCase().indexOf("username") !== -1 ||
                        hint.toString().toLowerCase().indexOf("phone") !== -1)) {
                console.log("[ğŸ”‘] æ•æ„Ÿè¾“å…¥æ¡†: " + hint + " = " + text);
            }
            return text;
        };
    } catch(e) {}

    // Hookç™»å½•è¯·æ±‚
    var loginPatterns = ["login", "signin", "auth", "authenticate", "dang-nhap"];
    loginPatterns.forEach(function(pattern) {
        try {
            Java.enumerateLoadedClasses({
                onMatch: function(className) {
                    if (className.toLowerCase().indexOf(pattern) !== -1) {
                        console.log("[ğŸ“±] å‘ç°ç™»å½•ç›¸å…³ç±»: " + className);
                        
                        var LoginClass = Java.use(className);
                        var methods = LoginClass.class.getDeclaredMethods();
                        methods.forEach(function(method) {
                            console.log("    - Method: " + method.getName());
                        });
                    }
                },
                onComplete: function() {}
            });
        } catch(e) {}
    });

    // ========== 3. ç½‘ç»œè¯·æ±‚Hook ==========
    
    // Hook OkHttpè¯·æ±‚
    try {
        var OkHttpClient = Java.use("okhttp3.OkHttpClient");
        var Request = Java.use("okhttp3.Request");
        var RequestBody = Java.use("okhttp3.RequestBody");
        
        var Call = Java.use("okhttp3.Call");
        var RealCall = Java.use("okhttp3.internal.connection.RealCall");
        
        RealCall.execute.implementation = function() {
            var request = this.request();
            var url = request.url().toString();
            var method = request.method();
            
            console.log("\n[ğŸŒ] HTTPè¯·æ±‚æ‹¦æˆª:");
            console.log("    URL: " + url);
            console.log("    Method: " + method);
            
            // æ‰“å°è¯·æ±‚å¤´
            var headers = request.headers();
            console.log("    Headers:");
            for (var i = 0; i < headers.size(); i++) {
                console.log("      " + headers.name(i) + ": " + headers.value(i));
            }
            
            // æ‰“å°è¯·æ±‚ä½“
            var body = request.body();
            if (body !== null) {
                console.log("    Body: [å­˜åœ¨è¯·æ±‚ä½“]");
            }
            
            // åˆ†ææ•æ„Ÿç«¯ç‚¹
            if (url.indexOf("login") !== -1) {
                console.log("    [ğŸ”¥] ç™»å½•æ¥å£ï¼");
            } else if (url.indexOf("payment") !== -1 || url.indexOf("pay") !== -1) {
                console.log("    [ğŸ’°] æ”¯ä»˜æ¥å£ï¼");
            } else if (url.indexOf("order") !== -1 || url.indexOf("ship") !== -1) {
                console.log("    [ğŸ“¦] è®¢å•/å¯„ä»¶æ¥å£ï¼");
            }
            
            var response = this.execute();
            
            // æ‰“å°å“åº”
            try {
                var responseBody = response.body().string();
                console.log("    Response: " + responseBody.substring(0, 200));
                
                // é‡å»ºå“åº”ï¼ˆå› ä¸ºbodyåªèƒ½è¯»ä¸€æ¬¡ï¼‰
                var ResponseBody = Java.use("okhttp3.ResponseBody");
                var MediaType = Java.use("okhttp3.MediaType");
                var newBody = ResponseBody.create(
                    MediaType.parse("application/json"),
                    responseBody
                );
                var newResponse = response.newBuilder().body(newBody).build();
                return newResponse;
            } catch(e) {}
            
            return response;
        };
        console.log("[âœ“] OkHttpè¯·æ±‚å·²Hook");
    } catch(e) {
        console.log("[-] OkHttp Hookå¤±è´¥: " + e);
    }

    // ========== 4. SharedPreferencesç›‘æ§ ==========
    
    try {
        var SharedPreferences = Java.use("android.app.SharedPreferencesImpl");
        SharedPreferences.getString.overload('java.lang.String', 'java.lang.String').implementation = function(key, defValue) {
            var value = this.getString(key, defValue);
            if (key.toLowerCase().indexOf("token") !== -1 || 
                key.toLowerCase().indexOf("session") !== -1 ||
                key.toLowerCase().indexOf("user") !== -1) {
                console.log("[ğŸ’¾] SharedPreferencesè¯»å–: " + key + " = " + value);
            }
            return value;
        };
        
        SharedPreferences.edit.implementation = function() {
            console.log("[ğŸ’¾] SharedPreferencesæ­£åœ¨ç¼–è¾‘");
            return this.edit();
        };
    } catch(e) {}

    // ========== 5. åŠ å¯†ç®—æ³•Hook ==========
    
    // AESåŠ å¯†ç›‘æ§
    try {
        var Cipher = Java.use("javax.crypto.Cipher");
        Cipher.doFinal.overload('[B').implementation = function(input) {
            var algorithm = this.getAlgorithm();
            console.log("[ğŸ”] åŠ å¯†æ“ä½œ: " + algorithm);
            console.log("    è¾“å…¥é•¿åº¦: " + input.length + " bytes");
            
            var result = this.doFinal(input);
            console.log("    è¾“å‡ºé•¿åº¦: " + result.length + " bytes");
            
            return result;
        };
    } catch(e) {}

    // ========== 6. æ”¯ä»˜ç›¸å…³Hook ==========
    
    // ç›‘æ§é‡‘é¢å­—æ®µ
    var amountKeywords = ["price", "amount", "money", "total", "fee", "cost", "gia", "tien"];
    try {
        var JSONObject = Java.use("org.json.JSONObject");
        
        JSONObject.put.overload('java.lang.String', 'java.lang.Object').implementation = function(key, value) {
            if (amountKeywords.some(k => key.toLowerCase().indexOf(k) !== -1)) {
                console.log("[ğŸ’°] é‡‘é¢å­—æ®µ: " + key + " = " + value);
            }
            return this.put(key, value);
        };
    } catch(e) {}

    // ========== 7. å®šä½ä¿¡æ¯Hook ==========
    
    try {
        var LocationManager = Java.use("android.location.LocationManager");
        LocationManager.getLastKnownLocation.implementation = function(provider) {
            var location = this.getLastKnownLocation(provider);
            if (location !== null) {
                console.log("[ğŸ“] è·å–ä½ç½®: " + location.getLatitude() + ", " + location.getLongitude());
            }
            return location;
        };
    } catch(e) {}

    console.log("\n[âœ“] Hookè„šæœ¬åŠ è½½å®Œæˆï¼Œå¼€å§‹ç›‘æ§...\n");
});
