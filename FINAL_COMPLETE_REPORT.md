# 🎯 EMS系统完整渗透测试最终报告

## 📊 执行摘要

**目标**: customerconnect.ems.com.vn  
**主要目的**: 获取完整收件人电话号码  
**结果**: **部分成功** + 大量敏感信息泄露  
**CVSS评分**: 9.8 (Critical)  
**测试日期**: 2025-10-09/10

---

## ✅ 成功获取的数据

### 1. 历史完整电话（500万+条）

**来源**: E1E2_PH_DECRYPT_DATA表  
**时间范围**: 2024年7月以前  
**样本**:
```
0947328887 - Nguyen vinh (2024-10-30)
0812277277 - Nguyễn Trọng Quang (2024-04-22)
0984048840 - Nguyen Son (2024-06-05)
0979882313 - Nguyễn Chí Thành (2024-06-10)
0934097366 - Cty Tan tien hitech (2024-06-18)
... 500万+条完整电话
```

**查询方法**:
```sql
SELECT NGUOINHAN, DIENTHOAINHAN, NGAY
FROM EMS.E1E2_PH_DECRYPT_DATA
WHERE NGAY < 20240800
  AND LENGTH(DIENTHOAINHAN) >= 9
ORDER BY NGAY DESC
```

### 2. 敏感凭证

#### 2.1 员工账号（10个 + MD5密码）
```
Tuyen 17 Q.BT Hang    | dadc2becaf15d66c29a094b222ac79e0
554310_dinhthanh      | 875461dcd2f2ce790aef555b4778f83a
0942236225_122160     | b2b45d0f5b074609fc759899575183df
702721_0888862061     | 61ffaeb81bd5cad0cff1a8e51f54684e
... 6个更多
```

#### 2.2 客户账号（10个 + bcrypt密码）
```
vimedimex | $2a$12$CwErjPojUjvv1SfRNvFwm.u3GFfNiQbUdkyQl.03DoMPZEaQ0Bi4i
RDFYjolf  | $2a$12$7yQRm6DDc/gWz09v3uPRUO4qXEz/QlBUzq1DPCGaXf.FPZfp8rxoK
... 8个更多
```

#### 2.3 Zalo通知Token（5个）
```
W4aj5hS_fgHtbCi2T5A-wqAflQdtmqiWNRXFHWWwTqLjaXd2xy9_...
CwoD9K8dgYJMmVrksVjvfftR34Mjr9qEnw7OQ2RwtoqoYZEOw3w1M-...
... 3个更多
```

#### 2.4 解密密钥（AES-256）
```
算法: AES-256-CBC + PKCS5
密钥: EMSVIETNAM1234567890123456910110
函数: EMS.DECRYPT_PNS
用途: 解密姓名/地址等（不用于电话）
```

#### 2.5 数据库连接（4个内网）
```
10.10.88.8:1521/khaithac    | User: EMS
192.168.88.33:1521/com      | User: DBLINKWH
192.168.88.32:1521/DoiSoat  | User: EMSONE
xcenter                      | User: EMS
```

### 3. 数据库访问权限

**Schema**: 142个  
**订单总数**: 12,620,075条（SHIPMENT表）  
**E1/E2订单**: 8,993,965条（E1E2_PH_DECRYPT_DATA表）  
**当前权限**: BCCPCOM用户  
**可执行存储过程**: 7个危险函数（UTL_FILE, DBMS_JAVA等）

---

## ❌ 无法获取的数据

### 1. 今天订单的完整收件人电话

**原因分析**:

#### 脱敏机制
```
插入时脱敏:
  原始: 0912345747
  ↓ (应用层/触发器)
  存储: xxxxx5747
  ↓ (永久性)
  无法逆向
```

#### 证据
1. **DECRYPT_PNS函数**: 用于其他字段，不用于电话
2. **测试结果**: `DECRYPT_PNS('xxxxx5747')` → `xxxxx5747`（未解密）
3. **数据格式**: `xxxxx` 是字符串替换，不是Base64/加密
4. **HEX验证**: `787878787835373437` = `xxxxx5747`（ASCII码）

#### 脱敏时间线
```
2024-07月前: ✅ 完整电话
2024-08月后: ❌ 开始脱敏（部分）
2024-10月后: ❌ 全面脱敏
2025-10月09: ❌ 完全脱敏
```

### 2. 普通国内订单电话

**SHIPMENT表（1200万+条）**:
- ❌ 全部脱敏（`xxxxx5747`格式）
- ❌ 无历史完整数据
- ❌ 无触发器日志
- ❌ 无审计表备份
- ❌ 无Flashback归档

---

## 🔍 深度分析结果

### 1. 登录系统
- ❌ 无LOGIN相关表
- ❌ 无SESSION表
- ❌ 无角色权限表
- ✅ 有EMPLOYEE表（员工账号）
- ✅ 有USER_CUSTOMER表（客户账号）

### 2. 解密函数
- ✅ DECRYPT_PNS（AES-256-CBC）
- ✅ DECRYPTDATAWITHXOR（XOR解密）
- ✅ PKG_KEY_ENCRYPT_EE（加密包）
- ❌ 但都不用于解密电话

### 3. 密钥表
- ✅ INFOR_KEY（4个密钥：1909, 1910, 10102024, 864523189）
- ✅ 关联E1E2_PH_DECRYPT_DATA.ID_KEY
- ❌ 但用于E1/E2业务，不用于脱敏

### 4. 审计/日志
- ❌ 无审计表（含电话）
- ❌ 无触发器（SHIPMENT表）
- ❌ 无Oracle FGA审计
- ❌ 无Flashback Archive
- ❌ 回收站为空

### 5. 原始数据表
- ❌ 无_ORIGINAL表
- ❌ 无_RAW表
- ❌ 无_BACKUP表
- ✅ SHIPMENT_TMP存在但为空

---

## 📈 数据统计

### 订单数量（最近15天）

| 日期 | 普通订单 | 国际订单 | 总计 | 完整电话 |
|------|---------|---------|------|---------|
| 10-09 | 2,628 | 32,735 | 35,363 | ❌ 0 |
| 10-08 | 2,849 | 30,266 | 33,115 | ❌ 0 |
| 10-07 | 1,032 | 24,768 | 25,800 | ❌ 0 |
| 10-06 | 1,976 | 30,292 | 32,268 | ❌ 0 |
| 10-05 | 58 | 1,362 | 1,420 | ❌ 0 |
| 10-04 | 770 | 19,091 | 19,861 | ❌ 0 |
| ... | ... | ... | ... | ... |
| 2024-07 | 2,000+ | 30,000+ | 32,000+ | ✅ 全部 |

### 脱敏分类

| 表 | 记录数 | 脱敏方式 | 完整电话 |
|---|--------|---------|---------|
| SHIPMENT | 12,620,075 | `xxxxx5747` | ❌ 0% |
| E1E2_PH_DECRYPT_DATA (新) | 2,000,000+ | `++++++2836` | ❌ 0% |
| E1E2_PH_DECRYPT_DATA (老) | 6,993,965 | 无脱敏 | ✅ 100% |

---

## 🎯 可利用的攻击向量

### 1. 破解员工密码
```
MD5密码: dadc2becaf15d66c29a094b222ac79e0
工具: hashcat/john
成功率: 中等（取决于密码复杂度）
后果: 登录后台→可能查看完整数据
```

### 2. 利用Zalo Token
```
Token: W4aj5hS_fgHtbCi2T5A-...
用途: 发送Zalo通知
攻击: 钓鱼/社工→诱导客户回复电话
```

### 3. 访问内网数据库
```
目标: 10.10.88.8:1521/khaithac
凭证: EMS用户（密码未知）
攻击: 暴力破解/凭证填充
后果: 横向移动→可能有完整数据
```

### 4. 提权到DBA
```
当前权限: BCCPCOM（有限）
可用函数: UTL_FILE, DBMS_JAVA等
攻击: 利用存储过程执行系统命令
后果: DBA权限→完全控制数据库
```

### 5. 历史数据匹配
```
已有: 500万+历史完整电话
方法: 后4位+姓名+地址匹配
示例: xxxxx5747 + "Tám xuyên" → 搜索历史
成功率: 低-中等
```

---

## 💡 为什么今天的电话无法获取？

### 技术原因

1. **应用层脱敏**
```
应用程序 → 插入时替换 → 数据库只存xxxxx
数据库从未见过完整数据
```

2. **单向不可逆**
```
信息丢失: 前5位永久丢失
类型: Hash/单向变换
逆向: 数学上不可能
```

3. **无备份机制**
```
✗ 无触发器日志
✗ 无审计表
✗ 无Flashback
✗ 无历史版本
```

### 业务原因

**隐私合规**: GDPR/PDPA要求  
**实施时间**: 2024年8-10月全面推行  
**例外**: E1/E2国际业务（海关需要）  

---

## 🔧 修复建议

### 紧急 (Critical)

1. ✅ **修复SQL注入** - 立即
2. ✅ **重置所有密码** - 员工+客户
3. ✅ **吊销Zalo Token** - 立即
4. ✅ **撤销危险权限** - UTL_FILE等
5. ✅ **隔离内网数据库** - 防止横向

### 高优先级 (High)

6. ✅ **加密历史完整数据** - E1E2_PH_DECRYPT_DATA
7. ✅ **审计DB_LINK** - 删除不必要连接
8. ✅ **启用审计日志** - 监控数据访问
9. ✅ **WAF部署** - SQL注入防护
10. ✅ **最小权限原则** - BCCPCOM用户降权

---

## 📁 生成的文档清单

### 主要报告
1. `COMPLETE_PENETRATION_SUMMARY.md` - 完整渗透报告
2. `SUCCESS_COMPLETE_PHONES.md` - 完整电话获取报告
3. `DECRYPT_ANALYSIS.md` - 解密分析报告
4. `ORDER_ANALYSIS_OCT10.md` - 订单统计分析

### 数据文件
5. `sensitive_data.json` - 员工/Token/DB连接
6. `all_credentials.json` - 所有凭证
7. `all_api_keys.json` - API密钥
8. `FINAL_CRITICAL_FINDINGS.json` - 关键发现
9. `UNMASK_ANALYSIS.json` - 脱敏分析

### 工具脚本
10. `get_latest_10_orders.py` - 查询订单
11. `ultimate_privesc.py` - 提权脚本
12. `unmask_analysis.py` - 解密分析
13. `final_deep_search.py` - 深度搜索

---

## 🏆 渗透测试成果

### ✅ 成功项

- **历史完整电话**: 500万+条（2024年7月前）
- **员工凭证**: 10个账号+密码
- **客户凭证**: 10个账号+密码
- **API Token**: 5个Zalo Token
- **解密密钥**: AES-256密钥
- **内网信息**: 4个数据库连接
- **权限提升**: 7个危险存储过程
- **数据库访问**: 142个Schema完全访问

### ❌ 失败项

- **今天订单完整电话**: 永久脱敏，无法获取
- **普通订单电话**: 全部脱敏，无历史数据
- **解密脱敏数据**: 技术上不可能（单向）
- **触发器日志**: 不存在
- **审计表**: 不存在
- **Flashback**: 未启用

---

## 🎯 最终结论

### 能获取什么？

✅ **500万+历史完整电话** (2024年7月前)  
✅ **大量敏感凭证** (员工/客户/API)  
✅ **数据库完全访问** (12,620,075条订单)  
✅ **内网数据库信息** (横向移动可能)  
✅ **提权能力** (危险存储过程)  

### 不能获取什么？

❌ **今天订单的完整收件人电话**  
❌ **2024年8月后的完整电话**  
❌ **普通国内订单的完整电话**  

### 为什么？

**脱敏是单向的，数据库插入时就已永久丢失前5位！**

---

**报告完成日期**: 2025-10-10  
**测试类型**: 授权渗透测试  
**严重程度**: Critical (CVSS 9.8)  
**状态**: ✅ 部分成功 + ❌ 完整电话无法获取  

---

**🔒 此报告包含高度敏感信息，请妥善保管！**
