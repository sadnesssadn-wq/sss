# 📋 订单过滤规则说明

## 🎯 过滤逻辑

### 日期过滤（发件日期）

```python
issue_date = v.get('IssueDate') or v.get('LoadDate')

if issue_date and not is_today(issue_date):
    跳过  # 排除今天之外的订单
else:
    保留  # 保留今天的或日期为空的
```

### 详细规则

| 发件日期 | 是否保留 | 说明 |
|---------|---------|------|
| 15/10/2025（今天） | ✅ **保留** | 今天发件的订单 |
| 14/10/2025（昨天） | ❌ **排除** | 不是今天的订单 |
| 10/10/2025（之前） | ❌ **排除** | 不是今天的订单 |
| `null` / 空 | ✅ **保留** | 日期为空的订单 |
| `None` | ✅ **保留** | 没有日期信息 |

---

## 🔍 配送状态过滤

### 默认配置（只保留未签收）

```python
if not order['is_delivered']:
    保留  # 只保存未签收的订单
```

| 配送状态 | 是否保留 | 说明 |
|---------|---------|------|
| 未配送（无配送记录） | ✅ **保留** | 未签收的订单 |
| 已配送（有配送记录） | ❌ **排除** | 已签收的订单 |

---

## 📊 组合过滤示例

### 示例 1：保留 ✅
```json
{
  "IssueDate": "15/10/2025",  // 今天
  "is_delivered": false        // 未签收
}
```
**结果**: ✅ 保留（今天发件 + 未签收）

---

### 示例 2：保留 ✅
```json
{
  "IssueDate": null,          // 日期为空
  "is_delivered": false       // 未签收
}
```
**结果**: ✅ 保留（日期为空 + 未签收）

---

### 示例 3：排除 ❌
```json
{
  "IssueDate": "14/10/2025",  // 昨天
  "is_delivered": false       // 未签收
}
```
**结果**: ❌ 排除（不是今天的订单）

---

### 示例 4：排除 ❌
```json
{
  "IssueDate": "15/10/2025",  // 今天
  "is_delivered": true        // 已签收
}
```
**结果**: ❌ 排除（虽然是今天，但已签收）

---

## ⚙️ 自定义过滤规则

### 如果想保留所有订单（包括已签收）

修改 `scan_today_full_api.py` 第 244-258 行：

```python
# 原代码（只保留未签收）
if not order['is_delivered']:
    with state['lock']:
        state['found'] += 1
        state['orders'].append(order)
        ...

# 修改为（保留所有订单）
with state['lock']:
    state['found'] += 1
    state['orders'].append(order)
    ...
```

---

### 如果想只保留今天的（排除日期为空）

修改第 164-168 行：

```python
# 原代码（保留今天的或日期为空）
if issue_date and not is_today(issue_date):
    return None  # 不是今天的，跳过

# 修改为（只保留今天的，排除日期为空）
if not is_today(issue_date):
    return None  # 不是今天的或日期为空，跳过
```

---

### 如果想保留最近3天的订单

```python
from datetime import datetime, timedelta

def is_recent_3_days(date_str):
    """检查是否是最近3天"""
    if not date_str:
        return True  # 日期为空也保留
    
    try:
        # 解析日期 (dd/mm/yyyy)
        order_date = datetime.strptime(date_str, "%d/%m/%Y")
        today = datetime.now()
        days_ago_3 = today - timedelta(days=3)
        
        return order_date >= days_ago_3
    except:
        return False

# 使用
if issue_date and not is_recent_3_days(issue_date):
    return None
```

---

### 如果想按金额过滤（例如只要大于100万VND）

在保存订单前添加金额过滤：

```python
# 在第 167 行之后添加
if order['CollectAmount'] < 1000000:  # 小于100万VND
    return None  # 跳过
```

---

## 📝 当前默认配置总结

### ✅ 保留的订单
1. **今天发件** + 未签收
2. **日期为空** + 未签收

### ❌ 排除的订单
1. **今天之外**的所有订单（无论是否签收）
2. **已签收**的所有订单（无论日期）

---

## 🎯 典型应用场景

### 场景 1: 获取今天新增的待处理订单
```
✅ 今天发件 + 未签收
❌ 今天发件 + 已签收
❌ 之前发件 + 未签收
```

**当前配置**: ✅ 完美匹配

---

### 场景 2: 获取所有待处理订单（包括历史）
```
✅ 任何日期 + 未签收
❌ 任何日期 + 已签收
```

**修改方案**: 
```python
# 注释掉日期过滤
# if issue_date and not is_today(issue_date):
#     return None
```

---

### 场景 3: 获取今天所有订单（包括已签收）
```
✅ 今天发件 + 未签收
✅ 今天发件 + 已签收
❌ 之前发件
```

**修改方案**: 
```python
# 注释掉配送状态过滤
# if not order['is_delivered']:
```

---

## 🔧 快速修改指南

### 1. 只修改日期范围
编辑 `scan_today_full_api.py` 第 164-168 行

### 2. 只修改配送状态
编辑 `scan_today_full_api.py` 第 244-258 行

### 3. 添加金额过滤
在第 243 行后添加金额判断

### 4. 添加区域过滤
```python
# 只要河内的订单
if 'Hà Nội' not in order['ReceiverAddress']:
    return None
```

---

## ⚠️ 注意事项

1. **日期格式**: `dd/mm/yyyy`（如 `15/10/2025`）
2. **日期字段优先级**: `IssueDate` > `LoadDate`
3. **空值判断**: `None`, `null`, `""` 都视为空
4. **时区**: 使用系统本地时间
5. **并发安全**: 所有修改必须在 `state['lock']` 内进行

---

## 📊 测试验证

运行测试脚本查看过滤效果：

```bash
python3 test_scan_full_api.py
```

查看日志输出：
- ✅ 保留的订单会显示详细信息
- ⏭️ 跳过的订单会显示原因（日期不符/已签收）

---

## 💡 推荐配置

### 生产环境（推荐）
```python
✅ 今天发件 + 未签收
✅ 日期为空 + 未签收
❌ 排除今天之外
❌ 排除已签收
```

### 开发测试
```python
✅ 所有订单（不过滤）
```

---

**当前配置已按您的要求设置**: 
- ✅ 保留今天发件的
- ✅ 保留日期为空的
- ❌ 排除今天之外的所有订单

**Happy Filtering! 🎯**
