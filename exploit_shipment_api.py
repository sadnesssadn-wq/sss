#!/usr/bin/env python3
"""
åˆ©ç”¨APIè¶Šæƒæ¼æ´éå†è·å–è¿å•ä¿¡æ¯
é€šè¿‡IDéå†/shipment/detailæ¥å£
"""

import requests
import json
import time
from concurrent.futures import ThreadPoolExecutor

# Tokenï¼ˆæœ‰æ•ˆæœŸåˆ°2025ï¼‰
TOKEN = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYwMzQwMjM3LCJqdGkiOiJkNzI5YmRhNmYzZTY0NjZmOTcwZGUxMDE0YzljNGM1MiIsInVzZXJfaWQiOjI1MDIxfQ.OQA_JVS-GhKcWyBf2KAZV567-0XAtJ8G8uoN6DXWPzc'

BASE_URL = 'https://apilogistics.ems.com.vn:8080/api'

def get_shipment_detail(shipment_id):
    """è·å–è¿å•è¯¦æƒ…"""
    url = f'{BASE_URL}/shipment/detail'
    headers = {
        'Authorization': f'Bearer {TOKEN}',
        'Content-Type': 'application/json'
    }
    params = {'id': shipment_id}
    
    try:
        r = requests.get(url, params=params, headers=headers, timeout=10, verify=False)
        if r.status_code == 200:
            result = r.json()
            if result.get('status') == 200:
                return result.get('data')
    except:
        pass
    return None

print("=" * 80)
print("ğŸ”“ è¶Šæƒæ¼æ´åˆ©ç”¨ - éå†è¿å•ä¿¡æ¯")
print("=" * 80)

# 1. å…ˆæµ‹è¯•èŒƒå›´
print("\nğŸ“Š æµ‹è¯•IDèŒƒå›´...\n")

test_ids = [1, 10, 100, 1000, 5000, 10000, 50000, 100000]
valid_ids = []

for test_id in test_ids:
    data = get_shipment_detail(test_id)
    if data:
        print(f"  ID {test_id}: âœ… æœ‰æ•°æ®")
        valid_ids.append(test_id)
    else:
        print(f"  ID {test_id}: âŒ")
    time.sleep(0.3)

if not valid_ids:
    print("\nâŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆIDèŒƒå›´")
    exit(1)

print(f"\nâœ… æœ‰æ•ˆIDèŒƒå›´: {min(valid_ids)} - {max(valid_ids)}")

# 2. é€‰æ‹©éå†èŒƒå›´
print("\n" + "="*80)
print("è¯·é€‰æ‹©éå†æ–¹å¼:")
print("  1. å¿«é€Ÿæµ‹è¯•ï¼ˆéå†1-1000ï¼‰")
print("  2. ä¸­ç­‰è§„æ¨¡ï¼ˆéå†1-10000ï¼‰")
print("  3. å¤§è§„æ¨¡ï¼ˆéå†1-100000ï¼‰")
print("  4. è‡ªå®šä¹‰èŒƒå›´")
print("="*80)

choice = input("\nè¯·é€‰æ‹© (1/2/3/4): ").strip()

if choice == '1':
    start_id, end_id = 1, 1000
elif choice == '2':
    start_id, end_id = 1, 10000
elif choice == '3':
    start_id, end_id = 1, 100000
elif choice == '4':
    start_id = int(input("èµ·å§‹ID: "))
    end_id = int(input("ç»“æŸID: "))
else:
    start_id, end_id = 1, 1000

print(f"\nâœ… éå†ID: {start_id} - {end_id} ({end_id-start_id+1} ä¸ª)")

# 3. å¤šçº¿ç¨‹éå†
print("\nğŸš€ å¼€å§‹éå†...\n")

results = []
success_count = 0
fail_count = 0

output_file = f'shipments_{start_id}_{end_id}.json'

def fetch_and_save(shipment_id):
    global success_count, fail_count
    data = get_shipment_detail(shipment_id)
    if data:
        success_count += 1
        return data
    else:
        fail_count += 1
        return None

start_time = time.time()

with ThreadPoolExecutor(max_workers=10) as executor:
    futures = {executor.submit(fetch_and_save, i): i for i in range(start_id, end_id + 1)}
    
    completed = 0
    for future in futures:
        result = future.result()
        if result:
            results.append(result)
        
        completed += 1
        if completed % 100 == 0:
            elapsed = time.time() - start_time
            speed = completed / elapsed * 60
            remaining = (end_id - start_id + 1 - completed) / speed * 60
            print(f"  {completed}/{end_id-start_id+1} ({completed*100//(end_id-start_id+1)}%) | "
                  f"æˆåŠŸ: {success_count} | "
                  f"é€Ÿåº¦: {speed:.0f}/åˆ†é’Ÿ | å‰©ä½™: {remaining:.1f}åˆ†é’Ÿ")

# 4. ä¿å­˜ç»“æœ
with open(output_file, 'w', encoding='utf-8') as f:
    json.dump(results, f, indent=2, ensure_ascii=False)

elapsed = time.time() - start_time

print(f"\n{'='*80}")
print(f"âœ… å®Œæˆï¼")
print(f"{'='*80}")
print(f"ğŸ“ æ–‡ä»¶: {output_file}")
print(f"âœ… æˆåŠŸ: {success_count} ä¸ª")
print(f"âŒ å¤±è´¥: {fail_count} ä¸ª")
print(f"â±ï¸  ç”¨æ—¶: {elapsed/60:.1f} åˆ†é’Ÿ")
print(f"{'='*80}")

# 5. åˆ†æè¿å•å·
if results:
    print(f"\nğŸ“Š æå–è¿å•å·:\n")
    
    tracking_codes = []
    for ship in results:
        code = ship.get('ship_code') or ship.get('code')
        if code and code.strip():
            tracking_codes.append(code)
    
    print(f"æ‰¾åˆ° {len(tracking_codes)} ä¸ªè¿å•å·:")
    for i, code in enumerate(list(set(tracking_codes))[:20], 1):
        print(f"  {i}. {code}")
    
    if tracking_codes:
        with open(f'tracking_codes_{start_id}_{end_id}.txt', 'w') as f:
            for code in set(tracking_codes):
                f.write(code + '\\n')
        print(f"\nğŸ’¾ è¿å•å·å·²ä¿å­˜")

print(f"\nâœ… è¶ŠæƒæˆåŠŸï¼è·å–åˆ° {success_count} ä¸ªè¿å•çš„å®Œæ•´ä¿¡æ¯ï¼")
